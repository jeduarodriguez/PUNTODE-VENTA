diff --git a/App.tsx b/App.tsx
index 2245c5d..2875ef3 100644
--- a/App.tsx
+++ b/App.tsx
@@ -1,3 +1,4 @@
+
 import React, { useState, useEffect, useCallback } from 'react';
 import Sidebar from './components/Sidebar';
 import POS from './components/POS';
@@ -5,130 +6,87 @@ import Inventory from './components/Inventory';
 import VentasCaja from './components/Reports';
 import Customers from './components/Customers';
 import Settings from './components/Settings';
-import { Product, Sale, View, Customer, ExchangeRateRecord, CartItem } from './types';
-import { INITIAL_PRODUCTS, INITIAL_CUSTOMERS, INITIAL_SALES, CheckCircle2, ShoppingCart, Package, Users, BarChart3, Settings as SettingsIcon, Cloud, CloudOff, AlertCircle, Globe, Smartphone, QrCode, AlertTriangle, Download, X, Calendar, TrendingUp, Banknote, Share, Plus } from './constants';
-import { syncPath, saveData, deleteData, updateBatch, isCloudEnabled } from './services/supabaseService';
+import RateModal from './components/RateModal';
+import Treasury from './components/Treasury';
+import Dashboard from './components/Dashboard';
+import { Product, Sale, View, Customer, ExchangeRateRecord, CartItem, TreasuryTransaction } from './types';
+import { INITIAL_PRODUCTS, INITIAL_CUSTOMERS, INITIAL_SALES, INITIAL_RATE_HISTORY, INITIAL_TREASURY, CheckCircle2, Settings as SettingsIcon, Smartphone, Share as ShareIcon, DollarSign, Plus, X, ShoppingCart, Package, Users, Banknote, Landmark, PieChart } from './constants';
+// Cambiamos el servicio a Supabase
+import { syncPath, saveData, deleteData, updateBatch } from './services/supabaseService';
 
 const App: React.FC = () => {
-  const [view, setView] = useState<View>('reports');
+  const [view, setView] = useState<View>('dashboard');
   const [products, setProducts] = useState<Product[]>([]);
   const [customers, setCustomers] = useState<Customer[]>([]);
   const [sales, setSales] = useState<Sale[]>([]);
+  const [treasuryTransactions, setTreasuryTransactions] = useState<TreasuryTransaction[]>([]);
   const [exchangeRate, setExchangeRate] = useState<number>(1);
   const [rateHistory, setRateHistory] = useState<ExchangeRateRecord[]>([]);
-  const [isSynced, setIsSynced] = useState(false);
+  const [categories, setCategories] = useState<string[]>(['Todas', 'Bebidas', 'Panader├¡a', 'Comida', 'Snacks']);
   const [notification, setNotification] = useState<{ message: string; type: 'success' | 'error' } | null>(null);
   const [installPrompt, setInstallPrompt] = useState<any>(null);
-  const [showPortBanner, setShowPortBanner] = useState(true);
 
-  // State for restoring cart when editing a sale
   const [pendingCart, setPendingCart] = useState<CartItem[]>([]);
-
-  // Estado para el modal r├ípido de tasa en el header
-  const [isRateModalOpen, setIsRateModalOpen] = useState(false);
-  const [tempRate, setTempRate] = useState('');
-
-  // iOS Install Instructions State
   const [showIosInstallModal, setShowIosInstallModal] = useState(false);
-  const [isIos, setIsIos] = useState(false);
-  const [isStandalone, setIsStandalone] = useState(false);
-
-  // Detecci├│n de entorno restringido
-  const isRestrictedEnv = typeof window !== 'undefined' &&
-    (window.location.hostname.includes('usercontent.goog') || window.location.hostname.includes('github.dev'));
+  const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
+  const [isRateModalOpen, setIsRateModalOpen] = useState(false);
 
   const handleCartLoaded = useCallback(() => {
     setPendingCart([]);
   }, []);
 
   useEffect(() => {
-    // Detect iOS and Standalone mode
     const userAgent = window.navigator.userAgent.toLowerCase();
     const isIosDevice = /iphone|ipad|ipod/.test(userAgent);
     const isApp = (window.navigator as any).standalone || window.matchMedia('(display-mode: standalone)').matches;
 
-    setIsIos(isIosDevice);
-    setIsStandalone(isApp);
+    if (isIosDevice && !isApp) {
+      const lastPrompt = localStorage.getItem('pointy_ios_prompt');
+      const now = Date.now();
+      if (!lastPrompt || now - parseInt(lastPrompt) > 86400000) {
+        setTimeout(() => setShowIosInstallModal(true), 3000);
+      }
+    }
 
-    // Escuchar evento para instalar PWA (Android/Chrome)
     const handleInstallPrompt = (e: any) => {
       e.preventDefault();
       setInstallPrompt(e);
     };
     window.addEventListener('beforeinstallprompt', handleInstallPrompt);
 
-    // Cargar Productos (Con Seed)
+    // --- SINCRONIZACI├ôN CON SUPABASE ---
     const unsubProducts = syncPath('products', (data) => {
-      if (data) {
-        setProducts(Object.values(data).filter(Boolean) as Product[]); // Filter nulls
-      } else {
-        const initialMap = INITIAL_PRODUCTS.reduce((acc, p) => ({ ...acc, [p.id]: p }), {});
-        saveData('products', initialMap);
-        setProducts(INITIAL_PRODUCTS);
-      }
-      setIsSynced(true);
+      setProducts(data ? Object.values(data).filter(Boolean) as Product[] : []);
     });
 
-    // Cargar Clientes (Con Seed)
     const unsubCustomers = syncPath('customers', (data) => {
-      if (data) {
-        setCustomers(Object.values(data).filter(Boolean) as Customer[]); // Filter nulls
-      } else {
-        const initialMap = INITIAL_CUSTOMERS.reduce((acc, c) => ({ ...acc, [c.id]: c }), {});
-        saveData('customers', initialMap);
-        setCustomers(INITIAL_CUSTOMERS);
-      }
+      setCustomers(data ? Object.values(data).filter(Boolean) as Customer[] : []);
     });
 
-    // Cargar Ventas (Con Seed)
     const unsubSales = syncPath('sales', (data) => {
-      if (data) {
-        setSales(Object.values(data).filter(Boolean) as Sale[]); // Filter nulls
-      } else {
-        // ACTUALIZAR FECHAS DE VENTAS INICIALES A "HOY" PARA DEMO
-        const now = Date.now();
-        const updatedSales = INITIAL_SALES.map((s, index) => ({
-          ...s,
-          timestamp: now - (index * 3600000) // Hace 0 horas, 1 hora, etc.
-        }));
-        const initialMap = updatedSales.reduce((acc, s) => ({ ...acc, [s.id]: s }), {});
-        saveData('sales', initialMap);
-        setSales(updatedSales);
-      }
+      setSales(data ? Object.values(data).filter(Boolean) as Sale[] : []);
     });
 
-    const unsubRate = syncPath('settings/exchangeRate', (data) => {
-      if (data) setExchangeRate(data);
-      else setExchangeRate(40);
+    const unsubTreasury = syncPath('treasury', (data) => {
+      setTreasuryTransactions(data ? Object.values(data).filter(Boolean) as TreasuryTransaction[] : []);
     });
 
-    // SEED BALANCES IF EMPTY (DEMO)
-    const unsubMercantil = syncPath('settings/mercantilBalance', (data) => {
-      if (data === null || data === undefined) {
-        saveData('settings/mercantilBalance', 15400.00); // Semilla de Banco
-      }
+    const unsubRate = syncPath('settings/exchangeRate', (data) => {
+      if (data) setExchangeRate(data);
+      else setExchangeRate(47.90);
     });
 
-    const unsubEfectivo = syncPath('settings/efectivoBalance', (data) => {
-      if (data === null || data === undefined) {
-        saveData('settings/efectivoBalance', 8200.00); // Semilla de Efectivo en B├│veda
-      }
+    const unsubHistory = syncPath('rate_history', (data) => {
+      setRateHistory(data ? Object.values(data).filter(Boolean) as ExchangeRateRecord[] : []);
     });
 
-    const unsubHistory = syncPath('settings/rateHistory', (data) => {
-      if (data) setRateHistory(Object.values(data).filter(Boolean) as ExchangeRateRecord[]);
-      else setRateHistory([]);
+    const unsubCategories = syncPath('settings/categories', (data) => {
+      if (data && Array.isArray(data)) setCategories(data);
     });
 
     return () => {
       window.removeEventListener('beforeinstallprompt', handleInstallPrompt);
-      unsubProducts();
-      unsubCustomers();
-      unsubSales();
-      unsubRate();
-      unsubHistory();
-      unsubMercantil();
-      unsubEfectivo();
+      unsubProducts(); unsubCustomers(); unsubSales(); unsubTreasury(); unsubRate(); unsubHistory(); unsubCategories();
     };
   }, []);
 
@@ -136,12 +94,15 @@ const App: React.FC = () => {
     if (!installPrompt) return;
     installPrompt.prompt();
     installPrompt.userChoice.then((choiceResult: any) => {
-      if (choiceResult.outcome === 'accepted') {
-        setInstallPrompt(null);
-      }
+      if (choiceResult.outcome === 'accepted') setInstallPrompt(null);
     });
   };
 
+  const closeIosPrompt = () => {
+    setShowIosInstallModal(false);
+    localStorage.setItem('pointy_ios_prompt', Date.now().toString());
+  };
+
   const showNotification = (message: string, type: 'success' | 'error' = 'success') => {
     setNotification({ message, type });
     setTimeout(() => setNotification(null), 3000);
@@ -151,110 +112,96 @@ const App: React.FC = () => {
     const updates: any = {};
     const saleWithRate = { ...sale, exchangeRate };
 
-    // 1. Actualizar Stock
+    // Preparar actualizaciones de stock
+    const updatedProducts = [...products];
     sale.items.forEach(item => {
-      const product = products.find(p => p.id === item.id);
-      if (product) {
-        const newStock = Math.max(0, product.stock - item.quantity);
-        const updatedProduct = { ...product, stock: newStock };
-        updates[`products/${product.id}`] = updatedProduct;
+      const pIndex = updatedProducts.findIndex(prod => prod.id === item.id);
+      if (pIndex !== -1) {
+        const p = { ...updatedProducts[pIndex], stock: Math.max(0, updatedProducts[pIndex].stock - item.quantity) };
+        updatedProducts[pIndex] = p;
+        updates[`products/${p.id}`] = p;
       }
     });
 
-    // 2. Si es Cr├®dito, Actualizar Balance del Cliente
+    // Preparar actualizaci├│n de cliente (si es cr├®dito)
+    const updatedCustomers = [...customers];
     if (sale.paymentMethod === 'Credit' && sale.customerId) {
-      const customer = customers.find(c => c.id === sale.customerId);
-      if (customer) {
-        const currentBalance = customer.balance || 0;
-        const updatedCustomer = { ...customer, balance: currentBalance + sale.total };
-        updates[`customers/${sale.customerId}`] = updatedCustomer;
+      const cIndex = updatedCustomers.findIndex(cust => cust.id === sale.customerId);
+      if (cIndex !== -1) {
+        const c = { ...updatedCustomers[cIndex], balance: (updatedCustomers[cIndex].balance || 0) + sale.total };
+        updatedCustomers[cIndex] = c;
+        updates[`customers/${c.id}`] = c;
       }
     }
 
-    // 3. Guardar la Venta
     updates[`sales/${sale.id}`] = saleWithRate;
 
+    // --- ACTUALIZACI├ôN OPTIMISTA ---
+    setProducts(updatedProducts);
+    setCustomers(updatedCustomers);
+    setSales(prev => [...prev, saleWithRate]);
+    setView('reports');
+
     try {
       await updateBatch(updates);
       showNotification(`Venta guardada: $${sale.total.toFixed(2)}`);
-      setView('reports'); // Return to dashboard after sale
     } catch (error) {
-      showNotification('Error al guardar la venta', 'error');
+      showNotification('Error al guardar', 'error');
+      // Podr├¡amos revertir el estado aqu├¡ si fuera cr├¡tico, 
+      // pero usualmente la reconexi├│n de Supabase lo arreglar├í.
     }
   };
 
   const handleVoidSale = async (saleId: string) => {
-    const saleToVoid = sales.find(s => s.id === saleId);
-    if (!saleToVoid) {
-      showNotification('Venta no encontrada', 'error');
-      return;
-    }
-
+    const sale = sales.find(s => s.id === saleId);
+    if (!sale) return;
     const updates: any = {};
 
-    // 1. Restaurar Stock
-    saleToVoid.items.forEach(item => {
-      if (item.id === 'debt_payment') return; // Skip debt payments
-      const product = products.find(p => p.id === item.id);
-      if (product) {
-        const restoredStock = product.stock + item.quantity;
-        const updatedProduct = { ...product, stock: restoredStock };
-        updates[`products/${product.id}`] = updatedProduct;
+    // Revertir stock
+    const updatedProducts = [...products];
+    sale.items.forEach(item => {
+      if (item.id === 'debt_payment') return;
+      const pIndex = updatedProducts.findIndex(prod => prod.id === item.id);
+      if (pIndex !== -1) {
+        const p = { ...updatedProducts[pIndex], stock: updatedProducts[pIndex].stock + item.quantity };
+        updatedProducts[pIndex] = p;
+        updates[`products/${p.id}`] = p;
       }
     });
 
-    // 2. Si fue Cr├®dito, Restaurar Balance del Cliente (Restar la deuda)
-    if (saleToVoid.paymentMethod === 'Credit' && saleToVoid.customerId) {
-      const customer = customers.find(c => c.id === saleToVoid.customerId);
-      if (customer) {
-        const newBalance = Math.max(0, customer.balance - saleToVoid.total);
-        const updatedCustomer = { ...customer, balance: newBalance };
-        updates[`customers/${saleToVoid.customerId}`] = updatedCustomer;
-      }
-    }
-
-    // 3. Si fue un PAGO de deuda, Restaurar la deuda (Sumar la deuda)
-    if (saleToVoid.items.length === 1 && saleToVoid.items[0].id === 'debt_payment' && saleToVoid.customerId) {
-      const customer = customers.find(c => c.id === saleToVoid.customerId);
-      if (customer) {
-        const newBalance = customer.balance + saleToVoid.total;
-        const updatedCustomer = { ...customer, balance: newBalance };
-        updates[`customers/${saleToVoid.customerId}`] = updatedCustomer;
+    // Revertir saldo de cliente
+    const updatedCustomers = [...customers];
+    if (sale.paymentMethod === 'Credit' && sale.customerId) {
+      const cIndex = updatedCustomers.findIndex(cust => cust.id === sale.customerId);
+      if (cIndex !== -1) {
+        const c = { ...updatedCustomers[cIndex], balance: Math.max(0, (updatedCustomers[cIndex].balance || 0) - sale.total) };
+        updatedCustomers[cIndex] = c;
+        updates[`customers/${c.id}`] = c;
       }
     }
 
-    // 4. Eliminar la venta (null removes it)
     updates[`sales/${saleId}`] = null;
 
+    // --- ACTUALIZACI├ôN OPTIMISTA ---
+    setProducts(updatedProducts);
+    setCustomers(updatedCustomers);
+    setSales(prev => prev.filter(s => s.id !== saleId));
+
     try {
       await updateBatch(updates);
-      // Actualizar estado local inmediatamente para evitar lag
-      setSales(prev => prev.filter(s => s.id !== saleId));
-      showNotification('Venta anulada correctamente');
+      showNotification('Venta anulada');
     } catch (error) {
-      showNotification('Error al anular venta', 'error');
-      console.error(error);
+      showNotification('Error', 'error');
     }
   };
 
   const handleEditSale = async (sale: Sale) => {
-    // 1. Cargar los items en el carrito pendiente (Deep Clone)
-    const itemsToRestore = sale.items
-      .filter(i => i.id !== 'debt_payment')
-      .map(i => ({ ...i }));
-
+    const itemsToRestore = sale.items.filter(i => i.id !== 'debt_payment').map(i => ({ ...i }));
     if (itemsToRestore.length > 0) {
-      // Establecer carrito ANTES de anular para asegurar la transici├│n de datos
       setPendingCart(itemsToRestore);
-
-      // 2. Anular la venta original (Devolver stock y dinero)
       await handleVoidSale(sale.id);
-
-      // 3. Ir al POS
       setView('pos');
-      showNotification('Venta cargada para correcci├│n', 'success');
-    } else {
-      showNotification('No se pueden editar pagos de deuda', 'error');
+      showNotification('Cargado para correcci├│n');
     }
   };
 
@@ -262,335 +209,367 @@ const App: React.FC = () => {
     const paymentSale: Sale = {
       id: Math.random().toString(36).substr(2, 9),
       timestamp: Date.now(),
-      items: [{
-        id: 'debt_payment',
-        name: 'Abono de Deuda / Pago Total',
-        category: 'Pagos',
-        price: amount,
-        costPrice: 0,
-        stock: 1,
-        quantity: 1
-      }],
+      items: [{ id: 'debt_payment', name: 'Abono de Deuda', category: 'Pagos', price: amount, costPrice: 0, stock: 1, quantity: 1 }],
       total: amount,
-      exchangeRate: exchangeRate,
+      exchangeRate,
       paymentMethod: method,
-      customerId: customerId
+      customerId
     };
 
     const updates: any = {};
     updates[`sales/${paymentSale.id}`] = paymentSale;
 
-    const customer = customers.find(c => c.id === customerId);
-    if (customer) {
-      const newBalance = Math.max(0, customer.balance - amount);
-      const updatedCustomer = { ...customer, balance: newBalance };
-      updates[`customers/${customerId}`] = updatedCustomer;
+    // Actualizar saldo de cliente
+    const updatedCustomers = [...customers];
+    const cIndex = updatedCustomers.findIndex(cust => cust.id === customerId);
+    if (cIndex !== -1) {
+      const c = { ...updatedCustomers[cIndex], balance: Math.max(0, (updatedCustomers[cIndex].balance || 0) - amount) };
+      updatedCustomers[cIndex] = c;
+      updates[`customers/${customerId}`] = c;
     }
 
+    // --- ACTUALIZACI├ôN OPTIMISTA ---
+    setCustomers(updatedCustomers);
+    setSales(prev => [...prev, paymentSale]);
+
     try {
       await updateBatch(updates);
-      showNotification(`Pago registrado (${method}): $${amount.toFixed(2)}`);
-    } catch (error) {
-      showNotification('Error al registrar el pago', 'error');
+      showNotification(`Pago registrado: $${amount.toFixed(2)}`);
+    } catch (e) {
+      showNotification('Error', 'error');
     }
   };
 
-  const handleExchangeRateChange = (rate: number) => {
-    saveData('settings/exchangeRate', rate);
-    const newRecord: ExchangeRateRecord = {
-      id: Date.now().toString(),
-      rate: rate,
-      timestamp: Date.now()
-    };
-    saveData(`settings/rateHistory/${newRecord.id}`, newRecord);
-    showNotification(`Tasa actualizada: ${rate} Bs.`);
+  const handleRestock = async (transaction: TreasuryTransaction, items: { productId: string, quantity: number, cost: number, newPrice?: number }[]) => {
+    const updates: any = {};
+    const updatedProducts = [...products];
+
+    updates[`treasury/${transaction.id}`] = transaction;
+
+    items.forEach(item => {
+      const pIndex = updatedProducts.findIndex(p => p.id === item.productId);
+      if (pIndex !== -1) {
+        const product = updatedProducts[pIndex];
+        const newProduct = { ...product };
+        newProduct.stock = product.stock + item.quantity;
+        if (item.cost > 0) newProduct.costPrice = item.cost;
+        if (item.newPrice && item.newPrice > 0) newProduct.price = item.newPrice;
+        updatedProducts[pIndex] = newProduct;
+        updates[`products/${product.id}`] = newProduct;
+      }
+    });
+
+    // --- ACTUALIZACI├ôN OPTIMISTA ---
+    setTreasuryTransactions(prev => [...prev, transaction]);
+    setProducts(updatedProducts);
+
+    try {
+      await updateBatch(updates);
+      showNotification(`Compra registrada: $${transaction.amount.toFixed(2)}`);
+    } catch (e) {
+      showNotification('Error al registrar compra', 'error');
+    }
+  };
+
+  const handleAddTreasuryTransaction = async (t: TreasuryTransaction) => {
+    // Actualizaci├│n optimista
+    setTreasuryTransactions(prev => [...prev, t]);
+    await saveData(`treasury/${t.id}`, t);
+  };
+
+  const handleDeleteTreasuryTransaction = async (id: string) => {
+    // Actualizaci├│n optimista
+    setTreasuryTransactions(prev => prev.filter(t => t.id !== id));
+    await deleteData(`treasury/${id}`);
+  };
+
+  const handleUpdateExchangeRate = async (rate: number) => {
+    // Actualizaci├│n optimista: actualizar el estado local inmediatamente
+    setExchangeRate(rate);
+    // Guardar en Supabase
+    await saveData('settings/exchangeRate', rate);
+  };
+
+  const handleUpdateRateHistory = async (record: ExchangeRateRecord) => {
+    // Actualizaci├│n optimista: actualizar el estado local inmediatamente
+    setRateHistory(prev => {
+      const exists = prev.find(r => r.id === record.id);
+      if (exists) {
+        // Actualizar registro existente
+        return prev.map(r => r.id === record.id ? record : r);
+      } else {
+        // Agregar nuevo registro
+        return [...prev, record];
+      }
+    });
+    // Guardar en Supabase
+    await saveData(`rate_history/${record.id}`, record);
+  };
+
+  const handleDeleteRateHistory = async (id: string) => {
+    // Actualizaci├│n optimista: eliminar del estado local inmediatamente
+    setRateHistory(prev => prev.filter(r => r.id !== id));
+    // Eliminar de Supabase
+    await deleteData(`rate_history/${id}`);
   };
 
-  const handleQuickRateSubmit = (e: React.FormEvent) => {
-    e.preventDefault();
-    const rate = parseFloat(tempRate);
-    if (rate > 0) {
-      handleExchangeRateChange(rate);
-      setIsRateModalOpen(false);
+  // --- PRODUCTOS OPTIMISTAS ---
+  const handleProductAdd = async (p: Product) => {
+    setProducts(prev => [...prev, p]);
+    const success = await saveData(`products/${p.id}`, p);
+    if (success) showNotification('Producto agregado a la nube');
+    else showNotification('Error al guardar en la nube (Verifica conexi├│n)', 'error');
+  };
+
+  const handleProductUpdate = async (p: Product) => {
+    const oldProducts = [...products];
+    setProducts(prev => prev.map(prod => prod.id === p.id ? p : prod));
+    const success = await saveData(`products/${p.id}`, p);
+    if (success) showNotification('Producto actualizado');
+    else {
+      showNotification('Error al actualizar en la nube', 'error');
+      setProducts(oldProducts); // Revertir si falla
     }
   };
 
-  const handleHistoryUpdate = (record: ExchangeRateRecord) => {
-    saveData(`settings/rateHistory/${record.id}`, record);
-    showNotification("Registro hist├│rico actualizado");
+  const handleProductDelete = async (id: string) => {
+    if (!confirm('┬┐Seguro que deseas eliminar este producto?')) return;
+    const oldProducts = [...products];
+    setProducts(prev => prev.filter(p => p.id !== id));
+    try {
+      await deleteData(`products/${id}`);
+      showNotification('Producto eliminado');
+    } catch (e) {
+      showNotification('Error al eliminar producto', 'error');
+      setProducts(oldProducts);
+    }
   };
 
-  const handleHistoryDelete = (id: string) => {
-    deleteData(`settings/rateHistory/${id}`);
-    showNotification("Registro eliminado");
+  // --- CLIENTES OPTIMISTAS ---
+  const handleCustomerAdd = async (c: Customer) => {
+    setCustomers(prev => [...prev, c]);
+    const success = await saveData(`customers/${c.id}`, c);
+    if (success) showNotification('Cliente guardado');
+    else showNotification('Error al guardar cliente', 'error');
   };
 
-  const addProduct = (product: Product) => saveData(`products/${product.id}`, product);
-  const updateProduct = (product: Product) => saveData(`products/${product.id}`, product);
-  const deleteProduct = (id: string) => deleteData(`products/${id}`);
-  const addCustomer = (customer: Customer) => saveData(`customers/${customer.id}`, customer);
-  const updateCustomer = (customer: Customer) => saveData(`customers/${customer.id}`, customer);
-  const deleteCustomer = (id: string) => deleteData(`customers/${id}`);
+  const handleCustomerUpdate = async (c: Customer) => {
+    setCustomers(prev => prev.map(cust => cust.id === c.id ? c : cust));
+    const success = await saveData(`customers/${c.id}`, c);
+    if (success) showNotification('Cliente actualizado');
+    else showNotification('Error al actualizar cliente', 'error');
+  };
 
-  const handleImport = (data: any) => {
-    const updates: any = {};
-    if (data.products) Object.values(data.products).forEach((p: any) => updates[`products/${p.id}`] = p);
-    if (data.customers) Object.values(data.customers).forEach((c: any) => updates[`customers/${c.id}`] = c);
-    if (data.sales) Object.values(data.sales).forEach((s: any) => updates[`sales/${s.id}`] = s);
-    updateBatch(updates);
-    showNotification("Datos importados con ├®xito");
+  const handleCustomerDelete = async (id: string) => {
+    if (!confirm('┬┐Eliminar este cliente?')) return;
+    setCustomers(prev => prev.filter(c => c.id !== id));
+    await deleteData(`customers/${id}`);
+    showNotification('Cliente eliminado');
   };
 
-  const today = new Date().toLocaleDateString('es-ES');
-  const sortedHistory = [...rateHistory].sort((a, b) => b.timestamp - a.timestamp);
-  const lastRecord = sortedHistory[0];
-  const lastRecordDate = lastRecord ? new Date(lastRecord.timestamp).toLocaleDateString('es-ES') : '';
-  const isRateOutdated = lastRecordDate !== today;
+  const handleAddCategory = async (cat: string) => {
+    if (!categories.includes(cat)) {
+      const newCats = [...categories, cat];
+      setCategories(newCats);
+      await saveData('settings/categories', newCats);
+    }
+  };
 
   return (
-    <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row pb-20 md:pb-0">
+    <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row pb-0 md:pb-0 safe-area-top">
       <Sidebar activeView={view} onViewChange={setView} />
+      <main className="flex-1 md:ml-64 relative flex flex-col h-[100dvh] overflow-hidden">
 
-      <main className="flex-1 md:ml-64 relative flex flex-col h-screen overflow-hidden">
-        {isRestrictedEnv && showPortBanner && (
-          <div className="bg-orange-600 text-white px-4 py-2 text-[10px] md:text-xs font-bold flex items-center justify-between animate-pulse shadow-md relative z-50">
-            <div className="flex items-center gap-2 mx-auto">
-              <AlertTriangle className="w-4 h-4" />
-              <span>PARA ACCESO M├ôVIL: Ve a "Ports" y cambia el puerto 3000 a "Public".</span>
+        {installPrompt && (
+          <div className="bg-indigo-600 text-white p-3 flex items-center justify-between animate-fade-in z-50">
+            <div className="flex items-center gap-3">
+              <Smartphone className="w-5 h-5" />
+              <p className="text-xs font-black uppercase">Instala Pointy en tu pantalla</p>
+            </div>
+            <div className="flex gap-2">
+              <button onClick={() => setInstallPrompt(null)} className="px-3 py-1.5 text-xs font-bold bg-white/10 rounded-lg">Cerrar</button>
+              <button onClick={handleInstallClick} className="px-4 py-1.5 text-xs font-black bg-white text-indigo-600 rounded-lg shadow-sm">Instalar</button>
             </div>
-            <button onClick={() => setShowPortBanner(false)} className="bg-black/20 p-1 rounded hover:bg-black/40"><X className="w-3 h-3" /></button>
           </div>
         )}
 
-        <div className="flex-1 overflow-y-auto p-4 md:p-8">
-          {view !== 'pos' && (
-            <div className="flex items-center justify-between mb-8">
-              <div className="flex flex-col">
-                <h1 className="text-3xl font-black text-gray-900 md:hidden">Pointy</h1>
-                <span className="text-indigo-600 font-black text-xs uppercase tracking-widest md:hidden">POS INTELIGENTE</span>
-              </div>
-
-              <div className="flex items-center gap-2 md:gap-3">
-                {/* Install Button for Android/Chrome */}
-                {installPrompt && (
-                  <button
-                    onClick={handleInstallClick}
-                    className="flex items-center gap-2 px-4 py-2.5 bg-gray-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-gray-200 active:scale-95 transition-all animate-bounce-subtle"
-                  >
-                    <Download className="w-4 h-4" />
-                    <span className="hidden sm:inline">Instalar</span>
-                    <span className="sm:hidden">App</span>
-                  </button>
-                )}
-
-                {/* Install Instruction Button for iOS */}
-                {isIos && !isStandalone && (
-                  <button
-                    onClick={() => setShowIosInstallModal(true)}
-                    className="flex items-center gap-2 px-4 py-2.5 bg-gray-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-gray-200 active:scale-95 transition-all animate-bounce-subtle"
-                  >
-                    <Download className="w-4 h-4" />
-                    <span className="hidden sm:inline">Instalar</span>
-                    <span className="sm:hidden">App</span>
-                  </button>
-                )}
-
-                {/* Quick Rate Button */}
-                <button
-                  onClick={() => { setIsRateModalOpen(true); setTempRate(exchangeRate.toString()); }}
-                  className={`flex items-center gap-2 px-4 py-2.5 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all border ${isRateOutdated ? 'bg-red-50 text-red-500 border-red-100 animate-pulse' : 'bg-white text-indigo-600 border-indigo-50 shadow-sm'}`}
-                >
-                  <TrendingUp className="w-4 h-4" />
-                  <span>{exchangeRate.toFixed(2)} Bs</span>
-                </button>
-
-                {/* Cloud Status */}
-                <div className={`flex items-center gap-2 px-4 py-2.5 rounded-2xl font-black text-[10px] uppercase tracking-widest border transition-all ${isSynced ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-gray-100 text-gray-400 border-gray-200'}`}>
-                  {isSynced ? <Cloud className="w-4 h-4" /> : <CloudOff className="w-4 h-4" />}
-                  <span className="hidden sm:inline">{isSynced ? 'Online' : 'Offline'}</span>
-                </div>
-              </div>
+        <div className={`flex-1 overflow-y-auto p-4 md:p-8 ${view === 'pos' ? 'pb-0' : 'pb-24 md:pb-8'}`}>
+          {/* Header removed on mobile to maximize space, kept only for larger screens or hidden if preferred */}
+          <div className="hidden md:flex items-center justify-between mb-8 sticky top-0 z-30 pt-2 pb-2 bg-gray-50/95 backdrop-blur-sm">
+            <div className="flex flex-col">
+              <h1 className="text-3xl font-black text-gray-900">Pointy</h1>
+              <span className="text-indigo-600 font-black text-xs uppercase">POS CLOUD</span>
             </div>
-          )}
-
-          {/* Views */}
-          {view === 'reports' && (
-            <VentasCaja
-              sales={sales}
-              customers={customers}
-              exchangeRate={exchangeRate}
-              onOpenPOS={() => setView('pos')}
-              onVoidSale={handleVoidSale}
-              onEditSale={handleEditSale}
-            />
-          )}
-
-          {view === 'inventory' && (
-            <Inventory
-              products={products}
-              onAdd={addProduct}
-              onUpdate={updateProduct}
-              onDelete={deleteProduct}
-            />
-          )}
-
-          {view === 'customers' && (
-            <Customers
-              customers={customers}
-              sales={sales}
-              exchangeRate={exchangeRate}
-              onAdd={addCustomer}
-              onUpdate={updateCustomer}
-              onDelete={deleteCustomer}
-              onDebtPayment={handleDebtPayment}
-            />
-          )}
-
-          {view === 'settings' && (
-            <Settings
-              products={products}
-              customers={customers}
-              sales={sales}
-              exchangeRate={exchangeRate}
-              rateHistory={rateHistory}
-              onExchangeRateChange={handleExchangeRateChange}
-              onHistoryUpdate={handleHistoryUpdate}
-              onHistoryDelete={handleHistoryDelete}
-              onImport={handleImport}
-              onReset={() => {
-                if (confirm("┬┐Borrar TODOS los datos?")) {
-                  localStorage.clear();
-                  window.location.reload();
-                }
-              }}
-            />
-          )}
-        </div>
-
-        {/* POS View - Full Height Overlay Style */}
-        {view === 'pos' && (
-          <div className="absolute inset-0 bg-gray-50 z-20 flex flex-col">
-            <POS
-              products={products}
-              customers={customers}
-              exchangeRate={exchangeRate}
-              onSale={handleSale}
-              onUpdateRate={handleExchangeRateChange}
-              onAddCustomer={addCustomer}
-              onBackToDashboard={() => setView('reports')}
-              initialCart={pendingCart}
-              onCartLoaded={handleCartLoaded}
-            />
-          </div>
-        )}
+            <div className="flex items-center gap-2">
+              <button
+                onClick={() => setIsRateModalOpen(true)}
+                className="flex items-center gap-2 px-4 py-3 rounded-2xl font-black text-xs uppercase bg-white text-indigo-600 border border-indigo-50 shadow-sm active:scale-95 transition-all"
+              >
+                <div className="bg-indigo-100 p-1 rounded-full"><DollarSign className="w-3 h-3" /></div>
+                <span>{exchangeRate.toFixed(2)} Bs</span>
+              </button>
 
-        {/* Quick Rate Modal */}
-        {isRateModalOpen && (
-          <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
-            <div className="bg-white p-6 rounded-[2rem] shadow-2xl w-full max-w-xs animate-scale-up">
-              <h3 className="text-lg font-black text-gray-900 mb-1 text-center">Tasa del D├¡a</h3>
-              <p className="text-xs text-gray-400 text-center mb-4 font-bold uppercase tracking-widest">Actualizar valor BCV</p>
-              <form onSubmit={handleQuickRateSubmit}>
-                <div className="relative mb-4">
-                  <span className="absolute left-4 top-1/2 -translate-y-1/2 font-black text-gray-300">Bs.</span>
-                  <input
-                    autoFocus
-                    type="number"
-                    step="0.01"
-                    className="w-full pl-10 pr-4 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-black text-xl text-center outline-none focus:border-indigo-500"
-                    value={tempRate}
-                    onChange={(e) => setTempRate(e.target.value)}
-                  />
-                </div>
-                <div className="flex gap-2">
-                  <button type="button" onClick={() => setIsRateModalOpen(false)} className="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-xs">Cancelar</button>
-                  <button type="submit" className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs shadow-lg">Guardar</button>
-                </div>
-              </form>
+              <button
+                onClick={() => setIsSettingsModalOpen(true)}
+                className="p-3 bg-white text-gray-600 border border-gray-200 rounded-2xl shadow-sm hover:bg-gray-100 active:scale-95 transition-all"
+              >
+                <SettingsIcon className="w-5 h-5" />
+              </button>
             </div>
           </div>
-        )}
 
-        {/* iOS Install Instructions Modal */}
-        {showIosInstallModal && (
-          <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setShowIosInstallModal(false)}>
-            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl text-center relative" onClick={e => e.stopPropagation()}>
-              <button onClick={() => setShowIosInstallModal(false)} className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-500 hover:bg-gray-200">
-                <X className="w-5 h-5" />
-              </button>
+          {view === 'dashboard' && <Dashboard sales={sales} products={products} customers={customers} exchangeRate={exchangeRate} />}
+          {view === 'reports' && <VentasCaja sales={sales} customers={customers} exchangeRate={exchangeRate} treasuryTransactions={treasuryTransactions} onOpenPOS={() => setView('pos')} onVoidSale={handleVoidSale} onEditSale={handleEditSale} onAddTreasuryTransaction={handleAddTreasuryTransaction} onOpenRateModal={() => setIsRateModalOpen(true)} />}
+          {view === 'inventory' && <Inventory products={products} exchangeRate={exchangeRate} categories={categories} onAdd={handleProductAdd} onUpdate={handleProductUpdate} onDelete={handleProductDelete} onAddCategory={handleAddCategory} />}
+          {view === 'customers' && <Customers customers={customers} sales={sales} exchangeRate={exchangeRate} onAdd={handleCustomerAdd} onUpdate={handleCustomerUpdate} onDelete={handleCustomerDelete} onDebtPayment={handleDebtPayment} />}
+          {view === 'treasury' && <Treasury transactions={treasuryTransactions} sales={sales} products={products} customers={customers} exchangeRate={exchangeRate} rateHistory={rateHistory} onAddTransaction={handleAddTreasuryTransaction} onDeleteTransaction={handleDeleteTreasuryTransaction} onRestock={handleRestock} />}
+          {view === 'settings' && <div className="p-4 bg-white rounded-3xl shadow-sm border border-gray-100">Panel de Configuraci├│n Integrado</div>}
+        </div>
 
-              <Smartphone className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
-              <h3 className="text-xl font-black text-gray-900 mb-2">Instalar en iPhone</h3>
-              <p className="text-sm text-gray-500 mb-6">Para instalar Pointy en tu inicio, sigue estos pasos:</p>
+        {view === 'pos' && <div className="absolute inset-0 bg-gray-50 z-20"><POS products={products} customers={customers} exchangeRate={exchangeRate} onSale={handleSale} onUpdateRate={handleUpdateExchangeRate} onAddCustomer={handleCustomerAdd} onBackToDashboard={() => setView('reports')} initialCart={pendingCart} onCartLoaded={handleCartLoaded} /></div>}
+
+        <RateModal
+          isOpen={isRateModalOpen}
+          onClose={() => setIsRateModalOpen(false)}
+          currentRate={exchangeRate}
+          rateHistory={rateHistory}
+          onUpdateRate={handleUpdateExchangeRate}
+          onHistoryUpdate={handleUpdateRateHistory}
+          onHistoryDelete={handleDeleteRateHistory}
+        />
+
+        <Settings
+          isOpen={isSettingsModalOpen}
+          onClose={() => setIsSettingsModalOpen(false)}
+          products={products}
+          customers={customers}
+          sales={sales}
+          onImport={() => { }}
+          onReset={() => {
+            if (confirm('┬┐Borrar TODOS los datos de la aplicaci├│n?')) {
+              localStorage.clear();
+              window.location.reload();
+            }
+          }}
+          autoSync={false}
+          onToggleAutoSync={() => { }}
+          installApp={installPrompt ? handleInstallClick : undefined}
+        />
+
+        {notification && <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-up bg-gray-900 text-white`}><CheckCircle2 className="w-5 h-5 text-emerald-400" /><span className="font-bold text-sm">{notification.message}</span></div>}
 
-              <div className="space-y-4 text-left">
-                <div className="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
-                  <Share className="w-6 h-6 text-blue-500 shrink-0" />
-                  <span className="text-sm font-bold text-gray-700">1. Toca el bot├│n <span className="text-blue-500">Compartir</span> en la barra inferior de Safari.</span>
+        {showIosInstallModal && (
+          <div className="fixed inset-x-0 bottom-0 z-[110] p-4 flex justify-center animate-slide-up">
+            <div className="bg-white rounded-[2rem] shadow-2xl p-6 border border-gray-100 w-full max-w-sm">
+              <div className="flex justify-between items-start mb-4">
+                <div className="flex items-center gap-3">
+                  <div className="bg-indigo-100 p-2 rounded-xl text-indigo-600">
+                    <Plus className="w-6 h-6" />
+                  </div>
+                  <div>
+                    <h3 className="text-sm font-black text-gray-900 uppercase">Instalar App</h3>
+                    <p className="text-[10px] text-gray-400 font-bold uppercase">Sigue estos pasos en tu iPhone</p>
+                  </div>
+                </div>
+                <button onClick={closeIosPrompt} className="text-gray-400 p-1"><X className="w-5 h-5" /></button>
+              </div>
+              <div className="space-y-4">
+                <div className="flex items-center gap-3 bg-gray-50 p-3 rounded-2xl">
+                  <div className="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm font-black text-indigo-600">1</div>
+                  <p className="text-xs font-bold text-gray-600">Toca el bot├│n <span className="inline-flex bg-white p-1 rounded border shadow-sm mx-1"><ShareIcon className="w-3 h-3 text-blue-500" /></span> de Safari.</p>
                 </div>
-                <div className="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
-                  <Plus className="w-6 h-6 text-gray-900 shrink-0 border-2 border-gray-900 rounded-md p-0.5" />
-                  <span className="text-sm font-bold text-gray-700">2. Selecciona <span className="text-gray-900">"Agregar a Inicio"</span> en la lista de opciones.</span>
+                <div className="flex items-center gap-3 bg-gray-50 p-3 rounded-2xl">
+                  <div className="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm font-black text-indigo-600">2</div>
+                  <p className="text-xs font-bold text-gray-600">Selecciona <span className="font-black text-gray-900 uppercase text-[10px]">"A├▒adir a pantalla de inicio"</span>.</p>
                 </div>
               </div>
-
-              <button onClick={() => setShowIosInstallModal(false)} className="mt-8 w-full py-3 bg-indigo-600 text-white rounded-xl font-black uppercase tracking-widest text-xs">
-                Entendido
-              </button>
+              <button onClick={closeIosPrompt} className="w-full mt-4 py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-all">Entendido</button>
             </div>
           </div>
         )}
-
-        {/* Notifications Toast */}
-        {notification && (
-          <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 md:left-auto md:right-6 md:translate-x-0 z-[100] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-up ${notification.type === 'success' ? 'bg-gray-900 text-white' : 'bg-red-500 text-white'}`}>
-            {notification.type === 'success' ? <CheckCircle2 className="w-5 h-5 text-emerald-400" /> : <AlertCircle className="w-5 h-5 text-white" />}
-            <span className="font-bold text-sm">{notification.message}</span>
-          </div>
-        )}
       </main>
 
-      {/* MOBILE NAVIGATION BAR */}
-      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-2 pb-safe md:hidden z-30 flex justify-around items-center">
-        <button
-          onClick={() => setView('reports')}
-          className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${view === 'reports' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
-        >
-          <Banknote className="w-5 h-5" />
-          <span className="text-[9px] font-black uppercase">Caja</span>
-        </button>
-
-        <button
-          onClick={() => setView('inventory')}
-          className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${view === 'inventory' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
-        >
-          <Package className="w-5 h-5" />
-          <span className="text-[9px] font-black uppercase">Inventario</span>
-        </button>
-
-        <button
-          onClick={() => setView('customers')}
-          className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${view === 'customers' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
-        >
-          <Users className="w-5 h-5" />
-          <span className="text-[9px] font-black uppercase">Clientes</span>
-        </button>
-
-        <button
-          onClick={() => setView('settings')}
-          className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${view === 'settings' ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:bg-gray-50'}`}
-        >
-          <SettingsIcon className="w-5 h-5" />
-          <span className="text-[9px] font-black uppercase">Ajustes</span>
-        </button>
-      </div>
+      {/* Barra de navegaci├│n inferior para m├│viles */}
+      {view !== 'pos' && (
+        <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-200 md:hidden z-50 safe-area-bottom">
+          <div className="flex items-center justify-around px-2 py-2">
+            {/* Dashboard (Resumen) */}
+            <button
+              onClick={() => setView('dashboard')}
+              className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${view === 'dashboard'
+                ? 'text-indigo-600 bg-indigo-50'
+                : 'text-gray-500'
+                }`}
+            >
+              <PieChart className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Resumen</span>
+            </button>
+
+            {/* Ventas (Caja) */}
+            <button
+              onClick={() => setView('reports')}
+              className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${view === 'reports'
+                ? 'text-indigo-600 bg-indigo-50'
+                : 'text-gray-500'
+                }`}
+            >
+              <Banknote className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Ventas</span>
+            </button>
+
+            {/* Inventario */}
+            <button
+              onClick={() => setView('inventory')}
+              className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${view === 'inventory'
+                ? 'text-indigo-600 bg-indigo-50'
+                : 'text-gray-500'
+                }`}
+            >
+              <Package className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Stock</span>
+            </button>
+
+            {/* Clientes */}
+            <button
+              onClick={() => setView('customers')}
+              className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${view === 'customers'
+                ? 'text-indigo-600 bg-indigo-50'
+                : 'text-gray-500'
+                }`}
+            >
+              <Users className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Clientes</span>
+            </button>
+
+            {/* Balance / Tasa (Combinado) */}
+            <button
+              onClick={() => setView('treasury')}
+              className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${view === 'treasury'
+                ? 'text-indigo-600 bg-indigo-50'
+                : 'text-gray-500'
+                }`}
+            >
+              <Landmark className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Balance</span>
+            </button>
+
+            {/* Ajustes */}
+            <button
+              onClick={() => setIsSettingsModalOpen(true)}
+              className="flex flex-col items-center gap-1 px-3 py-2 rounded-xl text-gray-500 transition-all active:bg-indigo-50"
+            >
+              <SettingsIcon className="w-5 h-5" />
+              <span className="text-[10px] font-bold">Ajustes</span>
+            </button>
+          </div>
+        </div>
+      )}
 
       <style>{`
-        @keyframes bounce-subtle {
-          0%, 100% { transform: translateY(0); }
-          50% { transform: translateY(-3px); }
-        }
-        .animate-bounce-subtle { animation: bounce-subtle 2s infinite; }
+        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
+        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
+        .animate-fade-in { animation: fade-in 0.3s ease-out; }
+        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
       `}</style>
     </div>
   );
diff --git a/README.md b/README.md
index 9443413..09ba813 100644
--- a/README.md
+++ b/README.md
@@ -1,20 +1,37 @@
-<div align="center">
-<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
-</div>
+# Pointy - Sistema de Punto de Venta
 
-# Run and deploy your AI Studio app
+Este proyecto es un sistema de punto de venta (POS) moderno migrado de Firebase a **Supabase**.
 
-This contains everything you need to run your app locally.
+## Requisitos Previos
 
-View your app in AI Studio: https://ai.studio/apps/drive/17jP0om6aticQeK0Y7aOcBwDU7iEO6gW-
+- **Node.js**: Aseg├║rate de tener instalado Node.js (v18 o superior).
 
-## Run Locally
+## Configuraci├│n Local
 
-**Prerequisites:**  Node.js
+1. **Instalar dependencias**:
+   ```bash
+   npm install
+   ```
 
+2. **Configurar variables de entorno**:
+   Define las siguientes variables en tu archivo `.env.local`:
+   ```env
+   VITE_SUPABASE_URL=tu_url_de_supabase
+   VITE_SUPABASE_ANON_KEY=tu_clave_anonima_de_supabase
+   ```
 
-1. Install dependencies:
-   `npm install`
-2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
-3. Run the app:
-   `npm run dev`
+3. **Base de Datos**:
+   Ejecuta el contenido de `supabase_schema.sql` en el SQL Editor de tu proyecto de Supabase para crear las tablas necesarias.
+
+## Iniciar la Aplicaci├│n
+
+Para ejecutar la aplicaci├│n en modo desarrollo:
+```bash
+npm run dev
+```
+
+La aplicaci├│n estar├í disponible en [http://localhost:3000](http://localhost:3000).
+
+---
+
+┬® 2026 Pointy POS
diff --git a/components/Customers.tsx b/components/Customers.tsx
index 24f5805..84307ee 100644
--- a/components/Customers.tsx
+++ b/components/Customers.tsx
@@ -138,8 +138,9 @@ const Customers: React.FC<CustomersProps> = ({ customers, sales, exchangeRate, o
                     <div className="relative z-10">
                         <p className="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-1">Deuda Total</p>
                         <div className="flex flex-col">
-                            <span className="text-3xl font-black text-white leading-tight">${activeCustomer.balance.toFixed(2)}</span>
-                            <span className="text-emerald-400 font-bold text-sm">{debtBs.toFixed(2)} Bs</span>
+                            {/* CAMBIO: Bol├¡vares Grande, D├│lares Peque├▒o */}
+                            <span className="text-3xl font-black text-white leading-tight">{debtBs.toLocaleString('es-VE', {minimumFractionDigits: 2})} Bs</span>
+                            <span className="text-emerald-400 font-bold text-sm">Ref: ${activeCustomer.balance.toFixed(2)}</span>
                         </div>
                     </div>
                     {activeCustomer.balance > 0 ? (
@@ -211,15 +212,7 @@ const Customers: React.FC<CustomersProps> = ({ customers, sales, exchangeRate, o
                                                 </span>
                                             </div>
                                         )}
-                                        {/* Badge de Cr├®dito (Si fue fiado) */}
-                                        {!isDebtPayment && (
-                                             <div className="flex items-center gap-1 justify-end mt-1.5">
-                                                <span className="text-[9px] font-black px-2 py-0.5 rounded uppercase flex items-center gap-1.5 bg-orange-50 text-orange-600 border border-orange-100">
-                                                    <Wallet className="w-3 h-3"/>
-                                                    Cr├®dito
-                                                </span>
-                                            </div>
-                                        )}
+                                        {/* CAMBIO: Se elimin├│ el badge de "Cr├®dito" para una vista m├ís limpia */}
                                     </div>
                                 </div>
                                 
@@ -301,8 +294,9 @@ const Customers: React.FC<CustomersProps> = ({ customers, sales, exchangeRate, o
                 <div className="flex items-center gap-3">
                     {customer.balance > 0 ? (
                         <div className="text-right shrink-0">
-                            <span className="block text-sm font-black text-red-600 leading-none">${customer.balance.toFixed(2)}</span>
-                            <span className="block text-[10px] font-bold text-gray-400 leading-none mt-1">{debtBs.toFixed(2)} Bs</span>
+                            {/* CAMBIO: Bol├¡vares Grande, D├│lares Peque├▒o */}
+                            <span className="block text-sm font-black text-red-600 leading-none">{debtBs.toLocaleString('es-VE', {minimumFractionDigits: 2})} Bs</span>
+                            <span className="block text-[10px] font-bold text-gray-400 leading-none mt-1">Ref: ${customer.balance.toFixed(2)}</span>
                         </div>
                     ) : (
                         <div className="text-emerald-500 font-black text-[10px] bg-emerald-50 px-2 py-1 rounded-lg">
diff --git a/components/Inventory.tsx b/components/Inventory.tsx
index 4dfeb0a..0d9386e 100644
--- a/components/Inventory.tsx
+++ b/components/Inventory.tsx
@@ -1,21 +1,32 @@
 
 import React, { useState } from 'react';
 import { Product } from '../types';
-import { Plus, Trash2, Edit, Search, CATEGORIES, DollarSign, TrendingDown, Filter, ArrowUpDown, PiggyBank, ShoppingBag, TrendingUp, Package } from '../constants';
+import { Plus, Trash2, Edit, Search, CATEGORIES, DollarSign, TrendingDown, Filter, ArrowUpDown, PiggyBank, ShoppingBag, TrendingUp, Package, Scale, Box, Layers, Settings, X, Check, Calculator, Divide, ArrowRight, ChevronDown, Tag, ChevronRight } from '../constants';
 
 interface InventoryProps {
   products: Product[];
+  exchangeRate: number;
+  categories: string[];
   onAdd: (product: Product) => void;
   onUpdate: (product: Product) => void;
   onDelete: (id: string) => void;
+  onAddCategory: (category: string) => void;
 }
 
 type FilterStatus = 'all' | 'low-stock' | 'out-of-stock';
 type SortBy = 'name' | 'price-high' | 'price-low' | 'stock-high' | 'stock-low' | 'margin-high';
 
-const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDelete }) => {
+const Inventory: React.FC<InventoryProps> = ({ products, exchangeRate, categories, onAdd, onUpdate, onDelete, onAddCategory }) => {
   const [isModalOpen, setIsModalOpen] = useState(false);
   const [editingProduct, setEditingProduct] = useState<Product | null>(null);
+
+  // Estado para la ventana de configuraci├│n de variantes
+  const [isVariantConfigOpen, setIsVariantConfigOpen] = useState(false);
+
+  // Estados para el selector de categor├¡as
+  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
+  const [newCategoryName, setNewCategoryName] = useState('');
+
   const [searchTerm, setSearchTerm] = useState('');
   const [statusFilter, setStatusFilter] = useState<FilterStatus>('all');
   const [sortBy, setSortBy] = useState<SortBy>('name');
@@ -27,21 +38,25 @@ const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDele
     costPrice: 0,
     stock: 0,
     description: '',
-    image: ''
+    image: '',
+    sellingMode: 'simple',
+    unitsPerPackage: 0,
+    pricePerUnit: 0,
+    measurementUnit: 'kg'
   });
 
   const totalCostValue = products.reduce((sum, p) => sum + (p.costPrice * p.stock), 0);
   const totalRetailValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);
   const totalPotentialProfit = totalRetailValue - totalCostValue;
-  const avgMargin = totalCostValue > 0 ? (totalPotentialProfit / totalCostValue) * 100 : 0;
+  const profitMarginPercent = totalRetailValue > 0 ? (totalPotentialProfit / totalRetailValue) * 100 : 0;
 
   const filteredProducts = products
     .filter(p => {
       const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.category.toLowerCase().includes(searchTerm.toLowerCase());
-      const matchesStatus = 
+      const matchesStatus =
         statusFilter === 'all' ? true :
-        statusFilter === 'low-stock' ? p.stock < 10 && p.stock > 0 :
-        statusFilter === 'out-of-stock' ? p.stock === 0 : true;
+          statusFilter === 'low-stock' ? p.stock < 10 && p.stock > 0 :
+            statusFilter === 'out-of-stock' ? p.stock === 0 : true;
       return matchesSearch && matchesStatus;
     })
     .sort((a, b) => {
@@ -66,7 +81,11 @@ const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDele
       costPrice: Number(formData.costPrice) || 0,
       stock: Number(formData.stock) || 0,
       description: formData.description || '',
-      image: formData.image || `https://picsum.photos/seed/${Math.random()}/200`
+      image: formData.image || `https://picsum.photos/seed/${Math.random()}/200`,
+      sellingMode: formData.sellingMode || 'simple',
+      measurementUnit: formData.measurementUnit,
+      unitsPerPackage: Number(formData.unitsPerPackage) || 0,
+      pricePerUnit: Number(formData.pricePerUnit) || 0
     };
 
     if (editingProduct) {
@@ -80,7 +99,13 @@ const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDele
   const openModal = (product?: Product) => {
     if (product) {
       setEditingProduct(product);
-      setFormData(product);
+      setFormData({
+        ...product,
+        sellingMode: product.sellingMode || 'simple',
+        measurementUnit: product.measurementUnit || 'kg',
+        unitsPerPackage: product.unitsPerPackage || 0,
+        pricePerUnit: product.pricePerUnit || 0
+      });
     } else {
       setEditingProduct(null);
       setFormData({
@@ -90,245 +115,617 @@ const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDele
         costPrice: 0,
         stock: 0,
         description: '',
-        image: `https://picsum.photos/seed/${Math.random()}/200`
+        image: `https://picsum.photos/seed/${Math.random()}/200`,
+        sellingMode: 'simple',
+        unitsPerPackage: 0,
+        pricePerUnit: 0,
+        measurementUnit: 'kg'
       });
     }
+    setIsVariantConfigOpen(false);
+    setIsCategoryModalOpen(false);
     setIsModalOpen(true);
   };
 
   const closeModal = () => setIsModalOpen(false);
 
+  // Manejador para crear nueva categor├¡a
+  const handleCreateCategory = () => {
+    if (newCategoryName.trim()) {
+      const formattedName = newCategoryName.trim();
+      onAddCategory(formattedName);
+      setFormData({ ...formData, category: formattedName });
+      setNewCategoryName('');
+      setIsCategoryModalOpen(false);
+    }
+  };
+
+  const handleSelectCategory = (cat: string) => {
+    setFormData({ ...formData, category: cat });
+    setIsCategoryModalOpen(false);
+  };
+
+  // Helper para c├ílculos de variantes
+  const getPackageCalculations = () => {
+    const packageCost = Number(formData.costPrice) || 0;
+    const units = Number(formData.unitsPerPackage) || 1;
+    const unitSellPrice = Number(formData.pricePerUnit) || 0;
+
+    const unitCost = units > 0 ? packageCost / units : 0;
+    const unitProfit = unitSellPrice - unitCost;
+    const unitMargin = unitSellPrice > 0 ? (unitProfit / unitSellPrice) * 100 : 0;
+
+    return { unitCost, unitProfit, unitMargin };
+  };
+
+  // Helper para c├ílculo principal
+  const getMainCalculations = () => {
+    const cost = Number(formData.costPrice) || 0;
+    const price = Number(formData.price) || 0;
+    const profit = price - cost;
+    const margin = price > 0 ? (profit / price) * 100 : 0;
+    return { profit, margin };
+  };
+
+  const { profit, margin } = getMainCalculations();
+
   return (
     <div className="space-y-4 pb-24">
-      <div className="flex flex-col gap-4">
-        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
-          <div>
-            <h2 className="text-2xl font-black text-gray-800 flex items-center gap-2">
-                <Package className="w-6 h-6 text-indigo-600" />
-                Inventario
-            </h2>
-            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Gesti├│n total de mercanc├¡a</p>
+
+      {/* Estad├¡sticas */}
+      <div className="grid grid-cols-3 gap-2 sm:gap-4 mt-2">
+        <div className="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
+          <div className="flex items-center gap-1.5 mb-0.5 overflow-hidden">
+            <TrendingDown className="w-3 h-3 text-red-400 shrink-0" />
+            <span className="text-[8px] font-black text-gray-400 uppercase truncate">Inversi├│n</span>
           </div>
-          <button
-            onClick={() => openModal()}
-            className="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3.5 bg-gray-900 text-white rounded-2xl hover:bg-black transition-all shadow-xl active:scale-95 text-xs font-black uppercase tracking-widest"
-          >
-            <Plus className="w-5 h-5" />
-            A├▒adir Producto
-          </button>
+          <p className="text-sm sm:text-lg font-black text-gray-800 leading-tight">${totalCostValue.toLocaleString(undefined, { minimumFractionDigits: 1 })}</p>
+          <p className="text-[9px] font-bold text-gray-400 mt-1">{(totalCostValue * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
         </div>
-
-        {/* Estad├¡sticas Compactas */}
-        <div className="grid grid-cols-3 gap-2 sm:gap-4">
-          <div className="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
-            <div className="flex items-center gap-1.5 mb-0.5 overflow-hidden">
-              <TrendingDown className="w-3 h-3 text-red-400 shrink-0" />
-              <span className="text-[8px] font-black text-gray-400 uppercase truncate">Inversi├│n</span>
-            </div>
-            <p className="text-sm sm:text-lg font-black text-gray-800 leading-tight">${totalCostValue.toLocaleString(undefined, { minimumFractionDigits: 1 })}</p>
+        <div className="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
+          <div className="flex items-center gap-1.5 mb-0.5 overflow-hidden">
+            <TrendingUp className="w-3 h-3 text-emerald-400 shrink-0" />
+            <span className="text-[8px] font-black text-gray-400 uppercase truncate">Valor Venta</span>
           </div>
-          <div className="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
-            <div className="flex items-center gap-1.5 mb-0.5 overflow-hidden">
-              <TrendingUp className="w-3 h-3 text-emerald-400 shrink-0" />
-              <span className="text-[8px] font-black text-gray-400 uppercase truncate">Valor</span>
-            </div>
-            <p className="text-sm sm:text-lg font-black text-gray-800 leading-tight">${totalRetailValue.toLocaleString(undefined, { minimumFractionDigits: 1 })}</p>
+          <p className="text-sm sm:text-lg font-black text-gray-800 leading-tight">${totalRetailValue.toLocaleString(undefined, { minimumFractionDigits: 1 })}</p>
+          <p className="text-[9px] font-bold text-gray-400 mt-1">{(totalRetailValue * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+        </div>
+        <div className="bg-indigo-600 p-3 rounded-2xl shadow-lg shadow-indigo-100 text-white flex flex-col justify-center relative overflow-hidden">
+          <div className="flex items-center gap-1.5 mb-0.5 relative z-10">
+            <PiggyBank className="w-3 h-3 text-indigo-200 shrink-0" />
+            <span className="text-[8px] font-black text-indigo-200 uppercase truncate">Utilidad</span>
           </div>
-          <div className="bg-indigo-600 p-3 rounded-2xl shadow-lg shadow-indigo-100 text-white flex flex-col justify-center">
-            <div className="flex items-center gap-1.5 mb-0.5 overflow-hidden">
-              <PiggyBank className="w-3 h-3 text-indigo-200 shrink-0" />
-              <span className="text-[8px] font-black text-indigo-200 uppercase truncate">Utilidad</span>
-            </div>
-            <div className="flex items-baseline gap-1">
+          <div className="flex items-end justify-between relative z-10">
+            <div>
               <p className="text-sm sm:text-lg font-black leading-tight">${totalPotentialProfit.toLocaleString(undefined, { minimumFractionDigits: 1 })}</p>
+              <p className="text-[9px] font-bold text-indigo-300 mt-1">{(totalPotentialProfit * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+            </div>
+            <div className="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-black text-indigo-100">
+              {profitMarginPercent.toFixed(0)}%
             </div>
           </div>
         </div>
+      </div>
 
-        {/* Filtros */}
-        <div className="flex flex-col lg:flex-row gap-3">
-          <div className="relative flex-1">
-            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
-            <input
-              type="text"
-              placeholder="BUSCAR..."
-              className="w-full pl-10 pr-4 py-3 bg-white border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-xs shadow-sm text-black font-black uppercase"
-              value={searchTerm}
-              onChange={(e) => setSearchTerm(e.target.value)}
-            />
-          </div>
-          
-          <div className="flex gap-2">
-            <select 
-              className="flex-1 pl-4 pr-8 py-3 bg-white border border-gray-100 rounded-2xl text-[10px] font-black uppercase outline-none shadow-sm cursor-pointer text-gray-600"
-              value={statusFilter}
-              onChange={(e) => setStatusFilter(e.target.value as FilterStatus)}
-            >
-              <option value="all">TODOS</option>
-              <option value="low-stock">BAJO STOCK</option>
-              <option value="out-of-stock">AGOTADOS</option>
-            </select>
-            
-            <select 
-              className="flex-1 pl-4 pr-8 py-3 bg-white border border-gray-100 rounded-2xl text-[10px] font-black uppercase outline-none shadow-sm cursor-pointer text-gray-600"
-              value={sortBy}
-              onChange={(e) => setSortBy(e.target.value as SortBy)}
-            >
-              <option value="name">A-Z</option>
-              <option value="price-high">PRECIO MAX</option>
-              <option value="price-low">PRECIO MIN</option>
-              <option value="margin-high">UTILIDAD</option>
-              <option value="stock-high">STOCK MAX</option>
-              <option value="stock-low">STOCK MIN</option>
-            </select>
-          </div>
+      {/* Filtros */}
+      <div className="flex flex-col md:flex-row gap-3">
+        <div className="relative flex-1">
+          <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
+          <input
+            type="text"
+            placeholder="BUSCAR PRODUCTO..."
+            className="w-full pl-10 pr-4 py-3 bg-white border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-xs shadow-sm text-gray-900 font-black uppercase"
+            value={searchTerm}
+            onChange={(e) => setSearchTerm(e.target.value)}
+          />
+        </div>
+
+        <div className="flex gap-2 shrink-0">
+          <select
+            className="pl-4 pr-8 py-3 bg-white border border-gray-100 rounded-2xl text-[10px] font-black uppercase outline-none shadow-sm cursor-pointer text-gray-600 focus:border-indigo-500"
+            value={statusFilter}
+            onChange={(e) => setStatusFilter(e.target.value as FilterStatus)}
+          >
+            <option value="all">TODOS</option>
+            <option value="low-stock">BAJO STOCK</option>
+            <option value="out-of-stock">AGOTADOS</option>
+          </select>
+
+          <select
+            className="pl-4 pr-8 py-3 bg-white border border-gray-100 rounded-2xl text-[10px] font-black uppercase outline-none shadow-sm cursor-pointer text-gray-600 focus:border-indigo-500"
+            value={sortBy}
+            onChange={(e) => setSortBy(e.target.value as SortBy)}
+          >
+            <option value="name">A-Z</option>
+            <option value="price-high">PRECIO MAX</option>
+            <option value="price-low">PRECIO MIN</option>
+            <option value="margin-high">UTILIDAD</option>
+            <option value="stock-high">STOCK MAX</option>
+            <option value="stock-low">STOCK MIN</option>
+          </select>
         </div>
       </div>
 
-      {/* Lista de Productos Estilo Carrito */}
-      <div className="space-y-3">
+      {/* LISTA DE PRODUCTOS */}
+      <div className="flex flex-col gap-2">
         {filteredProducts.map(product => {
-          const utility = product.price - product.costPrice;
+          const profit = product.price - product.costPrice;
+          const margin = product.price > 0 ? (profit / product.price) * 100 : 0;
+          const isLowStock = product.stock < 10;
+          const isOutOfStock = product.stock === 0;
+          const isPackage = product.sellingMode === 'package';
+          const isWeight = product.sellingMode === 'weight';
+
           return (
-            <div 
-              key={product.id} 
+            <div
+              key={product.id}
               onClick={() => openModal(product)}
-              className="bg-white px-5 py-4 rounded-[1.5rem] border border-gray-100 flex items-center justify-between shadow-sm hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer active:scale-[0.99]"
+              className="bg-white p-3 rounded-2xl border border-gray-100 flex items-center gap-2 sm:gap-3 shadow-sm hover:border-indigo-200 hover:shadow-md transition-all cursor-pointer active:scale-[0.99]"
             >
-              {/* IZQUIERDA: Nombre y Categor├¡a */}
-              <div className="flex flex-col gap-0.5 min-w-0 flex-1">
-                <h3 className="font-black text-gray-800 text-base leading-tight uppercase truncate pr-4">{product.name}</h3>
-                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{product.category}</span>
+              {/* STOCK/VARIANT ICON */}
+              <div className={`w-12 h-12 rounded-xl flex items-center justify-center shrink-0 border-2 relative ${isOutOfStock ? 'bg-red-50 border-red-100 text-red-500' : isLowStock ? 'bg-orange-50 border-orange-100 text-orange-500' : 'bg-gray-50 border-gray-100 text-gray-700'}`}>
+                {/* Number always in center */}
+                <span className="font-black text-lg">{product.stock}</span>
+
+                {/* Icon Badge for Variants */}
+                {(isWeight || isPackage) && (
+                  <div className="absolute -top-2 -right-2 w-6 h-6 bg-white rounded-full border border-gray-100 flex items-center justify-center shadow-sm z-10">
+                    {isWeight ? <Scale className="w-3 h-3 text-purple-500" /> : <Box className="w-3 h-3 text-blue-500" />}
+                  </div>
+                )}
               </div>
 
-              {/* CENTRO: Stock */}
-              <div className="mx-4 flex-shrink-0">
-                 <div className="flex flex-col items-center">
-                    <span className="text-[8px] font-black text-gray-300 uppercase leading-none mb-1">Stock</span>
-                    <span className={`text-sm font-black px-4 py-1.5 rounded-xl shadow-inner ${product.stock < 10 ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-emerald-50 text-emerald-600 border border-emerald-100'}`}>
-                        {product.stock}
-                    </span>
-                 </div>
+              {/* NOMBRE Y CATEGORIA */}
+              <div className="flex-1 min-w-0">
+                <h3 className="font-bold text-gray-800 text-sm leading-tight truncate">{product.name}</h3>
+                <div className="flex items-center gap-2 mt-0.5">
+                  <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wide truncate">{product.category}</p>
+                  {/* Badges de Variante */}
+                  {isPackage && <span className="text-[8px] font-black bg-blue-50 text-blue-600 px-1.5 rounded uppercase">Pack x{product.unitsPerPackage}</span>}
+                  {isWeight && <span className="text-[8px] font-black bg-purple-50 text-purple-600 px-1.5 rounded uppercase">x {product.measurementUnit}</span>}
+                </div>
               </div>
 
-              {/* DERECHA: Precios y Acciones */}
-              <div className="flex items-center gap-4">
-                  <div className="flex flex-col items-end flex-shrink-0 min-w-[90px]">
-                    <div className="flex flex-col items-end">
-                        <span className="text-[9px] font-bold text-gray-400 uppercase leading-none mb-1">P. Venta</span>
-                        <span className="text-lg font-black text-indigo-700 leading-none">${product.price.toFixed(2)}</span>
-                    </div>
-                    <div className="flex flex-col items-end mt-1.5">
-                        <span className="text-[8px] font-bold text-gray-300 uppercase leading-none">Costo: ${product.costPrice.toFixed(2)}</span>
-                    </div>
-                  </div>
-                  
-                  <div className="hidden sm:flex flex-col gap-1">
-                      <button className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"><Edit className="w-4 h-4"/></button>
-                      <button onClick={(e) => { e.stopPropagation(); onDelete(product.id); }} className="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-colors"><Trash2 className="w-4 h-4"/></button>
-                  </div>
+              {/* PRECIOS */}
+              <div className="text-right flex flex-col items-end">
+                {/* Precio Principal */}
+                <p className="font-black text-sm text-indigo-700">${product.price.toFixed(2)}</p>
+
+                {/* Precio Secundario (Unidad suelta o Costo) */}
+                {isPackage && product.pricePerUnit ? (
+                  <p className="text-[9px] font-bold text-emerald-500 bg-emerald-50 px-1 rounded mt-0.5">Unidad: ${product.pricePerUnit.toFixed(2)}</p>
+                ) : (
+                  <p className="text-[8px] font-bold text-gray-400 uppercase mt-0.5">Costo: ${product.costPrice.toFixed(2)}</p>
+                )}
+              </div>
+
+              {/* MARGEN */}
+              <div className="bg-gray-50 rounded-lg p-1.5 min-w-[50px] text-center border border-gray-100 hidden sm:block">
+                <p className={`text-[9px] font-bold ${margin >= 30 ? 'text-emerald-500' : margin > 0 ? 'text-orange-400' : 'text-red-400'}`}>
+                  {margin.toFixed(0)}%
+                </p>
               </div>
             </div>
           );
         })}
         {filteredProducts.length === 0 && (
-            <div className="py-20 text-center flex flex-col items-center justify-center opacity-30 gap-4">
-                <Package className="w-16 h-16" />
-                <p className="text-xs font-black uppercase tracking-widest">Sin coincidencias en el inventario</p>
-            </div>
+          <div className="py-12 text-center flex flex-col items-center justify-center opacity-30 gap-2">
+            <Package className="w-10 h-10" />
+            <p className="text-xs font-black uppercase tracking-widest">Inventario Vac├¡o</p>
+          </div>
         )}
       </div>
 
+      <button
+        onClick={() => openModal()}
+        className="fixed bottom-24 right-4 md:bottom-10 md:right-10 z-40 bg-gray-900 text-white w-14 h-14 rounded-full shadow-2xl shadow-gray-900/30 hover:scale-105 active:scale-95 transition-all flex items-center justify-center group"
+      >
+        <Plus className="w-7 h-7 group-hover:rotate-90 transition-transform" />
+      </button>
+
+      {/* MAIN MODAL - TAMA├æO GRANDE (FULL SCREEN) */}
       {isModalOpen && (
-        <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 z-[100] backdrop-blur-sm animate-fade-in">
-          <div className="bg-white rounded-t-[2.5rem] sm:rounded-[2rem] w-full max-w-lg shadow-2xl overflow-hidden animate-slide-up">
-            <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
-              <h3 className="text-xl font-black text-gray-900">{editingProduct ? 'Editar' : 'Nuevo'} Producto</h3>
-              <button onClick={closeModal} className="text-gray-400 text-3xl font-light hover:text-black">&times;</button>
-            </div>
-            
-            <form onSubmit={handleSubmit} className="p-8 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
-                <div className="space-y-1">
-                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Nombre Comercial</label>
+        <div className="fixed inset-0 bg-white z-[100] flex flex-col animate-fade-in">
+
+          {/* 1. CATEGORY SELECTION OVERLAY (Ventana detallada para Categor├¡as) */}
+          {isCategoryModalOpen && (
+            <div className="absolute inset-0 bg-white z-30 flex flex-col animate-slide-up">
+              <div className="p-6 bg-emerald-50 border-b border-emerald-100 flex justify-between items-center shrink-0">
+                <div className="flex items-center gap-3">
+                  <div className="bg-emerald-100 p-2 rounded-xl text-emerald-600">
+                    <Tag className="w-5 h-5" />
+                  </div>
+                  <div>
+                    <h3 className="text-lg font-black text-gray-900">Categor├¡a</h3>
+                    <p className="text-xs text-emerald-600 font-bold uppercase tracking-widest">Seleccionar o Crear</p>
+                  </div>
+                </div>
+                <button onClick={() => setIsCategoryModalOpen(false)} className="bg-white p-2 rounded-full text-emerald-600 shadow-sm">
+                  <X className="w-5 h-5" />
+                </button>
+              </div>
+
+              <div className="flex-1 overflow-y-auto p-4 space-y-2 w-full max-w-4xl mx-auto">
+                {categories.filter(c => c !== 'Todas').map(cat => (
+                  <button
+                    key={cat}
+                    onClick={() => handleSelectCategory(cat)}
+                    className={`w-full p-4 rounded-2xl border-2 flex items-center justify-between transition-all active:scale-[0.98] ${formData.category === cat ? 'bg-emerald-50 border-emerald-200 text-emerald-700 shadow-sm' : 'bg-white border-gray-100 text-gray-600 hover:border-gray-200'}`}
+                  >
+                    <span className="font-bold text-sm">{cat}</span>
+                    {formData.category === cat && <Check className="w-5 h-5 text-emerald-600" />}
+                  </button>
+                ))}
+              </div>
+
+              <div className="p-6 w-full max-w-4xl mx-auto border-t border-gray-100 bg-gray-50">
+                <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1 mb-2">Crear Nueva Categor├¡a</p>
+                <div className="flex gap-2">
                   <input
-                    required
-                    autoFocus
-                    placeholder="Ej. Caf├® Molido 1kg"
-                    className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all text-sm font-bold"
-                    value={formData.name}
-                    onChange={e => setFormData({ ...formData, name: e.target.value })}
+                    type="text"
+                    placeholder="Nombre de nueva categor├¡a..."
+                    className="flex-1 p-4 bg-white border-2 border-gray-200 rounded-2xl text-sm font-bold text-gray-900 outline-none focus:border-emerald-500 transition-all"
+                    value={newCategoryName}
+                    onChange={(e) => setNewCategoryName(e.target.value)}
+                    onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleCreateCategory(); } }}
                   />
+                  <button
+                    onClick={handleCreateCategory}
+                    disabled={!newCategoryName.trim()}
+                    className="bg-gray-900 text-white p-4 rounded-2xl shadow-lg disabled:opacity-50 disabled:shadow-none active:scale-95 transition-all"
+                  >
+                    <Plus className="w-6 h-6" />
+                  </button>
                 </div>
-                
-                <div className="grid grid-cols-2 gap-4">
-                  <div className="space-y-1">
-                    <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Categor├¡a</label>
-                    <select
-                      className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none text-sm font-bold cursor-pointer focus:border-indigo-500 transition-all"
-                      value={formData.category}
-                      onChange={e => setFormData({ ...formData, category: e.target.value })}
-                    >
-                      {CATEGORIES.slice(1).map(c => <option key={c} value={c}>{c}</option>)}
-                    </select>
+              </div>
+            </div>
+          )}
+
+          {/* 2. VARIANT CONFIGURATION OVERLAY (Ventana detallada dentro del modal) */}
+          {isVariantConfigOpen && (
+            <div className="absolute inset-0 bg-white z-20 flex flex-col animate-slide-up">
+              <div className="p-6 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
+                <div className="flex items-center gap-3">
+                  <div className="bg-indigo-100 p-2 rounded-xl text-indigo-600">
+                    <Settings className="w-5 h-5" />
                   </div>
-                  <div className="space-y-1">
-                    <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Stock Actual</label>
-                    <input
-                      type="number"
-                      placeholder="0"
-                      className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white outline-none text-sm font-bold focus:border-indigo-500 transition-all"
-                      value={formData.stock || ''}
-                      onChange={e => setFormData({ ...formData, stock: parseInt(e.target.value) || 0 })}
-                    />
+                  <div>
+                    <h3 className="text-lg font-black text-gray-900">Caracter├¡sticas Especiales</h3>
+                    <p className="text-xs text-indigo-500 font-bold uppercase tracking-widest">Configuraci├│n de Venta</p>
                   </div>
                 </div>
+                <button onClick={() => setIsVariantConfigOpen(false)} className="bg-white p-2 rounded-full text-indigo-600 shadow-sm">
+                  <Check className="w-5 h-5" />
+                </button>
+              </div>
+
+              <div className="p-6 space-y-6 flex-1 overflow-y-auto w-full max-w-4xl mx-auto">
+
+                {/* Selector de Modo */}
+                <div className="grid grid-cols-3 gap-2">
+                  <button
+                    type="button"
+                    onClick={() => setFormData({ ...formData, sellingMode: 'simple' })}
+                    className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${formData.sellingMode === 'simple' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-gray-100 text-gray-400'}`}
+                  >
+                    <Package className="w-6 h-6" />
+                    <span className="text-[10px] font-black uppercase">Unidad</span>
+                  </button>
+                  <button
+                    type="button"
+                    onClick={() => setFormData({ ...formData, sellingMode: 'weight' })}
+                    className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${formData.sellingMode === 'weight' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-gray-100 text-gray-400'}`}
+                  >
+                    <Scale className="w-6 h-6" />
+                    <span className="text-[10px] font-black uppercase">Peso</span>
+                  </button>
+                  <button
+                    type="button"
+                    onClick={() => setFormData({ ...formData, sellingMode: 'package' })}
+                    className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${formData.sellingMode === 'package' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-gray-100 text-gray-400'}`}
+                  >
+                    <Box className="w-6 h-6" />
+                    <span className="text-[10px] font-black uppercase">Paquete</span>
+                  </button>
+                </div>
 
-                <div className="grid grid-cols-2 gap-4">
-                  <div className="space-y-1">
-                    <label className="text-[10px] font-black text-red-400 uppercase tracking-widest px-1 flex items-center gap-1">
-                       Costo Unitario ($)
-                    </label>
-                    <input
-                      type="number"
-                      step="0.01"
-                      className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white outline-none text-sm font-bold focus:border-indigo-500 transition-all"
-                      value={formData.costPrice || ''}
-                      placeholder="0.00"
-                      onChange={e => setFormData({ ...formData, costPrice: parseFloat(e.target.value) || 0 })}
-                    />
+                {/* Configuraci├│n Din├ímica */}
+                {formData.sellingMode === 'weight' && (
+                  <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-4 animate-fade-in">
+                    <h4 className="font-bold text-gray-900 text-sm">Venta por Peso / Volumen</h4>
+                    <div className="space-y-1">
+                      <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Unidad de Medida</label>
+                      <select
+                        className="w-full p-3 border-2 border-gray-200 rounded-xl bg-white outline-none text-sm font-bold text-gray-900"
+                        value={formData.measurementUnit}
+                        onChange={e => setFormData({ ...formData, measurementUnit: e.target.value as any })}
+                      >
+                        <option value="kg">Kilogramos (Kg)</option>
+                        <option value="g">Gramos (g)</option>
+                        <option value="l">Litros (L)</option>
+                        <option value="ml">Mililitros (ml)</option>
+                      </select>
+                    </div>
+                    <p className="text-xs text-gray-500 bg-white p-3 rounded-xl border border-gray-100">
+                      <InfoIcon className="inline w-3 h-3 mr-1" />
+                      El precio principal ser├í el precio por <b>1 {formData.measurementUnit}</b>.
+                    </p>
                   </div>
-                  <div className="space-y-1">
-                    <label className="text-[10px] font-black text-emerald-500 uppercase tracking-widest px-1 flex items-center gap-1">
-                       Precio Venta ($)
-                    </label>
-                    <input
-                      type="number"
-                      step="0.01"
-                      className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white outline-none text-sm font-bold focus:border-indigo-500 transition-all"
-                      value={formData.price || ''}
-                      placeholder="0.00"
-                      onChange={e => setFormData({ ...formData, price: parseFloat(e.target.value) || 0 })}
-                    />
+                )}
+
+                {formData.sellingMode === 'package' && (
+                  <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-4 animate-fade-in">
+                    <h4 className="font-bold text-gray-900 text-sm">Venta por Paquete (Multi-precio)</h4>
+
+                    <div className="bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-center justify-between">
+                      <span className="text-[10px] font-bold text-blue-600 uppercase">Costo Total Paquete (Ref)</span>
+                      <span className="text-sm font-black text-blue-900">${Number(formData.costPrice || 0).toFixed(2)}</span>
+                    </div>
+
+                    {/* Reorganizaci├│n: Unidades y Costo Unitario en la misma fila */}
+                    <div className="grid grid-cols-2 gap-4">
+                      <div className="space-y-1">
+                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Unidades / Pack</label>
+                        <div className="relative">
+                          <Layers className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
+                          <input
+                            type="number"
+                            placeholder="Ej. 12"
+                            className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl bg-white outline-none text-sm font-bold text-gray-900"
+                            value={formData.unitsPerPackage || ''}
+                            onChange={e => setFormData({ ...formData, unitsPerPackage: parseInt(e.target.value) || 0 })}
+                          />
+                        </div>
+                      </div>
+
+                      {/* Costo calculado al lado */}
+                      <div className="space-y-1">
+                        <label className="text-[10px] font-black text-orange-400 uppercase tracking-widest px-1">Costo Unitario</label>
+                        {(() => {
+                          const { unitCost } = getPackageCalculations();
+                          return (
+                            <div className="w-full p-3 border-2 border-orange-100 bg-orange-50 rounded-xl flex items-center gap-2 h-[46px]">
+                              <Divide className="w-4 h-4 text-orange-400" />
+                              <span className="text-sm font-black text-orange-700">${unitCost.toFixed(2)}</span>
+                            </div>
+                          );
+                        })()}
+                      </div>
+                    </div>
+
+                    <div className="space-y-1">
+                      <label className="text-[10px] font-black text-emerald-500 uppercase tracking-widest px-1">Precio Venta (Unidad Suelta)</label>
+                      <div className="flex gap-2">
+                        <div className="relative flex-1">
+                          <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
+                          <input
+                            type="number"
+                            step="0.01"
+                            placeholder="0.00"
+                            className="w-full pl-8 pr-4 py-3 border-2 border-emerald-100 rounded-xl bg-white outline-none text-sm font-bold text-gray-900 focus:border-emerald-500"
+                            value={formData.pricePerUnit || ''}
+                            onChange={e => setFormData({ ...formData, pricePerUnit: parseFloat(e.target.value) || 0 })}
+                          />
+                        </div>
+                        <div className="bg-emerald-50 border border-emerald-100 rounded-2xl px-3 flex flex-col justify-center min-w-[70px] text-right">
+                          <span className="text-[8px] font-black text-emerald-300 uppercase">Bol├¡vares</span>
+                          <span className="text-xs font-black text-emerald-600 leading-none">
+                            {((formData.pricePerUnit || 0) * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 2 })}
+                          </span>
+                        </div>
+                      </div>
+                    </div>
+
+                    {/* C├üLCULO DE RENTABILIDAD POR UNIDAD (Barra Horizontal) */}
+                    {(() => {
+                      const { unitProfit, unitMargin } = getPackageCalculations();
+                      return (
+                        <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center justify-around shadow-sm mt-2">
+                          <div className="text-center">
+                            <p className="text-[9px] uppercase font-bold text-emerald-600">Ganancia/Unidad</p>
+                            <p className="text-sm font-black text-emerald-700">+${unitProfit.toFixed(2)}</p>
+                          </div>
+                          <div className="w-px h-8 bg-gray-100"></div>
+                          <div className="text-center">
+                            <p className="text-[9px] uppercase font-bold text-blue-600">Margen %</p>
+                            <p className="text-sm font-black text-blue-700">{unitMargin.toFixed(0)}%</p>
+                          </div>
+                        </div>
+                      );
+                    })()}
                   </div>
-                </div>
+                )}
+              </div>
+              <div className="p-6 w-full max-w-4xl mx-auto">
+                <button
+                  onClick={() => setIsVariantConfigOpen(false)}
+                  className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform"
+                >
+                  Guardar Configuraci├│n
+                </button>
+              </div>
+            </div>
+          )}
+
+          <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
+            <h3 className="text-xl font-black text-gray-900">{editingProduct ? 'Editar' : 'Nuevo'} Producto</h3>
+            <button onClick={closeModal} className="text-gray-400 text-3xl font-light hover:text-black">&times;</button>
+          </div>
 
-              <div className="pt-4 flex gap-3">
+          <form onSubmit={handleSubmit} className="p-8 space-y-6 overflow-y-auto custom-scrollbar flex-1 w-full max-w-4xl mx-auto">
+            <div className="space-y-1">
+              <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Nombre Comercial</label>
+              <div className="flex gap-2">
+                <input
+                  required
+                  autoFocus={!editingProduct} // Changed here
+                  placeholder="Ej. Caf├® Molido 1kg"
+                  className="flex-1 p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all text-sm font-bold text-gray-900"
+                  value={formData.name}
+                  onChange={e => setFormData({ ...formData, name: e.target.value })}
+                />
+                {/* BOT├ôN DE VARIANTE */}
                 <button
                   type="button"
-                  onClick={closeModal}
-                  className="flex-1 py-4 border-2 border-gray-100 rounded-2xl font-bold text-gray-400 hover:bg-gray-50 transition-all active:scale-95"
+                  onClick={() => setIsVariantConfigOpen(true)}
+                  className={`w-14 rounded-2xl border-2 flex items-center justify-center transition-all active:scale-95 ${formData.sellingMode !== 'simple' ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-gray-200 text-gray-400 hover:border-indigo-300 hover:text-indigo-500'}`}
+                  title="Agregar variante / caracter├¡stica especial"
                 >
-                  Cancelar
+                  {formData.sellingMode === 'weight' ? <Scale className="w-6 h-6" /> : formData.sellingMode === 'package' ? <Box className="w-6 h-6" /> : <Settings className="w-6 h-6" />}
                 </button>
+              </div>
+            </div>
+
+            <div className="grid grid-cols-2 gap-4">
+              <div className="space-y-1">
+                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">Categor├¡a</label>
+                {/* TRIGGER PARA ABRIR MODAL DE CATEGORIA */}
                 <button
-                  type="submit"
-                  className="flex-1 py-4 bg-gray-900 text-white rounded-2xl font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all"
+                  type="button"
+                  onClick={() => setIsCategoryModalOpen(true)}
+                  className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none text-sm font-bold text-gray-900 focus:border-indigo-500 transition-all text-left flex items-center justify-between group active:scale-[0.98]"
                 >
-                  {editingProduct ? 'Actualizar' : 'Guardar'}
+                  <span>{formData.category}</span>
+                  <ChevronRight className="w-4 h-4 text-gray-400 group-hover:text-indigo-500" />
                 </button>
               </div>
-            </form>
-          </div>
+              <div className="space-y-1">
+                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">
+                  {formData.sellingMode === 'weight' ? `Stock (${formData.measurementUnit})` : 'Stock Actual'}
+                </label>
+                <input
+                  type="number"
+                  step={formData.sellingMode === 'weight' ? "0.01" : "1"}
+                  placeholder="0"
+                  className="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:bg-white outline-none text-sm font-bold text-gray-900 focus:border-indigo-500 transition-all"
+                  value={formData.stock || ''}
+                  onChange={e => setFormData({ ...formData, stock: parseFloat(e.target.value) || 0 })}
+                />
+              </div>
+            </div>
+
+            <div className="pt-4 border-t border-gray-100">
+              <div className="flex items-center gap-2 mb-3">
+                <DollarSign className="w-4 h-4 text-gray-400" />
+                <h4 className="text-xs font-black text-gray-900 uppercase tracking-widest">Estructura de Costos</h4>
+              </div>
+
+              {/* FORCED 2-COLUMN LAYOUT FOR KEYBOARD OPTIMIZATION */}
+              <div className="grid grid-cols-2 gap-3">
+                {/* COLUMNA IZQUIERDA: INPUTS DE COSTO Y VENTA (Apilados) */}
+                <div className="space-y-2">
+                  <div className="space-y-1">
+                    <label className="text-[10px] font-black text-red-400 uppercase tracking-widest px-1 flex items-center gap-1">
+                      Costo {formData.sellingMode === 'package' ? 'Paquete' : ''}
+                    </label>
+                    <div className="flex gap-2">
+                      <div className="relative flex-1">
+                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
+                        <input
+                          type="number"
+                          step="0.01"
+                          className="w-full pl-6 pr-2 py-3 border-2 border-gray-100 rounded-xl bg-gray-50 focus:bg-white outline-none text-sm font-bold text-gray-900 focus:border-indigo-500 transition-all"
+                          value={formData.costPrice || ''}
+                          placeholder="0.00"
+                          onChange={e => setFormData({ ...formData, costPrice: parseFloat(e.target.value) || 0 })}
+                        />
+                      </div>
+                      <div className="bg-red-50 border border-red-100 rounded-xl px-2 flex flex-col justify-center min-w-[60px] text-right shrink-0">
+                        <span className="text-[8px] font-black text-red-300 uppercase">Bs</span>
+                        <span className="text-[10px] font-black text-red-800 leading-none truncate">
+                          {((formData.costPrice || 0) * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 2 })}
+                        </span>
+                      </div>
+                    </div>
+                  </div>
+
+                  <div className="space-y-1">
+                    <label className="text-[10px] font-black text-emerald-500 uppercase tracking-widest px-1 flex items-center gap-1">
+                      Venta {formData.sellingMode === 'package' ? 'Paquete' : ''}
+                    </label>
+                    <div className="flex gap-2">
+                      <div className="relative flex-1">
+                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
+                        <input
+                          type="number"
+                          step="0.01"
+                          className="w-full pl-6 pr-2 py-3 border-2 border-gray-100 rounded-xl bg-gray-50 focus:bg-white outline-none text-sm font-bold text-gray-900 focus:border-indigo-500 transition-all"
+                          value={formData.price || ''}
+                          placeholder="0.00"
+                          onChange={e => setFormData({ ...formData, price: parseFloat(e.target.value) || 0 })}
+                        />
+                      </div>
+                      <div className="bg-emerald-50 border border-emerald-100 rounded-xl px-2 flex flex-col justify-center min-w-[60px] text-right shrink-0">
+                        <span className="text-[8px] font-black text-emerald-300 uppercase">Bs</span>
+                        <span className="text-[10px] font-black text-emerald-600 leading-none truncate">
+                          {((formData.price || 0) * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 2 })}
+                        </span>
+                      </div>
+                    </div>
+                  </div>
+                </div>
+
+                {/* COLUMNA DERECHA: PANEL RENTABILIDAD */}
+                <div className="bg-indigo-50/50 p-2 rounded-xl border border-indigo-100 flex flex-col justify-center h-full">
+                  <h5 className="text-center text-[9px] font-black text-indigo-300 uppercase tracking-widest mb-2">
+                    Rentabilidad
+                  </h5>
+                  <div className="flex flex-col items-center justify-center flex-1 gap-1">
+                    {/* Utilidad */}
+                    <div className="text-center">
+                      <p className="text-[8px] font-bold text-gray-400 uppercase mb-0.5">Ganancia</p>
+                      <p className={`text-lg font-black ${profit > 0 ? 'text-emerald-600' : 'text-gray-400'}`}>${profit.toFixed(2)}</p>
+                    </div>
+
+                    {/* Divider Horizontal */}
+                    <div className="w-8 h-px bg-indigo-100 my-1"></div>
+
+                    {/* Margen */}
+                    <div className="text-center">
+                      <p className="text-[8px] font-bold text-gray-400 uppercase mb-0.5">Margen</p>
+                      <p className={`text-2xl font-black ${margin >= 30 ? 'text-emerald-500' : margin > 0 ? 'text-orange-400' : 'text-red-400'}`}>
+                        {margin.toFixed(0)}%
+                      </p>
+                    </div>
+                  </div>
+                </div>
+              </div>
+            </div>
+
+            {/* Resumen de Variante en el formulario principal */}
+            {formData.sellingMode !== 'simple' && (
+              <div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100 flex items-center gap-3">
+                <div className="bg-indigo-100 text-indigo-600 p-2 rounded-lg">
+                  {formData.sellingMode === 'weight' ? <Scale className="w-4 h-4" /> : <Box className="w-4 h-4" />}
+                </div>
+                <div className="text-xs">
+                  <span className="font-bold text-indigo-900 block">
+                    {formData.sellingMode === 'weight' ? `Venta por ${formData.measurementUnit}` : `Venta por Paquete (x${formData.unitsPerPackage})`}
+                  </span>
+                  {formData.sellingMode === 'package' && (
+                    <span className="text-indigo-500">Unidad suelta: ${formData.pricePerUnit?.toFixed(2)}</span>
+                  )}
+                </div>
+                <button type="button" onClick={() => setIsVariantConfigOpen(true)} className="ml-auto text-xs font-bold text-indigo-600 underline">Editar</button>
+              </div>
+            )}
+
+            <div className="pt-4 flex gap-3 mt-auto">
+              <button
+                type="button"
+                onClick={closeModal}
+                className="flex-1 py-4 border-2 border-gray-100 rounded-2xl font-bold text-gray-400 hover:bg-gray-50 transition-all active:scale-95"
+              >
+                Cancelar
+              </button>
+              <button
+                type="submit"
+                className="flex-1 py-4 bg-gray-900 text-white rounded-2xl font-black uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all"
+              >
+                {editingProduct ? 'Actualizar' : 'Guardar'}
+              </button>
+            </div>
+          </form>
         </div>
       )}
 
@@ -345,4 +742,9 @@ const Inventory: React.FC<InventoryProps> = ({ products, onAdd, onUpdate, onDele
   );
 };
 
+// Simple Info Icon component locally
+const InfoIcon = ({ className }: { className?: string }) => (
+  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>
+);
+
 export default Inventory;
diff --git a/components/POS.tsx b/components/POS.tsx
index 8badf6a..96e9fbd 100644
--- a/components/POS.tsx
+++ b/components/POS.tsx
@@ -1,597 +1,576 @@
-
 import React, { useState, useEffect } from 'react';
 import { Product, CartItem, Sale, Customer } from '../types';
-import { Search, Plus, Minus, Trash2, ShoppingCart, Users, Wallet, DollarSign, CreditCard, LayoutGrid, List, X, RefreshCw, TrendingUp, Smartphone, Banknote, UserPlus, Check, ArrowLeft, ShoppingBag } from '../constants';
+import { Search, Plus, Minus, Trash2, ShoppingCart, Users, Wallet, DollarSign, CreditCard, LayoutGrid, List, X, RefreshCw, TrendingUp, Smartphone, Banknote, UserPlus, Check, ArrowLeft, ShoppingBag, Calculator } from '../constants';
 
 interface POSProps {
-  products: Product[];
-  customers: Customer[];
-  exchangeRate: number;
-  onSale: (sale: Sale) => void;
-  onUpdateRate: (rate: number) => void;
-  onAddCustomer: (customer: Customer) => void;
-  onBackToDashboard: () => void;
-  initialCart?: CartItem[];
-  onCartLoaded?: () => void;
+    products: Product[];
+    customers: Customer[];
+    exchangeRate: number;
+    onSale: (sale: Sale) => void;
+    onUpdateRate: (rate: number) => void;
+    onAddCustomer: (customer: Customer) => void;
+    onBackToDashboard: () => void;
+    initialCart?: CartItem[];
+    onCartLoaded?: () => void;
 }
 
 const POS: React.FC<POSProps> = ({ products, customers, exchangeRate, onSale, onUpdateRate, onAddCustomer, onBackToDashboard, initialCart, onCartLoaded }) => {
-  const [searchTerm, setSearchTerm] = useState('');
-  const [cart, setCart] = useState<CartItem[]>([]);
-  const [showCartMobile, setShowCartMobile] = useState(false);
-  const [displayMode, setDisplayMode] = useState<'grid' | 'list'>('list');
-  
-  // Quick Rate Update State
-  const [isRateModalOpen, setIsRateModalOpen] = useState(false);
-  const [tempRate, setTempRate] = useState(exchangeRate.toString());
-
-  // Cash Payment / Change Calculator State
-  const [isCashModalOpen, setIsCashModalOpen] = useState(false);
-  const [tenderedAmount, setTenderedAmount] = useState('');
-
-  // Credit Customer Selection State
-  const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
-  const [customerSearchTerm, setCustomerSearchTerm] = useState('');
-  
-  // New Customer Form State
-  const [isCreatingCustomer, setIsCreatingCustomer] = useState(false);
-  const [newCustomerData, setNewCustomerData] = useState({ name: '', phone: '' });
-
-  // Load initial cart if provided (Edit Mode)
-  useEffect(() => {
-    if (initialCart && initialCart.length > 0) {
-        setCart(initialCart);
-        if (onCartLoaded) onCartLoaded();
-    }
-  }, [initialCart, onCartLoaded]);
-
-  const filteredProducts = products.filter(p => {
-    const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase());
-    return matchesSearch;
-  });
-
-  const filteredCustomers = customers.filter(c => 
-    c.name.toLowerCase().includes(customerSearchTerm.toLowerCase()) ||
-    c.phone.includes(customerSearchTerm)
-  );
-
-  const addToCart = (product: Product) => {
-    if (product.stock <= 0) return;
-    if (navigator.vibrate) navigator.vibrate(50);
-
-    setCart(prev => {
-      const existing = prev.find(item => item.id === product.id);
-      if (existing) {
-        if (existing.quantity >= product.stock) return prev;
-        return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
-      }
-      return [...prev, { ...product, quantity: 1 }];
+    const [searchTerm, setSearchTerm] = useState('');
+    const [cart, setCart] = useState<CartItem[]>([]);
+    const [showCartMobile, setShowCartMobile] = useState(false);
+
+    // Quick Rate Update State
+    const [isRateModalOpen, setIsRateModalOpen] = useState(false);
+    const [tempRate, setTempRate] = useState(exchangeRate.toString());
+
+    // Cash Payment / Change Calculator State
+    const [isCashModalOpen, setIsCashModalOpen] = useState(false);
+    const [tenderedAmount, setTenderedAmount] = useState('');
+
+    // Credit Customer Selection State
+    const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
+    const [customerSearchTerm, setCustomerSearchTerm] = useState('');
+
+    // New Customer Form State
+    const [isCreatingCustomer, setIsCreatingCustomer] = useState(false);
+    const [newCustomerData, setNewCustomerData] = useState({ name: '', phone: '' });
+
+    // Load initial cart if provided (Edit Mode)
+    useEffect(() => {
+        if (initialCart && initialCart.length > 0) {
+            setCart(initialCart);
+            if (onCartLoaded) onCartLoaded();
+        }
+    }, [initialCart, onCartLoaded]);
+
+    // Sync tempRate when prop changes (from Settings or App state)
+    useEffect(() => {
+        setTempRate(exchangeRate.toString());
+    }, [exchangeRate]);
+
+    const filteredProducts = products.filter(p => {
+        const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase());
+        return matchesSearch;
     });
-  };
 
-  const removeFromCart = (productId: string) => {
-    setCart(prev => prev.filter(item => item.id !== productId));
-  };
+    const filteredCustomers = customers.filter(c =>
+        c.name.toLowerCase().includes(customerSearchTerm.toLowerCase()) ||
+        c.phone.includes(customerSearchTerm)
+    );
+
+    const addToCart = (product: Product) => {
+        // Calculamos si ya alcanzamos el l├¡mite basado en el estado actual del carrito
+        const currentInCart = cart.find(item => item.id === product.id)?.quantity || 0;
+        if (currentInCart >= product.stock) return;
+
+        if (navigator.vibrate) navigator.vibrate(50);
+
+        setCart(prev => {
+            const existing = prev.find(item => item.id === product.id);
+            if (existing) {
+                return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
+            }
+            return [...prev, { ...product, quantity: 1 }];
+        });
+    };
 
-  const updateQuantity = (productId: string, delta: number) => {
-    setCart(prev => prev.map(item => {
-      if (item.id === productId) {
-        const newQuantity = Math.max(1, Math.min(item.quantity + delta, item.stock));
-        return { ...item, quantity: newQuantity };
-      }
-      return item;
-    }));
-  };
+    const removeFromCart = (productId: string) => {
+        setCart(prev => prev.filter(item => item.id !== productId));
+    };
+
+    const updateQuantity = (productId: string, delta: number) => {
+        setCart(prev => prev.map(item => {
+            if (item.id === productId) {
+                const newQuantity = Math.max(1, Math.min(item.quantity + delta, item.stock));
+                return { ...item, quantity: newQuantity };
+            }
+            return item;
+        }));
+    };
 
-  const calculateTotal = () => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
+    const calculateTotal = () => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
 
-  const initiateSale = (method: 'Cash' | 'Card' | 'Credit' | 'PagoMovil') => {
-    if (cart.length === 0) return;
+    const initiateSale = (method: 'Cash' | 'Card' | 'Credit' | 'PagoMovil') => {
+        if (cart.length === 0) return;
 
-    if (method === 'Cash') {
+        if (method === 'Credit') {
+            setIsCustomerModalOpen(true);
+            return;
+        }
+
+        // For Cash, Card, PagoMovil -> Process immediately
+        processSale(method);
+    };
+
+    const openCashCalculator = (e: React.MouseEvent) => {
+        e.stopPropagation();
+        if (cart.length === 0) return;
         setTenderedAmount('');
         setIsCashModalOpen(true);
-        return;
-    }
-
-    if (method === 'Credit') {
-        setIsCustomerModalOpen(true);
-        return;
-    }
-
-    // For other methods, process immediately
-    processSale(method);
-  };
-
-  const processSale = (method: 'Cash' | 'Card' | 'Credit' | 'PagoMovil', customerId?: string) => {
-    const sale: Sale = {
-      id: Date.now().toString(),
-      timestamp: Date.now(),
-      items: cart,
-      total: calculateTotal(),
-      exchangeRate: exchangeRate,
-      paymentMethod: method,
-      customerId: customerId
     };
 
-    onSale(sale);
-    setCart([]);
-    setIsCustomerModalOpen(false);
-    setIsCashModalOpen(false);
-  };
-
-  // Helper for mobile cart visibility
-  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
-
-  // Cash Calculation Helpers
-  const totalBs = calculateTotal() * exchangeRate;
-  const tenderedBs = parseFloat(tenderedAmount) || 0;
-  const changeBs = tenderedBs - totalBs;
-  const isSufficient = tenderedBs >= totalBs - 0.01; // Small epsilon for float logic
-
-  const handleCreateCustomer = (e: React.FormEvent) => {
-    e.preventDefault();
-    const newCustomer: Customer = {
-      id: Math.random().toString(36).substr(2, 9),
-      name: newCustomerData.name,
-      phone: newCustomerData.phone,
-      balance: 0,
-      createdAt: Date.now()
+    const processSale = (method: 'Cash' | 'Card' | 'Credit' | 'PagoMovil', customerId?: string) => {
+        const sale: Sale = {
+            id: Date.now().toString(),
+            timestamp: Date.now(),
+            items: cart,
+            total: calculateTotal(),
+            exchangeRate: exchangeRate,
+            paymentMethod: method,
+            customerId: customerId
+        };
+
+        onSale(sale);
+        setCart([]);
+        setIsCustomerModalOpen(false);
+        setIsCashModalOpen(false);
     };
-    onAddCustomer(newCustomer);
-    setIsCreatingCustomer(false);
-    setNewCustomerData({ name: '', phone: '' });
-    // Process sale immediately with new customer
-    processSale('Credit', newCustomer.id);
-  };
-
-  return (
-    <div className="flex flex-col lg:flex-row gap-4 h-[calc(100vh-60px)] md:h-[calc(100vh-60px)]">
-      
-      {/* LEFT: Product Catalog */}
-      <div className="flex-1 flex flex-col gap-4 overflow-hidden">
-        
-        {/* Search Bar */}
-        <div className="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm shrink-0">
-          <div className="flex items-center gap-3">
-            <div className="relative flex-1">
-                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
-                <input
-                autoFocus
-                type="text"
-                placeholder="Buscar producto..."
-                className="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-base font-bold text-gray-900 outline-none focus:border-indigo-500 transition-all placeholder:text-gray-300"
-                value={searchTerm}
-                onChange={(e) => setSearchTerm(e.target.value)}
-                />
-                {searchTerm && (
-                <button onClick={() => setSearchTerm('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 p-1 hover:bg-gray-200 rounded-full">
-                    <X className="w-4 h-4"/>
-                </button>
-                )}
-            </div>
 
-            {/* View Toggle */}
-            <div className="flex gap-1 bg-gray-100 p-1 rounded-2xl shrink-0 h-full items-center">
-                <button 
-                    onClick={() => setDisplayMode('list')}
-                    className={`p-3 rounded-xl transition-all ${displayMode === 'list' ? 'bg-white shadow-sm text-indigo-600' : 'text-gray-400'}`}
-                >
-                    <List className="w-5 h-5" />
-                </button>
-                <button 
-                    onClick={() => setDisplayMode('grid')}
-                    className={`p-3 rounded-xl transition-all ${displayMode === 'grid' ? 'bg-white shadow-sm text-indigo-600' : 'text-gray-400'}`}
-                >
-                    <LayoutGrid className="w-5 h-5" />
-                </button>
-            </div>
+    // Helper for mobile cart visibility
+    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
+
+    // Cash Calculation Helpers
+    const totalBs = calculateTotal() * exchangeRate;
+    const tenderedBs = parseFloat(tenderedAmount) || 0;
+    const changeBs = tenderedBs - totalBs;
+    const isSufficient = tenderedBs >= totalBs - 0.01; // Small epsilon for float logic
+
+    const handleCreateCustomer = (e: React.FormEvent) => {
+        e.preventDefault();
+        const newCustomer: Customer = {
+            id: Math.random().toString(36).substr(2, 9),
+            name: newCustomerData.name,
+            phone: newCustomerData.phone,
+            balance: 0,
+            createdAt: Date.now()
+        };
+        onAddCustomer(newCustomer);
+        setIsCreatingCustomer(false);
+        setNewCustomerData({ name: '', phone: '' });
+        // Process sale immediately with new customer
+        processSale('Credit', newCustomer.id);
+    };
 
-            {/* Close Button Next to Search */}
-            <button 
-                onClick={onBackToDashboard}
-                className="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition-colors active:scale-95 border border-red-100 shrink-0"
-                title="Cancelar Venta"
-            >
-                <X className="w-6 h-6" />
-            </button>
-          </div>
-        </div>
+    return (
+        <div className="flex flex-col lg:flex-row gap-4 h-[calc(100vh-20px)] md:h-[calc(100vh-20px)] pt-2">
+
+            {/* LEFT: Product Catalog */}
+            <div className="flex-1 flex flex-col gap-4 overflow-hidden">
+
+                {/* Search Bar */}
+                <div className="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm shrink-0">
+                    <div className="flex items-center gap-3">
+                        <div className="relative flex-1">
+                            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
+                            <input
+                                autoFocus
+                                type="text"
+                                placeholder="Buscar producto..."
+                                className="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-base font-bold text-gray-900 outline-none focus:border-indigo-500 transition-all placeholder:text-gray-300"
+                                value={searchTerm}
+                                onChange={(e) => setSearchTerm(e.target.value)}
+                            />
+                            {searchTerm && (
+                                <button onClick={() => setSearchTerm('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 p-1 hover:bg-gray-200 rounded-full">
+                                    <X className="w-4 h-4" />
+                                </button>
+                            )}
+                        </div>
 
-        {/* Product Grid/List */}
-        <div className="flex-1 overflow-y-auto min-h-0 pr-1">
-          {displayMode === 'grid' ? (
-             <div className="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-3">
-                {filteredProducts.map(product => {
-                    // Calculamos cantidad en carrito
-                    const qtyInCart = cart.find(i => i.id === product.id)?.quantity || 0;
-                    
-                    return (
+                        {/* Close Button Next to Search */}
                         <button
-                            key={product.id}
-                            onClick={() => addToCart(product)}
-                            disabled={product.stock === 0}
-                            className={`relative p-4 rounded-[2rem] text-left transition-all active:scale-95 group overflow-hidden border-2 flex flex-col justify-between ${
-                                product.stock === 0 ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-100 hover:border-indigo-200 shadow-sm hover:shadow-md'
-                            }`}
+                            onClick={onBackToDashboard}
+                            className="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition-colors active:scale-95 border border-red-100 shrink-0"
+                            title="Cancelar Venta"
                         >
-                            {/* Quantity Badge in Grid */}
-                            {qtyInCart > 0 && (
-                                <div className="absolute top-3 right-3 bg-indigo-600 text-white w-7 h-7 flex items-center justify-center rounded-full text-xs font-black shadow-lg border-2 border-white z-20 animate-bounce-in">
-                                    {qtyInCart}
-                                </div>
-                            )}
+                            <X className="w-6 h-6" />
+                        </button>
+                    </div>
+                </div>
 
-                            <div>
-                                <div className="aspect-square rounded-2xl bg-gray-100 mb-3 relative overflow-hidden">
-                                    <img src={product.image} alt={product.name} className="w-full h-full object-cover mix-blend-multiply" />
-                                    {product.stock === 0 && (
-                                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
-                                            <span className="bg-red-500 text-white text-[10px] font-black px-2 py-1 rounded-lg uppercase tracking-wider">Agotado</span>
+                {/* Product List */}
+                <div className="flex-1 overflow-y-auto min-h-0 pr-1 pb-20 lg:pb-0">
+                    <div className="flex flex-col gap-2">
+                        {filteredProducts.map(product => {
+                            const qtyInCart = cart.find(i => i.id === product.id)?.quantity || 0;
+                            const currentStock = Math.max(0, product.stock - qtyInCart);
+
+                            return (
+                                <button
+                                    key={product.id}
+                                    onClick={() => addToCart(product)}
+                                    disabled={currentStock === 0}
+                                    className={`flex items-center gap-4 p-4 rounded-2xl border-2 transition-all active:scale-[0.98] ${currentStock === 0 ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-50 hover:border-indigo-100 shadow-sm'
+                                        }`}
+                                >
+                                    <div className="flex-1 text-left">
+                                        <h3 className="font-bold text-gray-900 leading-tight">{product.name}</h3>
+                                        <p className="text-[10px] font-bold text-gray-400 uppercase">{product.category}</p>
+                                    </div>
+
+                                    {/* Stock Middle */}
+                                    <div className="text-center w-24">
+                                        <span className={`text-xs font-black ${currentStock === 0 ? 'text-red-400' : 'text-gray-400'}`}>
+                                            {currentStock === 0 ? 'Agotado' : `${currentStock} Unds.`}
+                                        </span>
+                                    </div>
+
+                                    {/* Price Layout */}
+                                    <div className="text-right flex flex-col items-end w-24">
+                                        <p className="font-black text-gray-900 text-lg leading-none">{(product.price * exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+                                        <p className="text-[10px] font-bold text-indigo-400 mt-0.5">Ref: ${product.price.toFixed(2)}</p>
+                                    </div>
+
+                                    {qtyInCart > 0 && (
+                                        <div className="bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-full text-xs font-black shadow-sm shrink-0">
+                                            {qtyInCart}
                                         </div>
                                     )}
-                                    <div className="absolute bottom-2 right-2 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-lg text-[10px] font-black shadow-sm text-gray-700">
-                                        Stock: {product.stock}
+                                </button>
+                            );
+                        })}
+                    </div>
+                </div>
+            </div>
+
+            {/* RIGHT: Shopping Cart */}
+            <div className={`fixed inset-0 z-50 lg:static lg:z-auto bg-white/95 backdrop-blur-xl lg:bg-white lg:backdrop-blur-none lg:w-96 lg:rounded-[2.5rem] lg:border-2 lg:border-gray-100 lg:shadow-xl transition-transform duration-300 flex flex-col ${showCartMobile ? 'translate-y-0' : 'translate-y-full lg:translate-y-0'}`}>
+
+                {/* Mobile Handle */}
+                <div className="lg:hidden flex justify-center pt-3 pb-1" onClick={() => setShowCartMobile(false)}>
+                    <div className="w-12 h-1.5 bg-gray-300 rounded-full"></div>
+                </div>
+
+                <div className="p-6 flex-1 flex flex-col min-h-0">
+                    <div className="flex items-center justify-between mb-4">
+                        <div className="flex items-center gap-3">
+                            <div className="bg-indigo-100 p-2.5 rounded-xl text-indigo-600">
+                                <ShoppingCart className="w-6 h-6" />
+                            </div>
+                            <div>
+                                <div className="flex items-center gap-2">
+                                    <h3 className="text-lg font-black text-gray-900">Carrito</h3>
+                                    {/* Editable Rate Badge */}
+                                    <div className="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-lg border border-gray-200 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 transition-all">
+                                        <TrendingUp className="w-3 h-3 text-gray-500" />
+                                        <input
+                                            className="w-12 bg-transparent text-xs font-black text-gray-900 outline-none text-right p-0 border-none"
+                                            type="number"
+                                            value={tempRate}
+                                            onChange={(e) => setTempRate(e.target.value)}
+                                            onBlur={() => {
+                                                const r = parseFloat(tempRate);
+                                                if (r > 0) onUpdateRate(r);
+                                                else setTempRate(exchangeRate.toString());
+                                            }}
+                                        />
+                                        <span className="text-[10px] font-bold text-gray-400">Bs</span>
                                     </div>
                                 </div>
-                                <h3 className="font-bold text-gray-800 text-sm leading-tight mb-2 line-clamp-2 min-h-[2.5em]">{product.name}</h3>
+                                <p className="text-xs font-medium text-gray-400">{cart.length} productos</p>
                             </div>
-                            
-                            {/* Updated Price Layout for Grid */}
-                            <div className="flex flex-col">
-                                <p className="text-indigo-600 font-black text-lg leading-none">${product.price.toFixed(2)}</p>
-                                <p className="text-[10px] font-bold text-gray-400 mt-0.5">{(product.price * exchangeRate).toFixed(2)} Bs</p>
+                        </div>
+                        {cart.length > 0 && (
+                            <button onClick={() => setCart([])} className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-xl transition-colors">
+                                <Trash2 className="w-5 h-5" />
+                            </button>
+                        )}
+                    </div>
+
+                    {/* Header de Columnas */}
+                    {cart.length > 0 && (
+                        <div className="flex justify-between px-3 mb-2">
+                            <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest">Producto</span>
+                            <div className="flex gap-4">
+                                <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest text-center w-20">Cant</span>
+                                <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest text-right w-16">Subtotal</span>
                             </div>
-                        </button>
-                    );
-                })}
-             </div>
-          ) : (
-              <div className="flex flex-col gap-2">
-                 {filteredProducts.map(product => {
-                    const qtyInCart = cart.find(i => i.id === product.id)?.quantity || 0;
-                    
-                    return (
-                        <button
-                            key={product.id}
-                            onClick={() => addToCart(product)}
-                            disabled={product.stock === 0}
-                            className={`flex items-center gap-4 p-3 rounded-2xl border-2 transition-all active:scale-[0.98] ${
-                                product.stock === 0 ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-50 hover:border-indigo-100 shadow-sm'
-                            }`}
-                        >
-                            <div className="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden shrink-0 relative">
-                                <img src={product.image} className="w-full h-full object-cover" />
-                                {/* Quantity Badge in List */}
-                                {qtyInCart > 0 && (
-                                    <div className="absolute top-0 right-0 bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-bl-lg text-xs font-black shadow-sm">
-                                        {qtyInCart}
+                        </div>
+                    )}
+
+                    <div className="flex-1 overflow-y-auto space-y-2 pr-1 -mr-1">
+                        {cart.length === 0 ? (
+                            <div className="h-full flex flex-col items-center justify-center text-center opacity-40 space-y-4">
+                                <ShoppingBag className="w-16 h-16 text-gray-300" />
+                                <p className="font-bold text-gray-400 text-sm">El carrito est├í vac├¡o</p>
+                            </div>
+                        ) : (
+                            cart.map(item => (
+                                <div key={item.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-2xl group border border-transparent hover:border-gray-100 transition-colors">
+                                    {/* Producto */}
+                                    <div className="flex items-center gap-3 flex-1 min-w-0">
+                                        <div className="min-w-0">
+                                            <h4 className="font-bold text-gray-900 text-xs truncate max-w-[100px]">{item.name}</h4>
+                                            <p className="text-[9px] font-bold text-gray-400">${item.price.toFixed(2)}</p>
+                                        </div>
+                                    </div>
+
+                                    {/* Controles + Subtotal */}
+                                    <div className="flex items-center gap-2">
+                                        <div className="flex items-center gap-1 bg-white rounded-lg p-0.5 shadow-sm border border-gray-200">
+                                            <button onClick={() => updateQuantity(item.id, -1)} className="w-6 h-6 flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500">
+                                                {item.quantity === 1 ? <Trash2 className="w-3 h-3 text-red-400" /> : <Minus className="w-3 h-3" />}
+                                            </button>
+                                            <span className="font-black text-xs w-5 text-center">{item.quantity}</span>
+                                            <button onClick={() => updateQuantity(item.id, 1)} className="w-6 h-6 flex items-center justify-center rounded-md bg-gray-900 text-white shadow-sm">
+                                                <Plus className="w-3 h-3" />
+                                            </button>
+                                        </div>
+                                        <div className="text-right w-16">
+                                            <p className="text-xs font-black text-gray-900">{(item.price * item.quantity * exchangeRate).toFixed(2)}</p>
+                                            <p className="text-[9px] font-bold text-gray-400">${(item.price * item.quantity).toFixed(2)}</p>
+                                        </div>
                                     </div>
-                                )}
+                                </div>
+                            ))
+                        )}
+                    </div>
+
+                    {/* Footer Calculations */}
+                    <div className="mt-6 space-y-4">
+                        <div className="bg-gray-50 p-5 rounded-2xl border border-gray-100">
+                            {/* Total BS - Arriba y Grande */}
+                            <div className="flex justify-between items-center mb-1">
+                                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Total BS</span>
+                                <span className="text-xl font-black text-gray-900">{(calculateTotal() * exchangeRate).toFixed(2)} Bs</span>
                             </div>
-                            <div className="flex-1 text-left">
-                                <h3 className="font-bold text-gray-900 leading-tight">{product.name}</h3>
-                                <p className="text-xs text-gray-400 font-medium">{product.stock} Unds.</p>
+                            {/* Total USD - Abajo y Peque├▒o */}
+                            <div className="flex justify-between items-center">
+                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ref USD</span>
+                                <span className="text-sm font-black text-indigo-600">${calculateTotal().toFixed(2)}</span>
                             </div>
-                            
-                            {/* Updated Price Layout for List - Removed Plus Button */}
-                            <div className="text-right flex flex-col items-end">
-                                 <p className="font-black text-indigo-600 text-lg leading-none">${product.price.toFixed(2)}</p>
-                                 <p className="text-xs font-bold text-gray-400 mt-1">{(product.price * exchangeRate).toFixed(2)} Bs</p>
+                        </div>
+
+                        <div className="grid grid-cols-2 gap-2">
+                            {/* Bot├│n Efectivo con opci├│n de Calculadora */}
+                            <div className="relative">
+                                <button
+                                    disabled={cart.length === 0}
+                                    onClick={() => initiateSale('Cash')}
+                                    className="w-full h-full p-4 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-emerald-100 active:scale-95"
+                                >
+                                    <Banknote className="w-6 h-6" />
+                                    <span className="text-[10px] font-black uppercase">Efectivo</span>
+                                </button>
+                                <button
+                                    disabled={cart.length === 0}
+                                    onClick={openCashCalculator}
+                                    className="absolute top-1 right-1 p-3 bg-emerald-200/50 hover:bg-emerald-200 text-emerald-800 rounded-xl transition-colors disabled:opacity-0 active:scale-95"
+                                    title="Calcular Vuelto"
+                                >
+                                    <Calculator className="w-5 h-5" />
+                                </button>
                             </div>
-                        </button>
-                    );
-                 })}
-              </div>
-          )}
-        </div>
-      </div>
-
-      {/* RIGHT: Shopping Cart */}
-      <div className={`fixed inset-0 z-50 lg:static lg:z-auto bg-white/95 backdrop-blur-xl lg:bg-white lg:backdrop-blur-none lg:w-96 lg:rounded-[2.5rem] lg:border-2 lg:border-gray-100 lg:shadow-xl transition-transform duration-300 flex flex-col ${showCartMobile ? 'translate-y-0' : 'translate-y-full lg:translate-y-0'}`}>
-        
-        {/* Mobile Handle */}
-        <div className="lg:hidden flex justify-center pt-3 pb-1" onClick={() => setShowCartMobile(false)}>
-           <div className="w-12 h-1.5 bg-gray-300 rounded-full"></div>
-        </div>
 
-        <div className="p-6 flex-1 flex flex-col min-h-0">
-            <div className="flex items-center justify-between mb-4">
-                <div className="flex items-center gap-3">
-                    <div className="bg-indigo-100 p-2.5 rounded-xl text-indigo-600">
-                        <ShoppingCart className="w-6 h-6" />
-                    </div>
-                    <div>
-                        <h3 className="text-lg font-black text-gray-900">Carrito</h3>
-                        <p className="text-xs font-medium text-gray-400">{cart.length} productos</p>
+                            <button
+                                disabled={cart.length === 0}
+                                onClick={() => initiateSale('PagoMovil')}
+                                className="p-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-blue-100 active:scale-95"
+                            >
+                                <Smartphone className="w-6 h-6" />
+                                <span className="text-[10px] font-black uppercase">Pago M├│vil</span>
+                            </button>
+                            <button
+                                disabled={cart.length === 0}
+                                onClick={() => initiateSale('Card')}
+                                className="p-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-gray-200 active:scale-95"
+                            >
+                                <CreditCard className="w-6 h-6" />
+                                <span className="text-[10px] font-black uppercase">Tarjeta</span>
+                            </button>
+                            <button
+                                disabled={cart.length === 0}
+                                onClick={() => initiateSale('Credit')}
+                                className="p-4 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-orange-100 active:scale-95"
+                            >
+                                <Wallet className="w-6 h-6" />
+                                <span className="text-[10px] font-black uppercase">Cr├®dito</span>
+                            </button>
+                        </div>
                     </div>
                 </div>
-                {cart.length > 0 && (
-                    <button onClick={() => setCart([])} className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-xl transition-colors">
-                        <Trash2 className="w-5 h-5" />
-                    </button>
-                )}
             </div>
 
-            {/* Header de Columnas */}
-            {cart.length > 0 && (
-                <div className="flex justify-between px-3 mb-2">
-                    <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest">Producto</span>
-                    <div className="flex gap-4">
-                         <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest text-center w-20">Cant</span>
-                         <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest text-right w-16">Subtotal</span>
+            {/* Floating Action Button for Mobile Cart */}
+            {!showCartMobile && totalItems > 0 && (
+                <button
+                    onClick={() => setShowCartMobile(true)}
+                    className="lg:hidden fixed bottom-6 right-6 bg-gray-900 text-white p-4 rounded-full shadow-2xl shadow-indigo-500/30 flex items-center gap-2 z-40 animate-bounce-in"
+                >
+                    <div className="relative">
+                        <ShoppingCart className="w-6 h-6" />
+                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-gray-900">{totalItems}</span>
                     </div>
-                </div>
+                    <span className="font-black pr-2">{(calculateTotal() * exchangeRate).toFixed(2)} Bs</span>
+                </button>
             )}
 
-            <div className="flex-1 overflow-y-auto space-y-2 pr-1 -mr-1">
-                {cart.length === 0 ? (
-                    <div className="h-full flex flex-col items-center justify-center text-center opacity-40 space-y-4">
-                        <ShoppingBag className="w-16 h-16 text-gray-300" />
-                        <p className="font-bold text-gray-400 text-sm">El carrito est├í vac├¡o</p>
-                    </div>
-                ) : (
-                    cart.map(item => (
-                        <div key={item.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-2xl group border border-transparent hover:border-gray-100 transition-colors">
-                            {/* Producto */}
-                            <div className="flex items-center gap-3 flex-1 min-w-0">
-                                <div className="w-10 h-10 bg-white rounded-xl overflow-hidden shadow-sm shrink-0">
-                                    <img src={item.image} className="w-full h-full object-cover" />
-                                </div>
-                                <div className="min-w-0">
-                                    <h4 className="font-bold text-gray-900 text-xs truncate max-w-[100px]">{item.name}</h4>
-                                    <p className="text-[9px] font-bold text-gray-400">${item.price.toFixed(2)}</p>
-                                </div>
+            {/* MODAL DE PAGO EFECTIVO Y VUELTO */}
+            {isCashModalOpen && (
+                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
+                    <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm overflow-hidden animate-scale-up">
+                        <div className="p-6 text-center border-b border-gray-100">
+                            <h3 className="font-black text-gray-900 text-lg">Pago en Efectivo</h3>
+                            <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Calculadora de Vuelto</p>
+                        </div>
+
+                        <div className="p-6 space-y-6">
+                            {/* Total Amount Display */}
+                            <div className="text-center">
+                                <p className="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Total a Pagar</p>
+                                <p className="text-4xl font-black text-gray-900">{totalBs.toFixed(2)} Bs</p>
+                                <p className="text-sm font-bold text-indigo-600 mt-1">${calculateTotal().toFixed(2)}</p>
                             </div>
 
-                            {/* Controles + Subtotal */}
-                            <div className="flex items-center gap-2">
-                                <div className="flex items-center gap-1 bg-white rounded-lg p-0.5 shadow-sm border border-gray-200">
-                                    <button onClick={() => updateQuantity(item.id, -1)} className="w-6 h-6 flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500">
-                                        {item.quantity === 1 ? <Trash2 className="w-3 h-3 text-red-400" /> : <Minus className="w-3 h-3" />}
-                                    </button>
-                                    <span className="font-black text-xs w-5 text-center">{item.quantity}</span>
-                                    <button onClick={() => updateQuantity(item.id, 1)} className="w-6 h-6 flex items-center justify-center rounded-md bg-gray-900 text-white shadow-sm">
-                                        <Plus className="w-3 h-3" />
-                                    </button>
+                            {/* Input Tendered Amount */}
+                            <div className="space-y-2">
+                                <label className="text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Monto Recibido (Bs)</label>
+                                <div className="relative">
+                                    <Banknote className="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-500 w-6 h-6" />
+                                    <input
+                                        autoFocus
+                                        type="number"
+                                        step="0.01"
+                                        value={tenderedAmount}
+                                        onChange={(e) => setTenderedAmount(e.target.value)}
+                                        placeholder="0.00"
+                                        className="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-2xl font-black text-gray-800 outline-none focus:border-emerald-500 focus:bg-white transition-all placeholder:text-gray-300"
+                                    />
                                 </div>
-                                <div className="text-right w-16">
-                                    <p className="text-xs font-black text-gray-900">{(item.price * item.quantity * exchangeRate).toFixed(2)}</p>
-                                    <p className="text-[9px] font-bold text-gray-400">${(item.price * item.quantity).toFixed(2)}</p>
+                            </div>
+
+                            {/* Change Calculation */}
+                            <div className={`p-4 rounded-2xl border-2 transition-all ${isSufficient ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}`}>
+                                <div className="flex justify-between items-center">
+                                    <span className={`text-xs font-black uppercase tracking-widest ${isSufficient ? 'text-emerald-600' : 'text-red-500'}`}>
+                                        {isSufficient ? 'Vuelto / Cambio' : 'Faltante'}
+                                    </span>
+                                    <span className={`text-2xl font-black ${isSufficient ? 'text-emerald-700' : 'text-red-600'}`}>
+                                        {Math.abs(changeBs).toFixed(2)} Bs
+                                    </span>
                                 </div>
                             </div>
-                        </div>
-                    ))
-                )}
-            </div>
 
-            {/* Footer Calculations */}
-            <div className="mt-6 space-y-4">
-                <div className="bg-gray-50 p-5 rounded-2xl border border-gray-100">
-                    {/* Total BS - Arriba y Grande */}
-                    <div className="flex justify-between items-center mb-1">
-                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Total BS</span>
-                        <span className="text-xl font-black text-gray-900">{(calculateTotal() * exchangeRate).toFixed(2)} Bs</span>
-                    </div>
-                    {/* Total USD - Abajo y Peque├▒o */}
-                    <div className="flex justify-between items-center">
-                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ref USD</span>
-                        <span className="text-sm font-black text-indigo-600">${calculateTotal().toFixed(2)}</span>
+                            {/* Actions */}
+                            <div className="flex gap-3 pt-2">
+                                <button
+                                    onClick={() => setIsCashModalOpen(false)}
+                                    className="flex-1 py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-all hover:bg-gray-200"
+                                >
+                                    Cancelar
+                                </button>
+                                <button
+                                    onClick={() => processSale('Cash')}
+                                    disabled={!isSufficient}
+                                    className="flex-1 py-4 bg-gray-900 text-white font-black uppercase tracking-widest text-xs rounded-2xl shadow-xl active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
+                                >
+                                    <Check className="w-4 h-4" /> Confirmar
+                                </button>
+                            </div>
+                        </div>
                     </div>
                 </div>
+            )}
 
-                <div className="grid grid-cols-2 gap-2">
-                    <button 
-                        disabled={cart.length === 0}
-                        onClick={() => initiateSale('Cash')}
-                        className="p-4 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-emerald-100 active:scale-95"
-                    >
-                        <Banknote className="w-6 h-6" />
-                        <span className="text-[10px] font-black uppercase">Efectivo</span>
-                    </button>
-                    <button 
-                        disabled={cart.length === 0}
-                        onClick={() => initiateSale('PagoMovil')}
-                        className="p-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-blue-100 active:scale-95"
-                    >
-                        <Smartphone className="w-6 h-6" />
-                        <span className="text-[10px] font-black uppercase">Pago M├│vil</span>
-                    </button>
-                    <button 
-                        disabled={cart.length === 0}
-                        onClick={() => initiateSale('Card')}
-                        className="p-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-gray-200 active:scale-95"
-                    >
-                        <CreditCard className="w-6 h-6" />
-                        <span className="text-[10px] font-black uppercase">Tarjeta</span>
-                    </button>
-                    <button 
-                        disabled={cart.length === 0}
-                        onClick={() => initiateSale('Credit')}
-                        className="p-4 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-orange-100 active:scale-95"
-                    >
-                        <Wallet className="w-6 h-6" />
-                        <span className="text-[10px] font-black uppercase">Cr├®dito</span>
-                    </button>
-                </div>
-            </div>
-        </div>
-      </div>
-
-      {/* Floating Action Button for Mobile Cart */}
-      {!showCartMobile && totalItems > 0 && (
-          <button 
-            onClick={() => setShowCartMobile(true)}
-            className="lg:hidden fixed bottom-6 right-6 bg-gray-900 text-white p-4 rounded-full shadow-2xl shadow-indigo-500/30 flex items-center gap-2 z-40 animate-bounce-in"
-          >
-             <div className="relative">
-                <ShoppingCart className="w-6 h-6" />
-                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-gray-900">{totalItems}</span>
-             </div>
-             <span className="font-black pr-2">{(calculateTotal() * exchangeRate).toFixed(2)} Bs</span>
-          </button>
-      )}
-
-      {/* MODAL DE PAGO EFECTIVO Y VUELTO */}
-      {isCashModalOpen && (
-         <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
-           <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm overflow-hidden animate-scale-up">
-              <div className="p-6 text-center border-b border-gray-100">
-                  <h3 className="font-black text-gray-900 text-lg">Pago en Efectivo</h3>
-                  <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Calculadora de Vuelto</p>
-              </div>
-              
-              <div className="p-6 space-y-6">
-                  {/* Total Amount Display */}
-                  <div className="text-center">
-                      <p className="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Total a Pagar</p>
-                      <p className="text-4xl font-black text-gray-900">{totalBs.toFixed(2)} Bs</p>
-                      <p className="text-sm font-bold text-indigo-600 mt-1">${calculateTotal().toFixed(2)}</p>
-                  </div>
-
-                  {/* Input Tendered Amount */}
-                  <div className="space-y-2">
-                       <label className="text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Monto Recibido (Bs)</label>
-                       <div className="relative">
-                          <Banknote className="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-500 w-6 h-6"/>
-                          <input 
-                              autoFocus
-                              type="number" 
-                              step="0.01"
-                              value={tenderedAmount}
-                              onChange={(e) => setTenderedAmount(e.target.value)}
-                              placeholder="0.00"
-                              className="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-2xl font-black text-gray-800 outline-none focus:border-emerald-500 focus:bg-white transition-all placeholder:text-gray-300"
-                          />
-                       </div>
-                  </div>
-
-                  {/* Change Calculation */}
-                  <div className={`p-4 rounded-2xl border-2 transition-all ${isSufficient ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}`}>
-                      <div className="flex justify-between items-center">
-                          <span className={`text-xs font-black uppercase tracking-widest ${isSufficient ? 'text-emerald-600' : 'text-red-500'}`}>
-                              {isSufficient ? 'Vuelto / Cambio' : 'Faltante'}
-                          </span>
-                          <span className={`text-2xl font-black ${isSufficient ? 'text-emerald-700' : 'text-red-600'}`}>
-                              {Math.abs(changeBs).toFixed(2)} Bs
-                          </span>
-                      </div>
-                  </div>
-
-                  {/* Actions */}
-                  <div className="flex gap-3 pt-2">
-                      <button 
-                          onClick={() => setIsCashModalOpen(false)}
-                          className="flex-1 py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-all hover:bg-gray-200"
-                      >
-                          Cancelar
-                      </button>
-                      <button 
-                          onClick={() => processSale('Cash')}
-                          disabled={!isSufficient}
-                          className="flex-1 py-4 bg-gray-900 text-white font-black uppercase tracking-widest text-xs rounded-2xl shadow-xl active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
-                      >
-                          <Check className="w-4 h-4" /> Confirmar
-                      </button>
-                  </div>
-              </div>
-           </div>
-         </div>
-      )}
-
-      {/* Credit Sale Modal */}
-      {isCustomerModalOpen && (
-        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
-          <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-up">
-             <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
-                 <h3 className="font-black text-gray-900 text-lg">Asignar a Cliente</h3>
-                 <button onClick={() => setIsCustomerModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X className="w-6 h-6"/></button>
-             </div>
-             
-             <div className="p-6">
-                {!isCreatingCustomer ? (
-                    <>
-                        <div className="relative mb-4">
-                           <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
-                           <input 
-                              autoFocus
-                              placeholder="Buscar cliente..." 
-                              className="w-full pl-10 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500"
-                              value={customerSearchTerm}
-                              onChange={(e) => setCustomerSearchTerm(e.target.value)}
-                           />
+            {/* Credit Sale Modal */}
+            {isCustomerModalOpen && (
+                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
+                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-up">
+                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
+                            <h3 className="font-black text-gray-900 text-lg">Asignar a Cliente</h3>
+                            <button onClick={() => setIsCustomerModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X className="w-6 h-6" /></button>
                         </div>
-                        
-                        <div className="max-h-60 overflow-y-auto space-y-2 mb-4">
-                            {filteredCustomers.map(c => (
-                                <button 
-                                    key={c.id} 
-                                    onClick={() => processSale('Credit', c.id)}
-                                    className="w-full p-3 text-left hover:bg-indigo-50 rounded-xl flex items-center justify-between group transition-colors"
-                                >
-                                    <div>
-                                        <p className="font-bold text-gray-900 text-sm">{c.name}</p>
-                                        <p className="text-xs text-gray-400">{c.phone || 'Sin tel├®fono'}</p>
+
+                        <div className="p-6">
+                            {!isCreatingCustomer ? (
+                                <>
+                                    <div className="relative mb-4">
+                                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
+                                        <input
+                                            autoFocus
+                                            placeholder="Buscar cliente..."
+                                            className="w-full pl-10 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500"
+                                            value={customerSearchTerm}
+                                            onChange={(e) => setCustomerSearchTerm(e.target.value)}
+                                        />
                                     </div>
-                                    <div className="opacity-0 group-hover:opacity-100 text-indigo-600">
-                                        <ArrowLeft className="w-4 h-4 rotate-180" />
+
+                                    <div className="max-h-60 overflow-y-auto space-y-2 mb-4">
+                                        {filteredCustomers.map(c => (
+                                            <button
+                                                key={c.id}
+                                                onClick={() => processSale('Credit', c.id)}
+                                                className="w-full p-3 text-left hover:bg-indigo-50 rounded-xl flex items-center justify-between group transition-colors"
+                                            >
+                                                <div>
+                                                    <p className="font-bold text-gray-900 text-sm">{c.name}</p>
+                                                    <p className="text-xs text-gray-400">{c.phone || 'Sin tel├®fono'}</p>
+                                                </div>
+                                                <div className="opacity-0 group-hover:opacity-100 text-indigo-600">
+                                                    <ArrowLeft className="w-4 h-4 rotate-180" />
+                                                </div>
+                                            </button>
+                                        ))}
+                                        {filteredCustomers.length === 0 && (
+                                            <p className="text-center text-xs text-gray-400 py-4">No se encontraron clientes</p>
+                                        )}
                                     </div>
-                                </button>
-                            ))}
-                            {filteredCustomers.length === 0 && (
-                                <p className="text-center text-xs text-gray-400 py-4">No se encontraron clientes</p>
+
+                                    <button
+                                        onClick={() => setIsCreatingCustomer(true)}
+                                        className="w-full py-3 border-2 border-dashed border-gray-200 text-gray-500 rounded-xl font-bold text-xs uppercase hover:bg-gray-50 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center justify-center gap-2"
+                                    >
+                                        <UserPlus className="w-4 h-4" /> Nuevo Cliente
+                                    </button>
+                                </>
+                            ) : (
+                                <form onSubmit={handleCreateCustomer} className="space-y-4">
+                                    <div className="flex items-center gap-2 mb-2 text-indigo-600">
+                                        <button type="button" onClick={() => setIsCreatingCustomer(false)}><ArrowLeft className="w-5 h-5" /></button>
+                                        <span className="font-black text-sm uppercase">Nuevo Registro</span>
+                                    </div>
+
+                                    <div className="space-y-1">
+                                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Nombre</label>
+                                        <input
+                                            required
+                                            autoFocus
+                                            className="w-full p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500"
+                                            placeholder="Nombre del cliente"
+                                            value={newCustomerData.name}
+                                            onChange={e => setNewCustomerData({ ...newCustomerData, name: e.target.value })}
+                                        />
+                                    </div>
+                                    <div className="space-y-1">
+                                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Tel├®fono</label>
+                                        <input
+                                            className="w-full p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500"
+                                            placeholder="0412..."
+                                            value={newCustomerData.phone}
+                                            onChange={e => setNewCustomerData({ ...newCustomerData, phone: e.target.value })}
+                                        />
+                                    </div>
+
+                                    <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-xs shadow-lg active:scale-95 transition-all">
+                                        Guardar y Asignar
+                                    </button>
+                                </form>
                             )}
                         </div>
+                    </div>
+                </div>
+            )}
 
-                        <button 
-                            onClick={() => setIsCreatingCustomer(true)}
-                            className="w-full py-3 border-2 border-dashed border-gray-200 text-gray-500 rounded-xl font-bold text-xs uppercase hover:bg-gray-50 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center justify-center gap-2"
-                        >
-                            <UserPlus className="w-4 h-4" /> Crear Nuevo Cliente
-                        </button>
-                    </>
-                ) : (
-                    <form onSubmit={handleCreateCustomer} className="space-y-4">
-                        <div>
-                            <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1">Nombre</label>
-                            <input 
-                                required
-                                autoFocus
-                                className="w-full p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500 mt-1"
-                                value={newCustomerData.name}
-                                onChange={(e) => setNewCustomerData({...newCustomerData, name: e.target.value})}
-                            />
-                        </div>
-                        <div>
-                            <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1">Tel├®fono</label>
-                            <input 
-                                className="w-full p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-sm outline-none focus:border-indigo-500 mt-1"
-                                value={newCustomerData.phone}
-                                onChange={(e) => setNewCustomerData({...newCustomerData, phone: e.target.value})}
-                            />
-                        </div>
-                        <div className="flex gap-2 pt-2">
-                            <button type="button" onClick={() => setIsCreatingCustomer(false)} className="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-sm">Cancelar</button>
-                            <button type="submit" className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg">Guardar y Asignar</button>
-                        </div>
-                    </form>
-                )}
-             </div>
-          </div>
-        </div>
-      )}
-      
-      <style>{`
-        .no-scrollbar::-webkit-scrollbar { display: none; }
-        @keyframes bounce-in {
-            0% { transform: scale(0.5); opacity: 0; }
-            50% { transform: scale(1.1); }
-            100% { transform: scale(1); opacity: 1; }
-        }
-        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
+            <style>{`
+        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
+        @keyframes scale-up { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
+        @keyframes bounce-in { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
+        .animate-fade-in { animation: fade-in 0.2s ease-out; }
+        .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
+        .animate-bounce-in { animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
       `}</style>
-    </div>
-  );
+        </div>
+    );
 };
 
 export default POS;
diff --git a/components/Reports.tsx b/components/Reports.tsx
index b13ef5f..b016558 100644
--- a/components/Reports.tsx
+++ b/components/Reports.tsx
@@ -1,87 +1,65 @@
+
 import React, { useState, useEffect } from 'react';
-import { Sale, Shift, Customer } from '../types';
-import { ShoppingBag, TrendingUp, DollarSign, Wallet, Banknote, Smartphone, CreditCard, History, Plus, Lock, XCircle, CheckCircle2, ShoppingCart, ArrowRight, Building, PiggyBank, Clock, X, Trash2, Edit, Search } from '../constants';
+import { Sale, Customer, TreasuryTransaction } from '../types';
+import { ShoppingBag, TrendingUp, DollarSign, Wallet, Banknote, Smartphone, CreditCard, History, Plus, Lock, XCircle, CheckCircle2, ShoppingCart, ArrowRight, Building, PiggyBank, Clock, X, Trash2, Edit, Search, AlertTriangle, Minus, RotateCcw, Save, Calendar } from '../constants';
 import { saveData, syncPath } from '../services/supabaseService';
 
 interface ReportsProps {
-  sales: Sale[];
-  customers?: Customer[];
-  exchangeRate: number;
-  onOpenPOS: () => void;
-  onVoidSale: (saleId: string) => void;
-  onEditSale: (sale: Sale) => void;
+    sales: Sale[];
+    customers?: Customer[];
+    exchangeRate: number;
+    treasuryTransactions?: TreasuryTransaction[];
+    onOpenPOS: () => void;
+    onVoidSale: (saleId: string) => void;
+    onEditSale: (sale: Sale) => void;
+    onAddTreasuryTransaction: (t: TreasuryTransaction) => void;
+    onOpenRateModal?: () => void;
 }
 
-const VentasCaja: React.FC<ReportsProps> = ({ sales, customers = [], exchangeRate, onOpenPOS, onVoidSale, onEditSale }) => {
-  const [activeShift, setActiveShift] = useState<Shift | null>(null);
-  const [mercantilBalance, setMercantilBalance] = useState<number>(0);
-  const [efectivoBalance, setEfectivoBalance] = useState<number>(0); // Saldo hist├│rico de efectivo (B├│veda)
-  const [showOpenModal, setShowOpenModal] = useState(false);
-  const [initialCashInput, setInitialCashInput] = useState('');
-  const [searchTerm, setSearchTerm] = useState('');
-
-  // State for Receipt Modal
-  const [selectedSale, setSelectedSale] = useState<Sale | null>(null);
-
-  // Sync Active Shift
-  useEffect(() => {
-    const unsub = syncPath('settings/activeShift', (data) => {
-      if (data) setActiveShift(data);
-      else setActiveShift(null);
-    });
-    return () => unsub();
-  }, []);
+type PaymentMethodFilter = 'Cash' | 'Card' | 'PagoMovil' | null;
 
-  // Sync Mercantil Balance (Historic)
-  useEffect(() => {
-    const unsub = syncPath('settings/mercantilBalance', (data) => {
-      setMercantilBalance(data || 0);
-    });
-    return () => unsub();
-  }, []);
+const VentasCaja: React.FC<ReportsProps> = ({ sales, customers = [], exchangeRate, treasuryTransactions = [], onOpenPOS, onVoidSale, onEditSale, onAddTreasuryTransaction, onOpenRateModal }) => {
+    // Configuraci├│n Persistente
+    const [lastCutoff, setLastCutoff] = useState<number>(0);
+    const [baseCash, setBaseCash] = useState<number>(0);
 
-  // Sync Efectivo Balance (Historic/Vault)
-  useEffect(() => {
-    const unsub = syncPath('settings/efectivoBalance', (data) => {
-      setEfectivoBalance(data || 0);
-    });
-    return () => unsub();
-  }, []);
-
-  const openShift = () => {
-    const cash = parseFloat(initialCashInput) || 0;
-
-    // Al abrir, restamos la base del saldo acumulado de efectivo (sacamos de b├│veda a caja)
-    if (cash > efectivoBalance) {
-      if (!confirm("El monto base es mayor al efectivo disponible en b├│veda. ┬┐Continuar y dejar saldo negativo?")) {
-        return;
-      }
-    }
-
-    const newShift: Shift = {
-      id: Date.now().toString(),
-      startTime: Date.now(),
-      initialCash: cash, // This is now in Bs
-      status: 'open'
+    // Modals State
+    const [showCutoffModal, setShowCutoffModal] = useState(false);
+    const [showAdjustmentModal, setShowAdjustmentModal] = useState(false);
+    const [activeDetail, setActiveDetail] = useState<PaymentMethodFilter>(null);
+
+    // Adjustment State
+    const [adjustmentAmount, setAdjustmentAmount] = useState('');
+
+    // Cutoff State (Cierre)
+    const [cutoffBaseToKeep, setCutoffBaseToKeep] = useState('');
+    const [cutoffCardLiquidate, setCutoffCardLiquidate] = useState('');
+
+    const [searchTerm, setSearchTerm] = useState('');
+    const [selectedSale, setSelectedSale] = useState<Sale | null>(null);
+
+    // Sincronizaci├│n de Datos
+    useEffect(() => {
+        // Fecha del ├║ltimo corte (Cierre Z)
+        const unsubCutoff = syncPath('settings/lastCutoff', (data) => setLastCutoff(data || 0));
+        // Base de efectivo actual en caja
+        const unsubBase = syncPath('settings/baseCash', (data) => setBaseCash(data || 0));
+
+        return () => { unsubCutoff(); unsubBase(); };
+    }, []);
+
+    const getCustomerName = (customerId?: string) => {
+        if (!customerId) return 'Cliente Desconocido';
+        const c = customers.find(cust => cust.id === customerId);
+        return c ? c.name : 'Cliente';
     };
 
-    saveData('settings/activeShift', newShift);
-    saveData('settings/efectivoBalance', efectivoBalance - cash); // Restar de b├│veda
-    setShowOpenModal(false);
-    setInitialCashInput('');
-  };
-
-  const getCustomerName = (customerId?: string) => {
-    if (!customerId) return 'Cliente Desconocido';
-    const c = customers.find(cust => cust.id === customerId);
-    return c ? c.name : 'Cliente';
-  };
-
-  // Filtrar ventas del turno actual y aplicar b├║squeda
-  const shiftSales = activeShift
-    ? sales
-      .filter(s => s.timestamp >= activeShift.startTime)
-      .filter(s => {
+    // --- L├ôGICA DE VENTAS ACTUALES (Desde el ├║ltimo corte) ---
+    const currentSales = sales
+        .filter(s => s.timestamp > lastCutoff)
+        .sort((a, b) => b.timestamp - a.timestamp);
+
+    const filteredSales = currentSales.filter(s => {
         if (!searchTerm) return true;
         const term = searchTerm.toLowerCase();
         const totalBs = (s.total * s.exchangeRate).toFixed(2);
@@ -90,460 +68,691 @@ const VentasCaja: React.FC<ReportsProps> = ({ sales, customers = [], exchangeRat
         const matchesItems = s.items.some(item => item.name.toLowerCase().includes(term));
         const matchesAmount = totalBs.includes(term) || totalUsd.includes(term);
         const matchesMethod =
-          (s.paymentMethod === 'Cash' && 'efectivo'.includes(term)) ||
-          (s.paymentMethod === 'Card' && 'tarjeta'.includes(term)) ||
-          (s.paymentMethod === 'PagoMovil' && 'pago movil'.includes(term)) ||
-          (s.paymentMethod === 'Credit' && 'credito'.includes(term));
+            (s.paymentMethod === 'Cash' && 'efectivo'.includes(term)) ||
+            (s.paymentMethod === 'Card' && 'tarjeta'.includes(term)) ||
+            (s.paymentMethod === 'PagoMovil' && 'pago movil'.includes(term)) ||
+            (s.paymentMethod === 'Credit' && 'credito'.includes(term));
 
         let matchesCustomer = false;
         if (s.customerId) {
-          const cName = getCustomerName(s.customerId).toLowerCase();
-          matchesCustomer = cName.includes(term);
+            const cName = getCustomerName(s.customerId).toLowerCase();
+            matchesCustomer = cName.includes(term);
         }
-
         return matchesItems || matchesAmount || matchesMethod || matchesCustomer;
-      })
-    : [];
-
-  // C├ílculos del Turno en BOLIVARES
-  const ventasEfectivoBs = shiftSales
-    .filter(s => s.paymentMethod === 'Cash')
-    .reduce((sum, s) => sum + (s.total * s.exchangeRate), 0);
-
-  const ventasPuntoBs = shiftSales
-    .filter(s => s.paymentMethod === 'Card' || s.paymentMethod === 'PagoMovil')
-    .reduce((sum, s) => sum + (s.total * s.exchangeRate), 0);
-
-  // Totales de Cuentas
-  const efectivoEnCajaBs = (activeShift?.initialCash || 0) + ventasEfectivoBs;
-  const puntoPorLiquidarBs = ventasPuntoBs;
-
-  const closeShift = () => {
-    if (confirm(`┬┐Cerrar turno?\n\n- Se enviar├ín ${efectivoEnCajaBs.toFixed(2)} Bs a B├│veda.\n- Se enviar├ín ${puntoPorLiquidarBs.toFixed(2)} Bs a Banco Mercantil.`)) {
-
-      // Transfer point balance to bank
-      const newMercantilBalance = mercantilBalance + puntoPorLiquidarBs;
-      // Transfer cash in drawer back to vault
-      const newEfectivoBalance = efectivoBalance + efectivoEnCajaBs;
-
-      saveData('settings/mercantilBalance', newMercantilBalance);
-      saveData('settings/efectivoBalance', newEfectivoBalance);
-      saveData('settings/activeShift', null);
-    }
-  };
-
-  const getSaleDescription = (sale: Sale) => {
-    if (sale.items.length === 0) return "Venta sin items";
-    const itemSummaries = sale.items.map(item => {
-      if (item.id === 'debt_payment') return item.name;
-      return `${item.quantity} ${item.name}`;
     });
-    return itemSummaries.join(', ');
-  };
-
-  const handleVoid = (e: React.MouseEvent) => {
-    e.stopPropagation();
-    if (!selectedSale) return;
-
-    if (window.confirm("┬┐Est├ís seguro de ELIMINAR esta venta? Esta acci├│n no se puede deshacer.")) {
-      onVoidSale(selectedSale.id);
-      setSelectedSale(null);
-    }
-  };
-
-  const handleEdit = (e: React.MouseEvent) => {
-    e.stopPropagation();
-    if (!selectedSale) return;
-
-    if (window.confirm("Se anular├í esta factura y se cargar├ín los productos al carrito para corregirla. ┬┐Continuar?")) {
-      onEditSale(selectedSale);
-      setSelectedSale(null);
-    }
-  };
-
-  if (!activeShift) {
+
+    // 1. Efectivo en Caja (Base + Ventas Efectivo Actuales)
+    const salesCashBs = currentSales
+        .filter(s => s.paymentMethod === 'Cash')
+        .reduce((sum, s) => sum + (s.total * s.exchangeRate), 0);
+
+    const totalCashInDrawer = baseCash + salesCashBs;
+
+    // 2. Punto de Venta (PENDIENTE DE LIQUIDACI├ôN)
+    const salesCardBs = currentSales
+        .filter(s => s.paymentMethod === 'Card')
+        .reduce((sum, s) => sum + (s.total * s.exchangeRate), 0);
+
+    // 3. Pago M├│vil (Turno Actual - Referencia Visual)
+    const salesPagoMovilBs = currentSales
+        .filter(s => s.paymentMethod === 'PagoMovil')
+        .reduce((sum, s) => sum + (s.total * s.exchangeRate), 0);
+
+    // --- C├üLCULO DE BANCO MERCANTIL (GLOBAL / REAL) ---
+    // L├│gica solicitada: 
+    // Banco = (Movimientos Manuales Balance que no sean efectivo) + (TODO el Pago M├│vil Hist├│rico) + (Liquidaciones del Punto).
+    // Nota: Las ventas de Punto NO entran aqu├¡ hasta que se hace el Cierre (creando un movimiento 'Transfer').
+
+    // A. Movimientos Manuales y Liquidaciones (Todo lo que est├í en Treasury y no es Cash)
+    // OJO: Incluimos 'Ventas (Cierre)' si el m├®todo es Transfer/PagoMovil, eso representa la liquidaci├│n del punto.
+    const bankTransactions = treasuryTransactions.filter(t => t.method !== 'Cash');
+    const bankBalanceFromTxs = bankTransactions.reduce((acc, t) => acc + (t.type === 'income' ? t.amountBs : -t.amountBs), 0);
+
+    // B. Ventas por Pago M├│vil (TODAS las hist├│ricas, entran directo)
+    // Asumimos que no se duplican manualmente en Treasury.
+    const allPagoMovilSales = sales.filter(s => s.paymentMethod === 'PagoMovil');
+    const allPagoMovilBs = allPagoMovilSales.reduce((acc, s) => acc + (s.total * s.exchangeRate), 0);
+
+    // C. Total Banco Mercantil
+    const mercantilGlobalBalance = bankBalanceFromTxs + allPagoMovilBs;
+
+
+    // --- MANEJADORES ---
+
+    const handleCashAdjustment = (type: 'add' | 'subtract') => {
+        const amount = parseFloat(adjustmentAmount);
+        if (!amount || isNaN(amount) || amount <= 0) return;
+        const newBase = type === 'add' ? baseCash + amount : baseCash - amount;
+        saveData('settings/baseCash', newBase);
+        setShowAdjustmentModal(false);
+        setAdjustmentAmount('');
+    };
+
+    const handleInitiateCutoff = () => {
+        setCutoffBaseToKeep(baseCash.toString());
+        setCutoffCardLiquidate(salesCardBs.toFixed(2));
+        setShowCutoffModal(true);
+    };
+
+    const confirmCutoff = () => {
+        const keepBase = parseFloat(cutoffBaseToKeep) || 0;
+        const liquidateCard = parseFloat(cutoffCardLiquidate) || 0;
+        const amountToVaultBs = totalCashInDrawer - keepBase;
+        const amountToVaultUsd = amountToVaultBs / exchangeRate;
+        const now = Date.now();
+
+        // 1. Mover Dinero a B├│veda (Retiro de Caja F├¡sica) -> Crea ingreso en Balance (Cash) pero como "Cierre"
+        // En realidad, para el Balance global, si sacas de caja y metes a "B├│veda" (otro bolsillo), es un movimiento neutro o ingreso a "Caja Fuerte".
+        // Vamos a registrarlo como Ingreso 'Cash' en Treasury para mantener el registro hist├│rico del dinero real que ha pasado.
+        if (amountToVaultBs > 0) {
+            onAddTreasuryTransaction({
+                id: `cutoff_cash_${now}`,
+                timestamp: now,
+                type: 'income',
+                category: 'Ventas (Cierre)',
+                description: 'Cierre de Caja - Efectivo',
+                amount: amountToVaultUsd,
+                amountBs: amountToVaultBs,
+                exchangeRate: exchangeRate,
+                method: 'Cash'
+            });
+        }
+
+        // 2. Liquidar Punto de Venta -> Transferencia a Banco
+        // Esto mueve el dinero de "Limbo Punto" a "Banco Mercantil"
+        const liquidateCardUsd = liquidateCard / exchangeRate;
+        if (liquidateCard > 0) {
+            onAddTreasuryTransaction({
+                id: `cutoff_bank_${now}`,
+                timestamp: now,
+                type: 'income',
+                category: 'Ventas (Cierre)',
+                description: 'Liquidaci├│n Punto de Venta',
+                amount: liquidateCardUsd,
+                amountBs: liquidateCard,
+                exchangeRate: exchangeRate,
+                method: 'Transfer'
+            });
+        }
+
+        saveData('settings/baseCash', keepBase);
+        saveData('settings/lastCutoff', now);
+
+        setShowCutoffModal(false);
+    };
+
+    const getSaleDescription = (sale: Sale) => {
+        if (sale.items.length === 0) return "Venta sin items";
+        const itemSummaries = sale.items.map(item => {
+            if (item.id === 'debt_payment') return item.name;
+            return `${item.quantity} ${item.name}`;
+        });
+        return itemSummaries.join(', ');
+    };
+
+    const handleVoid = (e: React.MouseEvent) => {
+        e.stopPropagation();
+        if (!selectedSale) return;
+        if (window.confirm("┬┐Est├ís seguro de ELIMINAR esta venta?")) {
+            onVoidSale(selectedSale.id);
+            setSelectedSale(null);
+        }
+    };
+
+    const handleEdit = (e: React.MouseEvent) => {
+        e.stopPropagation();
+        if (!selectedSale) return;
+        if (window.confirm("Se anular├í esta factura para corregirla. ┬┐Continuar?")) {
+            onEditSale(selectedSale);
+            setSelectedSale(null);
+        }
+    };
+
+    // Helper para el modal de detalle
+    const getDetailSales = () => {
+        if (!activeDetail) return [];
+        return currentSales.filter(s => s.paymentMethod === activeDetail);
+    };
+
+    const getDetailColor = () => {
+        switch (activeDetail) {
+            case 'Cash': return 'emerald';
+            case 'Card': return 'blue';
+            case 'PagoMovil': return 'indigo';
+            default: return 'gray';
+        }
+    };
+
+    const getDetailTitle = () => {
+        switch (activeDetail) {
+            case 'Cash': return 'Movimientos de Efectivo';
+            case 'Card': return 'Ventas por Punto';
+            case 'PagoMovil': return 'Pagos M├│viles (Hoy)';
+            default: return '';
+        }
+    };
+
     return (
-      <div className="h-[calc(100vh-100px)] flex flex-col items-center justify-center text-center p-6 bg-white rounded-[2.5rem] border-2 border-dashed border-gray-200 animate-fade-in relative overflow-hidden">
-        {/* ... (Keep existing content for closed shift) ... */}
-        <div className="relative z-10 flex flex-col items-center max-w-md w-full">
-          <div className="bg-gray-100 w-24 h-24 rounded-3xl flex items-center justify-center text-gray-400 mb-6 shadow-inner">
-            <Lock className="w-12 h-12" />
-          </div>
-          <h2 className="text-3xl font-black text-gray-900 mb-2">Caja Cerrada</h2>
-          <p className="text-sm text-gray-500 font-medium mb-8 max-w-xs leading-relaxed">Inicia un nuevo turno operativo para habilitar el sistema de ventas.</p>
-
-          <button
-            onClick={() => setShowOpenModal(true)}
-            className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest text-sm shadow-xl shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-3 hover:bg-indigo-700 mb-8"
-          >
-            <Plus className="w-6 h-6" /> Aperturar Caja
-          </button>
-
-          {/* Saldos Hist├│ricos */}
-          <div className="grid grid-cols-2 gap-3 w-full">
-            {/* Banco Mercantil */}
-            <div className="p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left">
-              <div className="flex items-center gap-2 mb-2">
-                <div className="p-1.5 bg-indigo-100 rounded-lg text-indigo-600">
-                  <Building className="w-4 h-4" />
-                </div>
-                <span className="text-[10px] font-black uppercase text-gray-400">Mercantil</span>
-              </div>
-              <p className="text-lg font-black text-gray-900">{mercantilBalance.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-              <p className="text-xs font-bold text-emerald-500 mt-1">Ref: ${(mercantilBalance / exchangeRate).toFixed(2)}</p>
-            </div>
+        <>
+            <div className="space-y-4 pb-24 animate-fade-in relative">
+
+                {/* --- PANEL PRINCIPAL: BANCO MERCANTIL --- */}
+                <div className="bg-indigo-900 text-white p-5 rounded-[2rem] shadow-xl relative overflow-hidden">
+
+                    <div className="flex justify-between items-center mb-4 relative z-10">
+                        <div>
+                            <h2 className="text-[9px] font-black text-indigo-300 uppercase tracking-widest mb-1">Banco Mercantil</h2>
+                            <div className="flex items-baseline gap-2">
+                                <span className="text-3xl font-black text-white tracking-tight">
+                                    {mercantilGlobalBalance.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span className="text-sm text-indigo-300">Bs</span>
+                                </span>
+                            </div>
+                        </div>
 
-            {/* Efectivo en B├│veda */}
-            <div className="p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left">
-              <div className="flex items-center gap-2 mb-2">
-                <div className="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
-                  <Wallet className="w-4 h-4" />
-                </div>
-                <span className="text-[10px] font-black uppercase text-gray-400">Efectivo</span>
-              </div>
-              <p className="text-lg font-black text-gray-900">{efectivoBalance.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-              <p className="text-xs font-bold text-emerald-500 mt-1">Ref: ${(efectivoBalance / exchangeRate).toFixed(2)}</p>
-            </div>
-          </div>
-        </div>
-
-        {showOpenModal && (
-          <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
-            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm animate-scale-up shadow-2xl">
-              <div className="bg-emerald-100 w-16 h-16 rounded-2xl flex items-center justify-center text-emerald-600 mb-6 mx-auto">
-                <Banknote className="w-8 h-8" />
-              </div>
-              <h3 className="text-2xl font-black text-gray-900 mb-2 text-center">Base en Efectivo</h3>
-              <p className="text-xs text-gray-400 mb-8 font-bold uppercase tracking-widest text-center">Monto inicial para dar vuelto (Bs)</p>
-
-              <div className="relative mb-2">
-                <span className="absolute left-5 top-1/2 -translate-y-1/2 font-black text-gray-300 text-lg">Bs.</span>
-                <input
-                  autoFocus
-                  type="number"
-                  placeholder="0.00"
-                  className="w-full pl-14 pr-4 py-5 bg-gray-50 border-2 border-gray-100 rounded-2xl text-3xl font-black text-gray-900 outline-none focus:border-emerald-500 focus:bg-white transition-all text-center"
-                  value={initialCashInput}
-                  onChange={(e) => setInitialCashInput(e.target.value)}
-                />
-              </div>
-
-              <div className="mb-8 text-center">
-                <p className="text-[10px] text-gray-400 font-medium">
-                  Disponible en B├│veda: <span className="text-emerald-600 font-bold">{efectivoBalance.toLocaleString('es-VE')} Bs</span>
-                </p>
-              </div>
-
-              <div className="flex gap-3">
-                <button onClick={() => setShowOpenModal(false)} className="flex-1 py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-colors hover:bg-gray-200">Cancelar</button>
-                <button onClick={openShift} className="flex-1 py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg shadow-emerald-200 active:scale-95 transition-transform hover:bg-emerald-700">ABRIR</button>
-              </div>
-            </div>
-          </div>
-        )}
-      </div>
-    );
-  }
-
-  return (
-    <>
-      <div className="space-y-4 pb-24 animate-fade-in relative">
-        {/* --- NUEVO LAYOUT SUPERIOR --- */}
-        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
-          {/* ... (Same as before) ... */}
-          {/* Tarjeta Banco Mercantil */}
-          <div className="bg-indigo-900 text-white p-5 rounded-[2rem] relative overflow-hidden flex flex-col justify-between h-36 shadow-lg">
-            <div className="relative z-10 flex items-start justify-between">
-              <div className="flex items-center gap-2">
-                <div className="p-1.5 bg-white/10 rounded-xl"><Building className="w-4 h-4" /></div>
-                <span className="text-xs font-bold text-indigo-200 uppercase tracking-widest">Banco Mercantil</span>
-              </div>
-              <div className="text-right">
-                <p className="text-[10px] font-bold text-indigo-300 uppercase">Disponible</p>
-              </div>
-            </div>
-            <div className="relative z-10">
-              <p className="text-3xl font-black tracking-tight">{mercantilBalance.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-              <p className="text-xs font-bold text-emerald-400 mt-1 flex items-center gap-1">
-                <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full"></span>
-                Ref: ${(mercantilBalance / exchangeRate).toFixed(2)}
-              </p>
-            </div>
-            {/* Background Decoration */}
-            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none opacity-40"></div>
-          </div>
-
-          {/* Tarjeta Informaci├│n Turno */}
-          <div className="bg-white p-5 rounded-[2rem] border border-gray-100 shadow-sm flex flex-col justify-between h-36">
-            <div className="flex justify-between items-start">
-              <div>
-                <div className="flex items-center gap-2 mb-1.5">
-                  <span className="relative flex h-2.5 w-2.5">
-                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
-                    <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
-                  </span>
-                  <span className="text-xs font-black text-gray-900 uppercase tracking-widest">Turno Activo</span>
-                </div>
-                <div className="flex items-center gap-1.5 text-gray-400">
-                  <Clock className="w-3 h-3" />
-                  <p className="text-[10px] font-bold">Desde: {new Date(activeShift.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
+                        <div className="flex items-center gap-4">
+                            <button
+                                onClick={onOpenRateModal}
+                                className="text-right hover:opacity-70 transition-opacity active:scale-95"
+                            >
+                                <span className="block text-[8px] font-bold text-indigo-400 uppercase tracking-wider mb-0.5">Tasa BCV</span>
+                                <span className="text-lg font-black text-white flex items-center gap-1 justify-end">
+                                    ${exchangeRate.toFixed(2)} <DollarSign className="w-3 h-3 text-indigo-400" />
+                                </span>
+                            </button>
+
+                            <div className="w-px h-8 bg-indigo-800"></div>
+
+                            <button
+                                onClick={handleInitiateCutoff}
+                                className="p-3 bg-white/10 hover:bg-white/20 text-white rounded-xl transition-all active:scale-95 shadow-sm border border-white/5"
+                                title="Realizar Cierre de Caja"
+                            >
+                                <RotateCcw className="w-5 h-5" />
+                            </button>
+                        </div>
+                    </div>
+
+                    {/* Grid Compacto */}
+                    <div className="grid grid-cols-3 gap-2 relative z-10">
+
+                        {/* 1. Efectivo (Caja F├¡sica) */}
+                        <div
+                            onClick={() => setActiveDetail('Cash')}
+                            className="bg-indigo-800/50 hover:bg-indigo-800 border border-indigo-700/50 p-3 rounded-xl cursor-pointer active:scale-[0.98] transition-all"
+                        >
+                            <div className="flex items-center gap-1.5 mb-1.5 text-emerald-400">
+                                <Banknote className="w-3 h-3" />
+                                <span className="text-[8px] font-black uppercase tracking-wider text-indigo-200">Efectivo</span>
+                            </div>
+                            <p className="text-sm font-black text-white truncate">{totalCashInDrawer.toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+                        </div>
+
+                        {/* 2. Pagos M├│viles (Hoy) */}
+                        <div
+                            onClick={() => setActiveDetail('PagoMovil')}
+                            className="bg-indigo-800/50 hover:bg-indigo-800 border border-indigo-700/50 p-3 rounded-xl cursor-pointer active:scale-[0.98] transition-all"
+                        >
+                            <div className="flex items-center gap-1.5 mb-1.5 text-purple-400">
+                                <Smartphone className="w-3 h-3" />
+                                <span className="text-[8px] font-black uppercase tracking-wider text-indigo-200">Pago M├│vil (Hoy)</span>
+                            </div>
+                            <p className="text-sm font-black text-white truncate">{salesPagoMovilBs.toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+                        </div>
+
+                        {/* 3. Punto de Venta (Por Liquidar) */}
+                        <div
+                            onClick={() => setActiveDetail('Card')}
+                            className="bg-indigo-800/50 hover:bg-indigo-800 border border-indigo-700/50 p-3 rounded-xl cursor-pointer active:scale-[0.98] transition-all"
+                        >
+                            <div className="flex items-center gap-1.5 mb-1.5 text-blue-400">
+                                <CreditCard className="w-3 h-3" />
+                                <span className="text-[8px] font-black uppercase tracking-wider text-indigo-200">Punto (Pendiente)</span>
+                            </div>
+                            <p className="text-sm font-black text-white truncate">{salesCardBs.toLocaleString('es-VE', { maximumFractionDigits: 0 })} Bs</p>
+                        </div>
+
+                    </div>
+
+                    <div className="absolute top-0 right-0 w-40 h-40 bg-indigo-500 rounded-full blur-[80px] opacity-20 pointer-events-none"></div>
                 </div>
-              </div>
-            </div>
 
-            <button
-              onClick={closeShift}
-              className="w-full py-3 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl text-xs font-black uppercase tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 border border-red-100"
-            >
-              <XCircle className="w-4 h-4" /> Cerrar Turno
-            </button>
-          </div>
-        </div>
-
-        {/* --- M├ëTRICAS DE CAJA ACTUAL --- */}
-        <div className="grid grid-cols-2 gap-4">
-          {/* Efectivo en Caja */}
-          <div className="bg-emerald-50 p-5 rounded-[2rem] border border-emerald-100 relative overflow-hidden group">
-            <div className="relative z-10">
-              <div className="flex items-center gap-2 mb-3">
-                <div className="p-2 bg-white rounded-xl text-emerald-600 shadow-sm"><Banknote className="w-5 h-5" /></div>
-                <span className="text-[10px] font-black text-emerald-800 uppercase tracking-widest">En Caja</span>
-              </div>
-              <p className="text-2xl font-black text-gray-900 truncate" title={efectivoEnCajaBs.toLocaleString('es-VE')}>{efectivoEnCajaBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-              <p className="text-[9px] font-bold text-emerald-600/70 mt-1 uppercase">Base: {activeShift.initialCash.toLocaleString('es-VE')} Bs</p>
-            </div>
-            <Banknote className="absolute -right-4 -bottom-4 w-24 h-24 text-emerald-100 rotate-12 group-hover:rotate-6 transition-transform z-0" />
-          </div>
-
-          {/* Punto de Venta */}
-          <div className="bg-blue-50 p-5 rounded-[2rem] border border-blue-100 relative overflow-hidden group">
-            <div className="relative z-10">
-              <div className="flex items-center gap-2 mb-3">
-                <div className="p-2 bg-white rounded-xl text-blue-600 shadow-sm"><CreditCard className="w-5 h-5" /></div>
-                <span className="text-[10px] font-black text-blue-800 uppercase tracking-widest">Punto</span>
-              </div>
-              <p className="text-2xl font-black text-gray-900 truncate" title={puntoPorLiquidarBs.toLocaleString('es-VE')}>{puntoPorLiquidarBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-              <p className="text-[9px] font-bold text-blue-600/70 mt-1 uppercase">Por Liquidar</p>
-            </div>
-            <CreditCard className="absolute -right-4 -bottom-4 w-24 h-24 text-blue-100 rotate-12 group-hover:rotate-6 transition-transform z-0" />
-          </div>
-        </div>
-
-        {/* Historial Reciente */}
-        <div className="bg-white rounded-[2.5rem] border border-gray-100 p-6 shadow-sm">
-          <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
-            <div className="flex items-center gap-3">
-              <div className="bg-gray-100 p-2 rounded-xl text-gray-500">
-                <History className="w-5 h-5" />
-              </div>
-              <h3 className="text-sm font-black text-gray-900 uppercase tracking-wide">Movimientos Recientes</h3>
-            </div>
+                {/* LISTA DE MOVIMIENTOS RECIENTES (GENERAL) */}
+                <div className="bg-white rounded-[2.5rem] border border-gray-100 p-6 shadow-sm">
+                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
+                        <div className="flex items-center gap-3">
+                            <div className="bg-gray-100 p-2 rounded-xl text-gray-500">
+                                <History className="w-5 h-5" />
+                            </div>
+                            <h3 className="text-sm font-black text-gray-900 uppercase tracking-wide">Movimientos (Actual)</h3>
+                        </div>
 
-            {/* Buscador de Movimientos */}
-            <div className="relative w-full md:w-64">
-              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
-              <input
-                type="text"
-                placeholder="Buscar producto, monto..."
-                className="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold outline-none focus:border-indigo-500 transition-colors"
-                value={searchTerm}
-                onChange={(e) => setSearchTerm(e.target.value)}
-              />
-            </div>
-          </div>
-
-          <div className="space-y-3">
-            {shiftSales.length === 0 ? (
-              <div className="py-12 text-center opacity-40">
-                <p className="text-xs font-black uppercase text-gray-400">
-                  {searchTerm ? 'No se encontraron resultados' : 'Sin movimientos en este turno'}
-                </p>
-              </div>
-            ) : (
-              shiftSales.slice().reverse().map(sale => {
-                const totalVES = sale.total * sale.exchangeRate;
-                const isCash = sale.paymentMethod === 'Cash';
-                const isCredit = sale.paymentMethod === 'Credit';
-
-                return (
-                  <div
-                    key={sale.id}
-                    onClick={() => setSelectedSale(sale)}
-                    className="flex items-center justify-between p-4 rounded-2xl hover:bg-gray-50 transition-colors border border-transparent hover:border-gray-100 cursor-pointer active:scale-[0.99] group"
-                  >
-                    {/* LEFT: Icon & Description */}
-                    <div className="flex items-center gap-4 flex-1 min-w-0 mr-4">
-                      <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 shadow-sm ${isCash ? 'bg-emerald-100 text-emerald-600' : isCredit ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`}>
-                        {isCash ? <Banknote className="w-6 h-6" /> : isCredit ? <Wallet className="w-6 h-6" /> : <CreditCard className="w-6 h-6" />}
-                      </div>
-                      <div className="min-w-0 flex-1">
-                        <p className="text-sm font-bold text-gray-800 truncate leading-tight">
-                          {getSaleDescription(sale)}
-                        </p>
-                        <div className="flex flex-wrap items-center gap-x-2 gap-y-1 mt-1">
-                          {isCredit && (
-                            <span className="text-[10px] font-black text-orange-500 bg-orange-50 px-1.5 rounded uppercase tracking-wide">
-                              {getCustomerName(sale.customerId)}
-                            </span>
-                          )}
-                          <span className="text-[10px] font-medium text-gray-400">
-                            {new Date(sale.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
-                          </span>
+                        <div className="relative w-full md:w-64">
+                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
+                            <input
+                                type="text"
+                                placeholder="Buscar..."
+                                className="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold outline-none focus:border-indigo-500 transition-colors"
+                                value={searchTerm}
+                                onChange={(e) => setSearchTerm(e.target.value)}
+                            />
                         </div>
-                      </div>
                     </div>
 
-                    {/* RIGHT: Amounts */}
-                    <div className="text-right shrink-0">
-                      <p className="text-lg font-black text-gray-900 leading-none">{totalVES.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
-                      <p className="text-[10px] font-bold text-gray-400 mt-1">${sale.total.toFixed(2)}</p>
+                    <div className="space-y-3">
+                        {filteredSales.length === 0 ? (
+                            <div className="py-12 text-center opacity-40">
+                                <p className="text-xs font-black uppercase text-gray-400">
+                                    {searchTerm ? 'No se encontraron resultados' : 'Sin movimientos recientes'}
+                                </p>
+                            </div>
+                        ) : (
+                            filteredSales.map(sale => {
+                                const totalVES = sale.total * sale.exchangeRate;
+                                const isCash = sale.paymentMethod === 'Cash';
+                                const isCredit = sale.paymentMethod === 'Credit';
+                                const isDebtPayment = sale.items.some(i => i.id === 'debt_payment');
+
+                                return (
+                                    <div
+                                        key={sale.id}
+                                        onClick={() => setSelectedSale(sale)}
+                                        className="flex items-center justify-between p-4 rounded-2xl hover:bg-gray-50 transition-colors border border-transparent hover:border-gray-100 cursor-pointer active:scale-[0.99] group"
+                                    >
+                                        <div className="flex items-center gap-4 flex-1 min-w-0 mr-4">
+                                            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 shadow-sm ${isCash ? 'bg-emerald-100 text-emerald-600' : isCredit ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`}>
+                                                {isCash ? <Banknote className="w-6 h-6" /> : isCredit ? <Wallet className="w-6 h-6" /> : sale.paymentMethod === 'PagoMovil' ? <Smartphone className="w-6 h-6" /> : <CreditCard className="w-6 h-6" />}
+                                            </div>
+                                            <div className="min-w-0 flex-1">
+                                                <p className="text-sm font-bold text-gray-800 truncate leading-tight">
+                                                    {isDebtPayment ? "Pago de Deuda" : getSaleDescription(sale)}
+                                                </p>
+                                                <div className="flex flex-wrap items-center gap-x-2 gap-y-1 mt-1">
+                                                    {isDebtPayment && (
+                                                        <span className="text-[10px] font-black text-emerald-600 bg-emerald-50 px-1.5 rounded uppercase tracking-wide">
+                                                            {getCustomerName(sale.customerId)}
+                                                        </span>
+                                                    )}
+
+                                                    {isCredit && <span className="text-[10px] font-black text-orange-500 bg-orange-50 px-1.5 rounded uppercase tracking-wide">{getCustomerName(sale.customerId)}</span>}
+                                                    <span className="text-[10px] font-medium text-gray-400">{new Date(sale.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
+                                                </div>
+                                            </div>
+                                        </div>
+
+                                        {isCredit ? (
+                                            <div className="text-right shrink-0">
+                                                <p className="text-lg font-black text-orange-500 leading-none">${sale.total.toFixed(2)}</p>
+                                                <p className="text-[10px] font-bold text-orange-300 mt-1 uppercase tracking-wide">Ref. Cr├®dito</p>
+                                            </div>
+                                        ) : (
+                                            <div className="text-right shrink-0">
+                                                <p className="text-lg font-black text-gray-900 leading-none">{totalVES.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs</p>
+                                                <p className="text-[10px] font-bold text-gray-400 mt-1">${sale.total.toFixed(2)}</p>
+                                            </div>
+                                        )}
+                                    </div>
+                                );
+                            })
+                        )}
                     </div>
-                  </div>
-                );
-              })
-            )}
-          </div>
-        </div>
-
-        {/* FLOATING ACTION BUTTON (FAB) PARA FACTURAR */}
-        <button
-          onClick={onOpenPOS}
-          className="fixed bottom-20 right-4 md:bottom-8 md:right-8 z-30 bg-gray-900 text-white pl-4 pr-6 py-4 rounded-full shadow-2xl shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:scale-105 active:scale-95 transition-all flex items-center gap-3 group"
-        >
-          <div className="bg-indigo-600 p-2 rounded-full group-hover:rotate-12 transition-transform">
-            <ShoppingCart className="w-5 h-5 text-white" />
-          </div>
-          <div className="flex flex-col items-start">
-            <span className="text-[10px] font-bold text-gray-400 uppercase leading-none">Ir a</span>
-            <span className="text-sm font-black text-white leading-none">FACTURAR</span>
-          </div>
-        </button>
-      </div>
-
-      {/* MODAL DE RECIBO / FACTURA - MOVED OUTSIDE OF ANIMATED CONTAINER */}
-      {selectedSale && (
-        <div
-          onClick={() => setSelectedSale(null)}
-          className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"
-        >
-          <div
-            onClick={(e) => e.stopPropagation()}
-            className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-scale-up flex flex-col max-h-[90vh]"
-          >
-
-            {/* Header Recibo */}
-            <div className="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-start">
-              <div>
-                <h3 className="font-black text-gray-900 text-lg uppercase tracking-tight">Recibo de Venta</h3>
-                <p className="text-xs text-gray-500 font-mono mt-1">ID: {selectedSale.id.slice(-6)}</p>
-              </div>
-              <button onClick={() => setSelectedSale(null)} className="bg-white p-2 rounded-full text-gray-400 hover:text-gray-900 shadow-sm">
-                <X className="w-5 h-5" />
-              </button>
+                </div>
+
+                <button
+                    onClick={onOpenPOS}
+                    className="fixed bottom-20 right-4 md:bottom-8 md:right-8 z-30 bg-gray-900 text-white px-6 py-4 rounded-full shadow-2xl shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:scale-105 active:scale-95 transition-all flex items-center gap-3 group"
+                >
+                    <div className="bg-indigo-600 p-2 rounded-full group-hover:rotate-12 transition-transform">
+                        <ShoppingCart className="w-5 h-5 text-white" />
+                    </div>
+                    <span className="text-sm font-black text-white uppercase tracking-wider">VENDER</span>
+                </button>
             </div>
 
-            {/* Contenido Recibo Scrollable */}
-            <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
-              <div className="text-center mb-6">
-                <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Fecha de Emisi├│n</p>
-                <p className="text-sm font-bold text-gray-900">
-                  {new Date(selectedSale.timestamp).toLocaleDateString()} ÔÇó {new Date(selectedSale.timestamp).toLocaleTimeString()}
-                </p>
-              </div>
-
-              <div className="space-y-4">
-                {/* Tabla Items */}
-                <div className="border-t border-b border-dashed border-gray-200 py-4 space-y-3">
-                  {selectedSale.items.map((item, idx) => (
-                    <div key={idx} className="flex justify-between items-start text-sm">
-                      <div className="flex gap-3">
-                        <span className="font-bold text-gray-900 w-6 text-center">{item.quantity}</span>
-                        <span className="text-gray-600 font-medium max-w-[150px] leading-tight">{item.name}</span>
-                      </div>
-                      <div className="text-right">
-                        <p className="font-bold text-gray-900">${(item.price * item.quantity).toFixed(2)}</p>
-                        <p className="text-[10px] text-gray-400">{(item.price * item.quantity * selectedSale.exchangeRate).toFixed(2)} Bs</p>
-                      </div>
+            {/* MODAL DE DETALLE ESPEC├ìFICO (NUEVO) */}
+            {activeDetail && (
+                <div className="fixed inset-0 bg-black/60 z-[70] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-fade-in">
+                    <div className="bg-white w-full sm:max-w-lg h-[80vh] sm:h-auto sm:max-h-[90vh] rounded-t-[2.5rem] sm:rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col animate-slide-up">
+                        {/* Header del Modal */}
+                        <div className={`p-6 bg-${getDetailColor()}-50 border-b border-${getDetailColor()}-100`}>
+                            <div className="flex justify-between items-start">
+                                <div>
+                                    <h3 className={`text-xl font-black text-${getDetailColor()}-900`}>{getDetailTitle()}</h3>
+                                    <p className={`text-xs text-${getDetailColor()}-600 font-bold uppercase tracking-widest mt-1`}>
+                                        Detalle de transacciones
+                                    </p>
+                                </div>
+                                <button onClick={() => setActiveDetail(null)} className="bg-white/50 hover:bg-white p-2 rounded-full transition-colors">
+                                    <X className={`w-5 h-5 text-${getDetailColor()}-900`} />
+                                </button>
+                            </div>
+
+                            {/* Resumen Superior */}
+                            <div className="mt-4 flex gap-4">
+                                {activeDetail === 'Cash' && (
+                                    <div className="bg-white/60 p-3 rounded-xl flex-1">
+                                        <p className="text-[10px] uppercase font-bold text-gray-500">Base Inicial</p>
+                                        <p className="text-lg font-black text-gray-900">{baseCash.toLocaleString('es-VE')} Bs</p>
+                                    </div>
+                                )}
+                                <div className="bg-white/80 p-3 rounded-xl flex-1">
+                                    <p className="text-[10px] uppercase font-bold text-gray-500">Total {activeDetail === 'Cash' ? 'Ventas' : 'Acumulado'}</p>
+                                    <p className={`text-lg font-black text-${getDetailColor()}-600`}>
+                                        {activeDetail === 'Cash' ? salesCashBs.toLocaleString('es-VE') :
+                                            activeDetail === 'Card' ? salesCardBs.toLocaleString('es-VE') :
+                                                salesPagoMovilBs.toLocaleString('es-VE')} Bs
+                                    </p>
+                                </div>
+                                {activeDetail === 'Cash' && (
+                                    <div className="bg-white p-3 rounded-xl flex-1 shadow-sm border border-emerald-100">
+                                        <p className="text-[10px] uppercase font-bold text-emerald-600">Total Caja</p>
+                                        <p className="text-lg font-black text-emerald-800">{totalCashInDrawer.toLocaleString('es-VE')} Bs</p>
+                                    </div>
+                                )}
+                            </div>
+                        </div>
+
+                        {/* Lista de Movimientos */}
+                        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-white">
+                            {getDetailSales().length === 0 ? (
+                                <div className="flex flex-col items-center justify-center h-full opacity-40">
+                                    <History className="w-12 h-12 text-gray-300 mb-2" />
+                                    <p className="text-xs font-black uppercase text-gray-400">Sin movimientos</p>
+                                </div>
+                            ) : (
+                                getDetailSales().map(sale => (
+                                    <div key={sale.id} className="flex items-center justify-between p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors rounded-xl">
+                                        <div className="flex items-center gap-3">
+                                            <div className={`p-2 rounded-lg bg-${getDetailColor()}-50 text-${getDetailColor()}-600`}>
+                                                {activeDetail === 'Cash' ? <Banknote className="w-4 h-4" /> :
+                                                    activeDetail === 'Card' ? <CreditCard className="w-4 h-4" /> :
+                                                        <Smartphone className="w-4 h-4" />}
+                                            </div>
+                                            <div>
+                                                <p className="text-xs font-bold text-gray-900 line-clamp-1">
+                                                    {sale.items.some(i => i.id === 'debt_payment') ? `Pago: ${getCustomerName(sale.customerId)}` : getSaleDescription(sale)}
+                                                </p>
+                                                <p className="text-[10px] text-gray-400 font-medium">
+                                                    {new Date(sale.timestamp).toLocaleTimeString()}
+                                                </p>
+                                            </div>
+                                        </div>
+                                        <div className="text-right">
+                                            <p className="text-sm font-black text-gray-900">{(sale.total * sale.exchangeRate).toLocaleString('es-VE', { maximumFractionDigits: 2 })} Bs</p>
+                                            <p className="text-[9px] font-bold text-gray-400">${sale.total.toFixed(2)}</p>
+                                        </div>
+                                    </div>
+                                ))
+                            )}
+                        </div>
+
+                        {/* Footer para acciones espec├¡ficas */}
+                        {activeDetail === 'Cash' && (
+                            <div className="p-4 border-t border-gray-100 bg-gray-50">
+                                <button
+                                    onClick={() => { setShowAdjustmentModal(true); }}
+                                    className="w-full py-3 bg-white border border-emerald-200 text-emerald-700 rounded-xl font-black uppercase tracking-widest text-xs shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2"
+                                >
+                                    <Edit className="w-4 h-4" /> Ajustar Caja Chica / Base
+                                </button>
+                            </div>
+                        )}
                     </div>
-                  ))}
                 </div>
+            )}
 
-                {/* Totales */}
-                <div className="space-y-2 pt-2">
-                  <div className="flex justify-between items-center">
-                    <span className="text-xs font-bold text-gray-400 uppercase">Subtotal USD</span>
-                    <span className="text-sm font-bold text-gray-900">${selectedSale.total.toFixed(2)}</span>
-                  </div>
-                  <div className="flex justify-between items-center">
-                    <span className="text-xs font-bold text-gray-400 uppercase">Tasa de Cambio</span>
-                    <span className="text-sm font-bold text-gray-900">{selectedSale.exchangeRate.toFixed(2)} Bs/$</span>
-                  </div>
-                  <div className="flex justify-between items-center pt-2 border-t border-gray-100 mt-2">
-                    <span className="text-base font-black text-gray-900 uppercase">Total Pagado</span>
-                    <span className="text-xl font-black text-indigo-600">{(selectedSale.total * selectedSale.exchangeRate).toFixed(2)} Bs</span>
-                  </div>
-                </div>
+            {/* MODAL DE AJUSTE DE EFECTIVO (Base) */}
+            {showAdjustmentModal && (
+                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
+                    <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm animate-scale-up shadow-2xl">
+                        <div className="text-center mb-6">
+                            <div className="bg-emerald-100 w-16 h-16 rounded-2xl flex items-center justify-center text-emerald-600 mb-4 mx-auto">
+                                <Banknote className="w-8 h-8" />
+                            </div>
+                            <h3 className="text-2xl font-black text-gray-900">Ajuste de Caja Chica</h3>
+                            <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Ingreso o Retiro de Efectivo</p>
+                        </div>
+
+                        <div className="space-y-4">
+                            <div className="relative">
+                                <span className="absolute left-4 top-1/2 -translate-y-1/2 font-black text-emerald-300">Bs</span>
+                                <input
+                                    autoFocus
+                                    type="number"
+                                    placeholder="0.00"
+                                    className="w-full pl-10 pr-4 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-2xl font-black text-gray-900 text-center outline-none focus:border-emerald-500 focus:bg-white transition-all"
+                                    value={adjustmentAmount}
+                                    onChange={(e) => setAdjustmentAmount(e.target.value)}
+                                />
+                            </div>
+                        </div>
+
+                        <div className="grid grid-cols-2 gap-3 mt-8">
+                            <button
+                                onClick={() => handleCashAdjustment('subtract')}
+                                className="py-4 bg-red-50 text-red-600 font-black rounded-2xl border border-red-100 active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-red-100"
+                            >
+                                <Minus className="w-4 h-4" /> RETIRAR
+                            </button>
+                            <button
+                                onClick={() => handleCashAdjustment('add')}
+                                className="py-4 bg-emerald-50 text-emerald-600 font-black rounded-2xl border border-emerald-100 active:scale-95 transition-all flex items-center justify-center gap-2 hover:bg-emerald-100"
+                            >
+                                <Plus className="w-4 h-4" /> INGRESAR
+                            </button>
+                        </div>
 
-                {/* M├®todo de Pago */}
-                <div className="bg-gray-50 p-3 rounded-xl flex items-center justify-between mt-4">
-                  <span className="text-xs font-bold text-gray-500 uppercase">M├®todo</span>
-                  <span className="text-xs font-black uppercase text-gray-900 flex items-center gap-2">
-                    {selectedSale.paymentMethod === 'Cash' ? <Banknote className="w-4 h-4 text-emerald-500" /> :
-                      selectedSale.paymentMethod === 'Credit' ? <Wallet className="w-4 h-4 text-orange-500" /> :
-                        <CreditCard className="w-4 h-4 text-blue-500" />}
-                    {selectedSale.paymentMethod === 'Cash' ? 'Efectivo' :
-                      selectedSale.paymentMethod === 'PagoMovil' ? 'Pago M├│vil' :
-                        selectedSale.paymentMethod === 'Credit' ? 'Cr├®dito' : 'Tarjeta'}
-                  </span>
+                        <button
+                            onClick={() => setShowAdjustmentModal(false)}
+                            className="w-full mt-3 py-3 text-gray-400 font-bold text-xs uppercase tracking-widest hover:text-gray-600"
+                        >
+                            Cancelar
+                        </button>
+                    </div>
                 </div>
+            )}
 
-                {selectedSale.paymentMethod === 'Credit' && (
-                  <div className="bg-orange-50 p-3 rounded-xl flex items-center justify-between">
-                    <span className="text-xs font-bold text-orange-600 uppercase">Cliente</span>
-                    <span className="text-xs font-black uppercase text-orange-800">
-                      {getCustomerName(selectedSale.customerId)}
-                    </span>
-                  </div>
-                )}
-              </div>
-            </div>
+            {/* MODAL DE CORTE Z (Cierre) */}
+            {showCutoffModal && (
+                <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
+                    <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-md animate-scale-up shadow-2xl">
+                        <div className="text-center mb-6">
+                            <div className="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center text-indigo-600 mb-4 mx-auto">
+                                <RotateCcw className="w-8 h-8" />
+                            </div>
+                            <h3 className="text-2xl font-black text-gray-900">Corte de Caja</h3>
+                            <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Consolidar Ventas a Balance</p>
+                        </div>
 
-            {/* Footer Acciones */}
-            <div className="p-6 border-t border-gray-100 bg-gray-50">
-              <div className="grid grid-cols-2 gap-3">
-                {/* Bot├│n Corregir (Editar) */}
-                <button
-                  type="button"
-                  onClick={handleEdit}
-                  className="w-full py-4 border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-2xl font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all active:scale-95"
-                >
-                  <Edit className="w-4 h-4" /> Corregir
-                </button>
+                        <div className="space-y-6">
+                            {/* Secci├│n Bancos */}
+                            <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-3">
+                                <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b border-gray-200 pb-1 mb-2">Bancos y Puntos</p>
+
+                                {/* Pago M├│vil Info */}
+                                <div className="flex justify-between items-center text-xs">
+                                    <span className="font-bold text-gray-500">Pago M├│vil (Hoy)</span>
+                                    <span className="font-black text-emerald-600">+{salesPagoMovilBs.toLocaleString('es-VE')} Bs</span>
+                                </div>
+                                <p className="text-[9px] text-gray-400 text-right mb-2">* Ya est├í en el Banco</p>
+
+                                {/* Punto Input */}
+                                <div>
+                                    <div className="flex justify-between items-center mb-1">
+                                        <span className="font-bold text-blue-600 text-xs">Punto a Liquidar</span>
+                                    </div>
+                                    <input
+                                        type="number"
+                                        className="w-full p-2 bg-white border border-blue-100 rounded-lg font-black text-right text-blue-900 outline-none focus:border-blue-500"
+                                        value={cutoffCardLiquidate}
+                                        onChange={(e) => setCutoffCardLiquidate(e.target.value)}
+                                    />
+                                </div>
+                                <p className="text-[9px] text-gray-400 text-right">Se transfiere al Balance (Banco)</p>
+                            </div>
+
+                            {/* Secci├│n Efectivo */}
+                            <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 space-y-3">
+                                <div className="flex justify-between items-center border-b border-emerald-200 pb-2 mb-2">
+                                    <span className="text-[10px] font-black text-emerald-800 uppercase">Total Efectivo Actual</span>
+                                    <span className="text-sm font-black text-emerald-700">{totalCashInDrawer.toLocaleString('es-VE')} Bs</span>
+                                </div>
+
+                                <div>
+                                    <div className="flex justify-between items-center mb-1">
+                                        <span className="font-bold text-emerald-700 text-xs">Dejar de Base (Caja Chica)</span>
+                                    </div>
+                                    <input
+                                        type="number"
+                                        className="w-full p-2 bg-white border border-emerald-200 rounded-lg font-black text-right text-emerald-900 outline-none focus:border-emerald-500"
+                                        value={cutoffBaseToKeep}
+                                        onChange={(e) => setCutoffBaseToKeep(e.target.value)}
+                                    />
+                                </div>
+
+                                <div className="flex justify-between items-center pt-1">
+                                    <span className="text-[10px] font-bold text-emerald-600 uppercase">Se registra ingreso:</span>
+                                    <span className="text-xs font-black text-emerald-800">
+                                        {(totalCashInDrawer - (parseFloat(cutoffBaseToKeep) || 0)).toLocaleString('es-VE')} Bs
+                                    </span>
+                                </div>
+                            </div>
+                        </div>
 
-                {/* Bot├│n Anular (Eliminar) */}
-                <button
-                  type="button"
-                  onClick={handleVoid}
-                  className="w-full py-4 border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 rounded-2xl font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all active:scale-95"
+                        <div className="flex gap-3 mt-8">
+                            <button onClick={() => setShowCutoffModal(false)} className="flex-1 py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl active:scale-95 transition-colors hover:bg-gray-200">Cancelar</button>
+                            <button onClick={confirmCutoff} className="flex-1 py-4 bg-gray-900 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2">
+                                <CheckCircle2 className="w-4 h-4" /> CONFIRMAR CIERRE
+                            </button>
+                        </div>
+                    </div>
+                </div>
+            )}
+
+            {/* DETALLE DE VENTA */}
+            {selectedSale && (
+                <div
+                    onClick={() => setSelectedSale(null)}
+                    className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"
                 >
-                  <Trash2 className="w-4 h-4" /> Eliminar
-                </button>
-              </div>
-            </div>
-          </div>
-        </div>
-      )}
+                    <div
+                        onClick={(e) => e.stopPropagation()}
+                        className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-scale-up flex flex-col max-h-[90vh]"
+                    >
+                        <div className="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-start">
+                            <div>
+                                <h3 className="font-black text-gray-900 text-lg uppercase tracking-tight">Recibo de Venta</h3>
+                                <p className="text-xs text-gray-500 font-mono mt-1">ID: {selectedSale.id.slice(-6)}</p>
+                            </div>
+                            <button onClick={() => setSelectedSale(null)} className="bg-white p-2 rounded-full text-gray-400 hover:text-gray-900 shadow-sm">
+                                <X className="w-5 h-5" />
+                            </button>
+                        </div>
+                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
+                            <div className="text-center mb-6">
+                                <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Fecha de Emisi├│n</p>
+                                <p className="text-sm font-bold text-gray-900">
+                                    {new Date(selectedSale.timestamp).toLocaleDateString()} ÔÇó {new Date(selectedSale.timestamp).toLocaleTimeString()}
+                                </p>
+                            </div>
+
+                            <div className="space-y-4">
+                                <div className="border-t border-b border-dashed border-gray-200 py-4 space-y-3">
+                                    {selectedSale.items.map((item, idx) => (
+                                        <div key={idx} className="flex justify-between items-start text-sm">
+                                            <div className="flex gap-3">
+                                                <span className="font-bold text-gray-900 w-6 text-center">{item.quantity}</span>
+                                                <span className="text-gray-600 font-medium max-w-[150px] leading-tight">{item.name}</span>
+                                            </div>
+                                            <div className="text-right">
+                                                <p className="font-bold text-gray-900">${(item.price * item.quantity).toFixed(2)}</p>
+                                                <p className="text-[10px] text-gray-400">{(item.price * item.quantity * selectedSale.exchangeRate).toFixed(2)} Bs</p>
+                                            </div>
+                                        </div>
+                                    ))}
+                                </div>
+
+                                <div className="space-y-2 pt-2">
+                                    <div className="flex justify-between items-center">
+                                        <span className="text-xs font-bold text-gray-400 uppercase">Subtotal USD</span>
+                                        <span className="text-sm font-bold text-gray-900">${selectedSale.total.toFixed(2)}</span>
+                                    </div>
+                                    <div className="flex justify-between items-center">
+                                        <span className="text-xs font-bold text-gray-400 uppercase">Tasa de Cambio</span>
+                                        <span className="text-sm font-bold text-gray-900">{selectedSale.exchangeRate.toFixed(2)} Bs/$</span>
+                                    </div>
+
+                                    {/* L├│gica condicional para mostrar el total */}
+                                    {selectedSale.paymentMethod === 'Credit' ? (
+                                        <div className="flex justify-between items-center pt-2 border-t border-gray-100 mt-2">
+                                            <span className="text-base font-black text-orange-500 uppercase">Total a Cr├®dito (Ref)</span>
+                                            <span className="text-xl font-black text-orange-600">${selectedSale.total.toFixed(2)}</span>
+                                        </div>
+                                    ) : (
+                                        <div className="flex justify-between items-center pt-2 border-t border-gray-100 mt-2">
+                                            <span className="text-base font-black text-gray-900 uppercase">Total Pagado</span>
+                                            <span className="text-xl font-black text-indigo-600">{(selectedSale.total * selectedSale.exchangeRate).toFixed(2)} Bs</span>
+                                        </div>
+                                    )}
+                                </div>
+
+                                <div className="bg-gray-50 p-3 rounded-xl flex items-center justify-between mt-4">
+                                    <span className="text-xs font-bold text-gray-500 uppercase">M├®todo</span>
+                                    <span className="text-xs font-black uppercase text-gray-900 flex items-center gap-2">
+                                        {selectedSale.paymentMethod === 'Cash' ? <Banknote className="w-4 h-4 text-emerald-500" /> :
+                                            selectedSale.paymentMethod === 'Credit' ? <Wallet className="w-4 h-4 text-orange-500" /> :
+                                                selectedSale.paymentMethod === 'PagoMovil' ? <Smartphone className="w-4 h-4 text-purple-500" /> :
+                                                    <CreditCard className="w-4 h-4 text-blue-500" />}
+                                        {selectedSale.paymentMethod === 'Cash' ? 'Efectivo' :
+                                            selectedSale.paymentMethod === 'PagoMovil' ? 'Pago M├│vil' :
+                                                selectedSale.paymentMethod === 'Credit' ? 'Cr├®dito' : 'Tarjeta'}
+                                    </span>
+                                </div>
+
+                                {selectedSale.paymentMethod === 'Credit' && (
+                                    <div className="bg-orange-50 p-3 rounded-xl flex items-center justify-between">
+                                        <span className="text-xs font-bold text-orange-600 uppercase">Cliente</span>
+                                        <span className="text-xs font-black uppercase text-orange-800">
+                                            {getCustomerName(selectedSale.customerId)}
+                                        </span>
+                                    </div>
+                                )}
+                            </div>
+                        </div>
 
-      <style>{`
+                        <div className="p-6 border-t border-gray-100 bg-gray-50">
+                            <div className="grid grid-cols-2 gap-3">
+                                <button
+                                    type="button"
+                                    onClick={handleEdit}
+                                    className="w-full py-4 border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-2xl font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all active:scale-95"
+                                >
+                                    <Edit className="w-4 h-4" /> Corregir
+                                </button>
+                                <button
+                                    type="button"
+                                    onClick={handleVoid}
+                                    className="w-full py-4 border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 rounded-2xl font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all active:scale-95"
+                                >
+                                    <Trash2 className="w-4 h-4" /> Eliminar
+                                </button>
+                            </div>
+                        </div>
+                    </div>
+                </div>
+            )}
+
+            <style>{`
         @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
         @keyframes scale-up { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
+        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
         .animate-fade-in { animation: fade-in 0.3s ease-out; }
         .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
+        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
         .custom-scrollbar::-webkit-scrollbar { width: 4px; }
         .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
       `}</style>
-    </>
-  );
+        </>
+    );
 };
 
-export default VentasCaja;
\ No newline at end of file
+export default VentasCaja;
diff --git a/components/Settings.tsx b/components/Settings.tsx
index bb23753..89a09a1 100644
--- a/components/Settings.tsx
+++ b/components/Settings.tsx
@@ -1,233 +1,254 @@
 
 import React, { useState, useEffect } from 'react';
-import { Trash2, TrendingUp, QrCode, Copy, Check, Globe, Smartphone, Monitor, Lock, Unlock, MousePointer2, CloudOff, Cloud, Info, Calendar, Edit, Save, X } from 'lucide-react';
-import { Product, Customer, Sale, ExchangeRateRecord } from '../types';
+import { Smartphone, HardDrive, Upload, Download, FileSpreadsheet, Zap, Package, Users, AlertTriangle, X, Settings as SettingsIcon } from 'lucide-react';
+import { Product, Customer, Sale } from '../types';
+import { saveData, syncPath, isCloudEnabled } from '../services/supabaseService';
+import { Cloud, CloudOff } from 'lucide-react';
 
 interface SettingsProps {
-  products: Product[];
-  customers: Customer[];
-  sales: Sale[];
-  exchangeRate: number;
-  rateHistory: ExchangeRateRecord[];
-  onExchangeRateChange: (rate: number) => void;
-  onHistoryUpdate: (record: ExchangeRateRecord) => void;
-  onHistoryDelete: (id: string) => void;
-  onImport: (data: { products: Product[]; customers: Customer[]; sales: Sale[] }) => void;
-  onReset: () => void;
+    isOpen: boolean;
+    onClose: () => void;
+    products: Product[];
+    customers: Customer[];
+    sales: Sale[];
+    onImport: () => void;
+    onReset: () => void;
+    autoSync: boolean;
+    onToggleAutoSync: () => void;
+    installApp?: () => void;
 }
 
-const Settings: React.FC<SettingsProps> = ({ products, customers, sales, exchangeRate, rateHistory = [], onExchangeRateChange, onHistoryUpdate, onHistoryDelete, onImport, onReset }) => {
-  const [localRate, setLocalRate] = useState(exchangeRate.toString());
-  const [currentUrl, setCurrentUrl] = useState('');
-  const [copied, setCopied] = useState(false);
-  
-  // State for editing history
-  const [editingId, setEditingId] = useState<string | null>(null);
-  const [editRate, setEditRate] = useState<string>('');
-  const [editDate, setEditDate] = useState<string>('');
-
-  useEffect(() => {
-    setCurrentUrl(window.location.href);
-    setLocalRate(exchangeRate.toString());
-  }, [exchangeRate]);
-
-  const handleUpdateRate = (e: React.FormEvent) => {
-    e.preventDefault();
-    const rate = parseFloat(localRate);
-    if (rate > 0) onExchangeRateChange(rate);
-  };
-
-  const copyUrl = () => {
-    navigator.clipboard.writeText(currentUrl);
-    setCopied(true);
-    setTimeout(() => setCopied(false), 2000);
-  };
-
-  const startEditing = (record: ExchangeRateRecord) => {
-    setEditingId(record.id);
-    setEditRate(record.rate.toString());
-    // Format timestamp to YYYY-MM-DD for input[type="date"]
-    const date = new Date(record.timestamp);
-    const dateStr = date.toISOString().split('T')[0];
-    setEditDate(dateStr);
-  };
-
-  const saveEditing = (id: string) => {
-    const rate = parseFloat(editRate);
-    if (rate > 0 && editDate) {
-      // Create timestamp from date string (at noon to avoid timezone shift issues)
-      const timestamp = new Date(editDate + 'T12:00:00').getTime();
-      // Fix: Removed 'dateString' as it is not a valid property of ExchangeRateRecord
-      onHistoryUpdate({
-        id,
-        rate,
-        timestamp
-      });
-      setEditingId(null);
-    }
-  };
-
-  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(currentUrl)}`;
-
-  // Sort history by date descending
-  const sortedHistory = [...rateHistory].sort((a, b) => b.timestamp - a.timestamp);
-
-  return (
-    <div className="space-y-8 pb-24 max-w-5xl mx-auto px-2">
-      {/* HEADER */}
-      <div className="bg-gradient-to-r from-gray-900 to-indigo-900 p-8 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
-        <div className="relative z-10">
-          <h2 className="text-3xl font-black mb-2">Ajustes & Conexi├│n</h2>
-          <p className="text-indigo-200 font-medium opacity-90 max-w-md">
-            Gestiona la tasa de cambio y conecta tus dispositivos.
-          </p>
-        </div>
-        <Smartphone className="absolute -right-6 -bottom-6 w-48 h-48 text-white/5 rotate-12" />
-      </div>
-
-      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
-        
-        {/* COLUMNA IZQUIERDA: TASA Y QR */}
-        <div className="space-y-8">
-            <div className="bg-white p-8 rounded-[2.5rem] border-2 border-gray-100 shadow-sm">
-                <div className="flex items-center gap-4 mb-6">
-                <div className="bg-emerald-100 w-12 h-12 rounded-2xl flex items-center justify-center text-emerald-600">
-                    <TrendingUp className="w-6 h-6" />
-                </div>
-                <div>
-                    <h3 className="text-lg font-black text-gray-900">Tasa de Cambio (BCV)</h3>
-                    <p className="text-xs text-gray-400 font-bold uppercase">Actualizar Valor Hoy</p>
-                </div>
-                </div>
-                <form onSubmit={handleUpdateRate} className="space-y-4">
-                <div className="relative">
-                    <span className="absolute left-5 top-1/2 -translate-y-1/2 font-black text-gray-400 text-xl">Bs.</span>
-                    <input 
-                    type="number" 
-                    step="0.01"
-                    value={localRate}
-                    onChange={(e) => setLocalRate(e.target.value)}
-                    className="w-full pl-16 pr-4 py-5 bg-gray-50 border-2 border-gray-100 rounded-2xl text-2xl font-black text-gray-700 outline-none focus:border-emerald-500 focus:bg-white transition-all shadow-inner"
-                    />
-                </div>
-                <button type="submit" className="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase tracking-widest text-xs shadow-lg shadow-emerald-100 active:scale-95 transition-all">
-                    Guardar Nueva Tasa
-                </button>
-                </form>
-            </div>
-
-            {/* C├│digo QR */}
-            <div className="bg-white p-8 rounded-[2.5rem] border-2 border-gray-100 shadow-xl flex flex-col items-center justify-center text-center">
-            <div className="bg-gray-900 p-6 rounded-[2.5rem] mb-6 shadow-2xl group relative">
-                <div className="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-[2.5rem] opacity-20 blur-xl group-hover:opacity-40 transition-opacity"></div>
-                <img src={qrUrl} alt="QR" className="relative w-56 h-56 md:w-64 md:h-64 object-contain rounded-xl mix-blend-screen" />
-            </div>
-            <div className="space-y-4 w-full">
-                <div className="bg-indigo-50 p-4 rounded-2xl flex items-center justify-between gap-3 overflow-hidden border border-indigo-100">
-                <div className="truncate flex-1 text-left">
-                    <p className="text-[10px] font-black text-indigo-400 uppercase">Tu Enlace Personal</p>
-                    <p className="text-xs font-mono truncate text-indigo-900 font-bold">{currentUrl}</p>
-                </div>
-                <button onClick={copyUrl} className="bg-white p-3 rounded-xl shadow-sm hover:bg-indigo-600 hover:text-white transition-all active:scale-90 shrink-0 border border-indigo-100">
-                    {copied ? <Check className="w-5 h-5" /> : <Copy className="w-5 h-5" />}
-                </button>
-                </div>
-            </div>
-            </div>
-        </div>
-
-        {/* COLUMNA DERECHA: HISTORIAL */}
-        <div className="space-y-6">
-            <div className="bg-white rounded-[2.5rem] border-2 border-gray-100 shadow-sm overflow-hidden flex flex-col max-h-[600px]">
-                <div className="p-8 border-b border-gray-100">
-                    <div className="flex items-center gap-4">
-                        <div className="bg-indigo-100 w-12 h-12 rounded-2xl flex items-center justify-center text-indigo-600">
-                            <Calendar className="w-6 h-6" />
+const Settings: React.FC<SettingsProps> = ({ isOpen, onClose, products, customers, sales, onImport, onReset, installApp }) => {
+    const [sheetsUrl, setSheetsUrl] = useState('');
+    const [syncStatus, setSyncStatus] = useState<'idle' | 'syncing' | 'success' | 'error'>('idle');
+
+    useEffect(() => {
+        if (isOpen) {
+            const unsub = syncPath('settings/sheetsUrl', (data) => {
+                setSheetsUrl(data || '');
+            });
+            return () => unsub();
+        }
+    }, [isOpen]);
+
+    if (!isOpen) return null;
+
+    const handleSaveSheetsUrl = () => {
+        saveData('settings/sheetsUrl', sheetsUrl);
+        alert("Configuraci├│n de Google Sheets guardada.");
+    };
+
+    const triggerUpload = async (type: 'sales' | 'inventory' | 'customers') => {
+        if (!sheetsUrl) return alert("Primero configura la URL de Google Sheets.");
+        setSyncStatus('syncing');
+
+        try {
+            let payload: any = [];
+            if (type === 'sales') {
+                // Enriquecer ventas con nombres de clientes
+                payload = sales.map(s => ({
+                    ...s,
+                    customerName: customers.find(c => c.id === s.customerId)?.name || 'General'
+                }));
+            } else if (type === 'inventory') {
+                payload = products;
+            } else if (type === 'customers') {
+                payload = customers;
+            }
+
+            await fetch(sheetsUrl, {
+                method: 'POST',
+                mode: 'no-cors',
+                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
+                body: JSON.stringify({ type, payload })
+            });
+
+            setSyncStatus('success');
+            alert('Datos enviados a Google Sheets correctamente (Modo No-CORS)');
+            setTimeout(() => setSyncStatus('idle'), 3000);
+        } catch (e) {
+            console.error(e);
+            setSyncStatus('error');
+            alert('Error al enviar datos. Verifica la URL del Script.');
+            setTimeout(() => setSyncStatus('idle'), 3000);
+        }
+    };
+
+    const handleLocalExport = () => {
+        try {
+            const backup = {
+                products: localStorage.getItem('pointy_data_products'),
+                customers: localStorage.getItem('pointy_data_customers'),
+                sales: localStorage.getItem('pointy_data_sales'),
+                settings: localStorage.getItem('pointy_data_settings'),
+                treasury: localStorage.getItem('pointy_data_treasury'),
+                timestamp: Date.now()
+            };
+
+            const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
+            const url = URL.createObjectURL(blob);
+            const a = document.createElement('a');
+            a.href = url;
+            a.download = `pointy_backup_${new Date().toISOString().split('T')[0]}.json`;
+            document.body.appendChild(a);
+            a.click();
+            document.body.removeChild(a);
+        } catch (e) {
+            alert("Error al exportar datos locales.");
+        }
+    };
+
+    const handleLocalImport = (e: React.ChangeEvent<HTMLInputElement>) => {
+        const file = e.target.files?.[0];
+        if (!file) return;
+
+        const reader = new FileReader();
+        reader.onload = (event) => {
+            try {
+                const backup = JSON.parse(event.target?.result as string);
+                if (backup.products) localStorage.setItem('pointy_data_products', backup.products);
+                if (backup.customers) localStorage.setItem('pointy_data_customers', backup.customers);
+                if (backup.sales) localStorage.setItem('pointy_data_sales', backup.sales);
+                if (backup.settings) localStorage.setItem('pointy_data_settings', backup.settings);
+                if (backup.treasury) localStorage.setItem('pointy_data_treasury', backup.treasury);
+
+                alert('Respaldo restaurado con ├®xito. La aplicaci├│n se reiniciar├í.');
+                window.location.reload();
+            } catch (err) {
+                alert('Error al leer el archivo de respaldo');
+            }
+        };
+        reader.readAsText(file);
+    };
+
+    return (
+        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
+            <div className="bg-white rounded-[2.5rem] w-full max-w-2xl shadow-2xl overflow-hidden animate-scale-up flex flex-col max-h-[90vh]">
+
+                {/* Header */}
+                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
+                    <div className="flex items-center gap-3">
+                        <div className="bg-gray-900 p-2 rounded-xl text-white">
+                            <SettingsIcon className="w-6 h-6" />
                         </div>
                         <div>
-                            <h3 className="text-lg font-black text-gray-900">Hist├│rico de Tasas</h3>
-                            <p className="text-xs text-gray-400 font-bold uppercase">Registro de cambios</p>
+                            <h3 className="text-xl font-black text-gray-900 leading-tight">Ajustes</h3>
+                            <div className="flex items-center gap-1.5 mt-0.5">
+                                {isCloudEnabled ? (
+                                    <div className="flex items-center gap-1 text-[10px] font-black text-emerald-500 uppercase">
+                                        <Cloud className="w-3 h-3" /> Conectado a la Nube
+                                    </div>
+                                ) : (
+                                    <div className="flex items-center gap-1 text-[10px] font-black text-orange-400 uppercase">
+                                        <CloudOff className="w-3 h-3" /> Modo Local (Sin Nube)
+                                    </div>
+                                )}
+                            </div>
                         </div>
                     </div>
+                    <button onClick={onClose} className="bg-white p-2 rounded-full text-gray-400 hover:text-gray-900 shadow-sm transition-colors">
+                        <X className="w-5 h-5" />
+                    </button>
                 </div>
 
-                <div className="overflow-y-auto flex-1 p-4">
-                    {sortedHistory.length === 0 ? (
-                        <div className="text-center py-10 text-gray-400 text-sm">No hay historial registrado a├║n.</div>
-                    ) : (
-                        <div className="space-y-3">
-                            {sortedHistory.map(record => (
-                                <div key={record.id} className="flex items-center justify-between bg-gray-50 p-4 rounded-2xl border border-gray-100 hover:border-indigo-200 transition-colors group">
-                                    {editingId === record.id ? (
-                                        // MODO EDICI├ôN
-                                        <div className="flex-1 flex items-center gap-2">
-                                            <input 
-                                                type="date" 
-                                                className="bg-white border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-700 outline-none focus:border-indigo-500"
-                                                value={editDate}
-                                                onChange={(e) => setEditDate(e.target.value)}
-                                            />
-                                            <input 
-                                                type="number" 
-                                                step="0.01"
-                                                className="w-20 bg-white border border-gray-200 rounded-lg p-2 text-xs font-black text-emerald-600 outline-none focus:border-emerald-500"
-                                                value={editRate}
-                                                onChange={(e) => setEditRate(e.target.value)}
-                                            />
-                                            <div className="flex gap-1 ml-auto">
-                                                <button onClick={() => saveEditing(record.id)} className="p-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600"><Save className="w-4 h-4"/></button>
-                                                <button onClick={() => setEditingId(null)} className="p-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300"><X className="w-4 h-4"/></button>
-                                            </div>
-                                        </div>
-                                    ) : (
-                                        // MODO VISUALIZACI├ôN
-                                        <>
-                                            <div className="flex flex-col">
-                                                <span className="text-xs font-bold text-gray-400 uppercase">
-                                                    {new Date(record.timestamp).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
-                                                </span>
-                                                <span className="text-lg font-black text-emerald-600 tracking-tight">{record.rate.toFixed(2)} Bs.</span>
-                                            </div>
-                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
-                                                <button onClick={() => startEditing(record)} className="p-2 bg-white text-indigo-600 rounded-xl hover:bg-indigo-50 shadow-sm border border-gray-100"><Edit className="w-4 h-4"/></button>
-                                                <button onClick={() => onHistoryDelete(record.id)} className="p-2 bg-white text-red-500 rounded-xl hover:bg-red-50 shadow-sm border border-gray-100"><Trash2 className="w-4 h-4"/></button>
-                                            </div>
-                                        </>
-                                    )}
+                <div className="overflow-y-auto p-6 space-y-6">
+
+                    {/* BOT├ôN DE INSTALACI├ôN */}
+                    {installApp && (
+                        <button
+                            onClick={installApp}
+                            className="w-full p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-[2rem] shadow-lg shadow-indigo-200 flex items-center justify-between group active:scale-[0.98] transition-transform"
+                        >
+                            <div className="flex items-center gap-3">
+                                <div className="bg-white/20 p-2 rounded-xl">
+                                    <Smartphone className="w-6 h-6" />
                                 </div>
-                            ))}
-                        </div>
+                                <div className="text-left">
+                                    <p className="font-black text-sm uppercase">Instalar Aplicaci├│n</p>
+                                    <p className="text-[10px] text-white/80 font-medium">Usar sin internet</p>
+                                </div>
+                            </div>
+                            <Download className="w-5 h-5 mr-2 group-hover:translate-y-1 transition-transform" />
+                        </button>
                     )}
-                </div>
-            </div>
 
-            <div className="bg-red-50/50 p-6 rounded-[2rem] border border-red-100">
-                <h4 className="text-sm font-black text-red-900 mb-4 flex items-center gap-2">
-                <Trash2 className="w-4 h-4" />
-                Zona de Peligro
-                </h4>
-                <div className="flex gap-2">
-                    <button onClick={() => {
-                    const data = { products, customers, sales, exchangeRate };
-                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
-                    const url = URL.createObjectURL(blob);
-                    const a = document.createElement('a');
-                    a.href = url;
-                    a.download = 'pointy_backup.json';
-                    a.click();
-                }} className="flex-1 py-3 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase text-indigo-600 hover:bg-indigo-50 transition-all">
-                    Respaldar Datos
-                    </button>
-                    <button onClick={onReset} className="px-4 py-3 bg-white border border-red-200 rounded-xl text-red-500 hover:bg-red-50 transition-all">
-                    Borrar Todo
-                    </button>
+                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
+                        {/* Local Backup */}
+                        <div className="bg-white p-6 rounded-[2rem] border-2 border-gray-100 shadow-sm relative overflow-hidden">
+                            <div className="flex items-center gap-3 mb-4">
+                                <div className="bg-orange-100 p-2 rounded-xl text-orange-600">
+                                    <HardDrive className="w-5 h-5" />
+                                </div>
+                                <h3 className="font-black text-gray-900 text-sm uppercase">Respaldo Local</h3>
+                            </div>
+
+                            <div className="space-y-3">
+                                <button onClick={handleLocalExport} className="w-full p-3 bg-gray-900 text-white rounded-xl font-bold uppercase tracking-widest text-[10px] shadow-sm active:scale-95 flex items-center justify-center gap-2">
+                                    <Download className="w-4 h-4" /> Guardar Copia JSON
+                                </button>
+                                <div className="relative">
+                                    <input type="file" accept=".json" onChange={handleLocalImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
+                                    <button className="w-full p-3 bg-white border border-gray-200 text-gray-600 rounded-xl font-bold uppercase tracking-widest text-[10px] active:scale-95 flex items-center justify-center gap-2">
+                                        <Upload className="w-4 h-4" /> Restaurar Copia JSON
+                                    </button>
+                                </div>
+                            </div>
+                        </div>
+
+                        {/* Google Sheets Sync (Manual Trigger) */}
+                        <div className="bg-white p-6 rounded-[2rem] border-2 border-emerald-50 shadow-sm relative overflow-hidden">
+                            <div className="flex items-center gap-3 mb-4">
+                                <div className="bg-emerald-100 p-2 rounded-xl text-emerald-600">
+                                    <FileSpreadsheet className="w-5 h-5" />
+                                </div>
+                                <h3 className="font-black text-gray-900 text-sm uppercase">Google Sheets</h3>
+                            </div>
+
+                            <div className="space-y-4">
+                                <div>
+                                    <label className="text-[9px] font-black text-gray-400 uppercase tracking-widest ml-1">Script URL</label>
+                                    <div className="flex gap-2">
+                                        <input
+                                            type="text"
+                                            value={sheetsUrl}
+                                            onChange={(e) => setSheetsUrl(e.target.value)}
+                                            className="flex-1 p-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold text-gray-600 outline-none focus:border-emerald-500"
+                                            placeholder="https://script.google.com/..."
+                                        />
+                                        <button onClick={handleSaveSheetsUrl} className="px-3 bg-gray-900 text-white rounded-xl font-bold text-[10px] active:scale-95">
+                                            Ok
+                                        </button>
+                                    </div>
+                                </div>
+
+                                <div className="grid grid-cols-3 gap-2">
+                                    <button disabled={!sheetsUrl || syncStatus === 'syncing'} onClick={() => triggerUpload('sales')} className="p-3 bg-emerald-50 text-emerald-700 rounded-xl font-bold text-[9px] uppercase border border-emerald-100 active:scale-95 flex flex-col items-center gap-1">
+                                        <Zap className="w-4 h-4" /> Ventas
+                                    </button>
+                                    <button disabled={!sheetsUrl || syncStatus === 'syncing'} onClick={() => triggerUpload('inventory')} className="p-3 bg-blue-50 text-blue-700 rounded-xl font-bold text-[9px] uppercase border border-blue-100 active:scale-95 flex flex-col items-center gap-1">
+                                        <Package className="w-4 h-4" /> Stock
+                                    </button>
+                                    <button disabled={!sheetsUrl || syncStatus === 'syncing'} onClick={() => triggerUpload('customers')} className="p-3 bg-indigo-50 text-indigo-700 rounded-xl font-bold text-[9px] uppercase border border-indigo-100 active:scale-95 flex flex-col items-center gap-1">
+                                        <Users className="w-4 h-4" /> Clientes
+                                    </button>
+                                </div>
+                            </div>
+                        </div>
+                    </div>
+
+                    <div className="pt-4 border-t border-gray-100">
+                        <button onClick={onReset} className="w-full py-4 bg-red-50 text-red-500 rounded-2xl font-black uppercase tracking-widest text-xs border border-red-100 active:scale-95 hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
+                            <AlertTriangle className="w-4 h-4" /> Resetear Aplicaci├│n (Borrar Todo)
+                        </button>
+                    </div>
                 </div>
             </div>
+            <style>{`
+        @keyframes scale-up { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
+        .animate-scale-up { animation: scale-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
+      `}</style>
         </div>
-
-      </div>
-    </div>
-  );
+    );
 };
 
 export default Settings;
diff --git a/components/Sidebar.tsx b/components/Sidebar.tsx
index 38e1530..731b13f 100644
--- a/components/Sidebar.tsx
+++ b/components/Sidebar.tsx
@@ -1,6 +1,6 @@
 
 import React from 'react';
-import { ShoppingCart, Package, Users, Banknote, Settings } from '../constants';
+import { ShoppingCart, Package, Users, Banknote, Settings, Landmark, PieChart } from '../constants';
 import { View } from '../types';
 
 interface SidebarProps {
@@ -10,9 +10,11 @@ interface SidebarProps {
 
 const Sidebar: React.FC<SidebarProps> = ({ activeView, onViewChange }) => {
   const menuItems = [
+    { id: 'dashboard', icon: PieChart, label: 'Resumen' },
     { id: 'reports', icon: Banknote, label: 'Ventas (Caja)' },
     { id: 'inventory', icon: Package, label: 'Inventario' },
     { id: 'customers', icon: Users, label: 'Clientes' },
+    { id: 'treasury', icon: Landmark, label: 'Balance' },
   ];
 
   return (
@@ -28,11 +30,10 @@ const Sidebar: React.FC<SidebarProps> = ({ activeView, onViewChange }) => {
           <button
             key={item.id}
             onClick={() => onViewChange(item.id as View)}
-            className={`w-full flex items-center gap-4 px-6 py-4 text-sm font-medium transition-colors ${
-              activeView === item.id
-                ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-700'
-                : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
-            }`}
+            className={`w-full flex items-center gap-4 px-6 py-4 text-sm font-medium transition-colors ${activeView === item.id
+              ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-700'
+              : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
+              }`}
           >
             <item.icon className="w-5 h-5" />
             {item.label}
@@ -40,14 +41,7 @@ const Sidebar: React.FC<SidebarProps> = ({ activeView, onViewChange }) => {
         ))}
       </nav>
       <div className="p-6 border-t border-gray-100">
-        <button 
-           onClick={() => onViewChange('settings')}
-           className={`w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium transition-colors ${activeView === 'settings' ? 'bg-gray-100 text-gray-900' : 'text-gray-500 hover:bg-gray-50'}`}
-        >
-           <Settings className="w-5 h-5" />
-           Ajustes
-        </button>
-        <p className="text-[10px] text-gray-300 mt-4 text-center">v1.3.0 &copy; 2024 Pointy POS</p>
+        <p className="text-[10px] text-gray-300 text-center">v1.5.0 &copy; 2024 Pointy POS</p>
       </div>
     </aside>
   );
diff --git a/constants.tsx b/constants.tsx
index 800702f..e3404d4 100644
--- a/constants.tsx
+++ b/constants.tsx
@@ -1,16 +1,16 @@
 
 import React from 'react';
-import { Product, Customer, Sale } from './types';
-import { 
-  LayoutDashboard, 
-  ShoppingCart, 
-  Package, 
-  BarChart3, 
-  Settings, 
-  Search, 
-  Plus, 
-  Trash2, 
-  Edit, 
+import { Product, Customer, Sale, ExchangeRateRecord, TreasuryTransaction } from './types';
+import {
+  LayoutDashboard,
+  ShoppingCart,
+  Package,
+  BarChart3,
+  Settings,
+  Search,
+  Plus,
+  Trash2,
+  Edit,
   Minus,
   CheckCircle2,
   AlertTriangle,
@@ -48,96 +48,77 @@ import {
   Lock,
   Unlock,
   MousePointer2,
-  // Added icons for Deployment guide
   Terminal,
   Play,
   Banknote,
-  // Added icons for Customers
   ChevronDown,
   ChevronUp,
-  // Added icons for missing exports
+  ChevronRight,
+  ChevronLeft,
   ArrowRight,
   Calendar,
   ArrowLeft,
   Building,
   Clock,
-  Share // New icon for iOS instructions
+  Share,
+  Loader2,
+  RotateCcw,
+  Save,
+  Briefcase,
+  Truck,
+  Landmark,
+  PieChart,
+  FileText,
+  ArrowUp,
+  ArrowDown,
+  Calculator,
+  Divide,
+  Hash,
+  Tag,
+  Scale,
+  // Nuevos Iconos
+  Box,
+  Layers,
+  Ruler
 } from 'lucide-react';
 
 // Initial products for the demo with costPrice added
-export const INITIAL_PRODUCTS: Product[] = [
-  { id: '1', name: 'Caf├® Espresso', category: 'Bebidas', price: 2.50, costPrice: 0.80, stock: 50, image: 'https://picsum.photos/seed/coffee/200' },
-  { id: '2', name: 'Croissant', category: 'Panader├¡a', price: 1.80, costPrice: 0.60, stock: 20, image: 'https://picsum.photos/seed/bread/200' },
-  { id: '3', name: 'S├índwich Jam├│n y Queso', category: 'Comida', price: 4.50, costPrice: 2.10, stock: 15, image: 'https://picsum.photos/seed/sandwich/200' },
-  { id: '4', name: 'T├® Matcha', category: 'Bebidas', price: 3.20, costPrice: 1.10, stock: 30, image: 'https://picsum.photos/seed/tea/200' },
-  { id: '5', name: 'Muffin de Ar├índanos', category: 'Panader├¡a', price: 2.20, costPrice: 0.90, stock: 25, image: 'https://picsum.photos/seed/muffin/200' },
-];
+export const INITIAL_PRODUCTS: Product[] = [];
 
 // Datos iniciales de clientes para que no aparezca vac├¡o
-export const INITIAL_CUSTOMERS: Customer[] = [
-  { 
-    id: 'c1', 
-    name: 'Maria Rodriguez', 
-    phone: '0414-1234567', 
-    balance: 15.00, 
-    createdAt: Date.now() - 86400000 
-  },
-  { 
-    id: 'c2', 
-    name: 'Inversiones Los Andes', 
-    phone: '0412-7654321', 
-    balance: 0, 
-    createdAt: Date.now() - 172800000 
-  },
-  { 
-    id: 'c3', 
-    name: 'Carlos Perez', 
-    phone: '0424-5555555', 
-    balance: 4.50, 
-    createdAt: Date.now() - 43200000 
-  }
-];
+export const INITIAL_CUSTOMERS: Customer[] = [];
 
 // Datos iniciales de ventas para tener reportes de ejemplo
-export const INITIAL_SALES: Sale[] = [
-  {
-    id: 's1',
-    timestamp: Date.now() - 3600000, // Hace 1 hora
-    items: [
-      { id: '1', name: 'Caf├® Espresso', category: 'Bebidas', price: 2.50, costPrice: 0.80, stock: 50, quantity: 2 },
-      { id: '2', name: 'Croissant', category: 'Panader├¡a', price: 1.80, costPrice: 0.60, stock: 20, quantity: 1 }
-    ],
-    total: 6.80,
-    exchangeRate: 40,
-    paymentMethod: 'Cash'
-  },
-  {
-    id: 's2',
-    timestamp: Date.now() - 7200000, // Hace 2 horas
-    items: [
-      { id: '3', name: 'S├índwich Jam├│n y Queso', category: 'Comida', price: 4.50, costPrice: 2.10, stock: 15, quantity: 1 }
-    ],
-    total: 4.50,
-    exchangeRate: 40,
-    paymentMethod: 'Credit',
-    customerId: 'c3' // Carlos Perez
-  }
-];
+export const INITIAL_SALES: Sale[] = [];
+
+// Helper para crear fechas pasadas
+const daysAgo = (days: number) => {
+  const d = new Date();
+  d.setDate(d.getDate() - days);
+  return d.getTime();
+};
+
+// Historial de Tasas Inicial
+export const INITIAL_RATE_HISTORY: ExchangeRateRecord[] = [];
+
+// Movimientos de Tesorer├¡a Iniciales
+export const INITIAL_TREASURY: TreasuryTransaction[] = [];
+
 
 export const CATEGORIES = ['Todas', 'Bebidas', 'Panader├¡a', 'Comida', 'Snacks'];
 
-export { 
-  LayoutDashboard, 
-  ShoppingCart, 
-  Package, 
-  BarChart3, 
-  Settings, 
-  Search, 
-  Plus, 
-  Trash2, 
-  Edit, 
+export {
+  LayoutDashboard,
+  ShoppingCart,
+  Package,
+  BarChart3,
+  Settings,
+  Search,
+  Plus,
+  Trash2,
+  Edit,
   Minus,
-  CheckCircle2, 
+  CheckCircle2,
   AlertTriangle,
   AlertCircle,
   Sparkles,
@@ -178,10 +159,30 @@ export {
   Banknote,
   ChevronDown,
   ChevronUp,
+  ChevronRight,
+  ChevronLeft,
   ArrowRight,
   Calendar,
   ArrowLeft,
   Building,
   Clock,
-  Share
+  Share,
+  Loader2,
+  RotateCcw,
+  Save,
+  Briefcase,
+  Truck,
+  Landmark,
+  PieChart,
+  FileText,
+  ArrowUp,
+  ArrowDown,
+  Calculator,
+  Divide,
+  Hash,
+  Tag,
+  Scale,
+  Box,
+  Layers,
+  Ruler
 };
diff --git a/index.css b/index.css
index ed96615..0954aab 100644
--- a/index.css
+++ b/index.css
@@ -4,3 +4,23 @@
 @tailwind utilities;
 
 /* A├▒adir cualquier estilo personalizado aqu├¡ */
+
+/* Safe areas para dispositivos m├│viles con notch */
+.safe-area-bottom {
+    padding-bottom: env(safe-area-inset-bottom);
+}
+
+.safe-area-top {
+    padding-top: env(safe-area-inset-top);
+}
+
+/* Asegurar que el contenido no quede detr├ís de la barra de navegaci├│n */
+@supports (padding: max(0px)) {
+    .safe-area-bottom {
+        padding-bottom: max(8px, env(safe-area-inset-bottom));
+    }
+
+    .safe-area-top {
+        padding-top: max(0px, env(safe-area-inset-top));
+    }
+}
\ No newline at end of file
diff --git a/index.html b/index.html
index ccc1fd2..a4568d2 100644
--- a/index.html
+++ b/index.html
@@ -1,51 +1,77 @@
-
 <!DOCTYPE html>
 <html lang="es">
+
 <head>
-    <meta charset="UTF-8">
-    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
-    <meta name="theme-color" content="#4f46e5">
-    <meta name="apple-mobile-web-app-capable" content="yes">
-    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
-    <meta name="mobile-web-app-capable" content="yes">
-    <link rel="manifest" href="manifest.json">
-    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9344/9344163.png">
-    <title>Pointy POS</title>
-    <script src="https://cdn.tailwindcss.com"></script>
-    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
-    <style>
-        body { 
-          font-family: 'Inter', sans-serif; 
-          -webkit-tap-highlight-color: transparent;
-          user-select: none;
-          overscroll-behavior-y: contain;
-        }
-        input, textarea { user-select: text; }
-        .no-scrollbar::-webkit-scrollbar { display: none; }
-        /* Evitar zoom en inputs en iOS */
-        @media screen and (max-width: 768px) {
-          input, select, textarea { font-size: 16px !important; }
-        }
-    </style>
-<script type="importmap">
+  <meta charset="UTF-8">
+  <meta name="viewport"
+    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
+  <meta name="theme-color" content="#4f46e5">
+  <meta name="apple-mobile-web-app-capable" content="yes">
+  <meta name="apple-mobile-web-app-status-bar-style" content="default">
+  <meta name="apple-mobile-web-app-title" content="Pointy">
+  <meta name="mobile-web-app-capable" content="yes">
+  <meta name="apple-touch-fullscreen" content="yes">
+  <link rel="manifest" href="/manifest.json">
+  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9344/9344163.png">
+  <title>Pointy POS</title>
+  <script src="https://cdn.tailwindcss.com"></script>
+  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
+    rel="stylesheet">
+  <style>
+    body {
+      font-family: 'Inter', sans-serif;
+      -webkit-tap-highlight-color: transparent;
+      user-select: none;
+      overscroll-behavior-y: contain;
+    }
+
+    input,
+    textarea {
+      user-select: text;
+    }
+
+    .no-scrollbar::-webkit-scrollbar {
+      display: none;
+    }
+
+    /* Evitar zoom en inputs en iOS */
+    @media screen and (max-width: 768px) {
+
+      input,
+      select,
+      textarea {
+        font-size: 16px !important;
+      }
+    }
+  </style>
+  <script type="importmap">
 {
   "imports": {
-    "@google/genai": "https://esm.sh/@google/genai@^1.40.0",
     "recharts": "https://esm.sh/recharts@^3.7.0",
     "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
     "react/": "https://esm.sh/react@^19.2.4/",
     "react": "https://esm.sh/react@^19.2.4",
-    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
-    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
-    "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
-    "firebase/": "https://esm.sh/firebase@^12.9.0/"
+    "react-dom/": "https://esm.sh/react-dom@^19.2.4/"
   }
 }
 </script>
-<link rel="stylesheet" href="/index.css">
+  <link rel="stylesheet" href="/index.css">
 </head>
+
 <body class="bg-gray-50">
-    <div id="root"></div>
-<script type="module" src="/index.tsx"></script>
+  <div id="root"></div>
+  <script>
+    if ('serviceWorker' in navigator) {
+      window.addEventListener('load', () => {
+        navigator.serviceWorker.register('/sw.js').then(reg => {
+          console.log('SW registered!', reg);
+        }).catch(err => {
+          console.log('SW registration failed: ', err);
+        });
+      });
+    }
+  </script>
+  <script type="module" src="/index.tsx"></script>
 </body>
-</html>
+
+</html>
\ No newline at end of file
diff --git a/manifest.json b/manifest.json
index f7fe107..43495aa 100644
--- a/manifest.json
+++ b/manifest.json
@@ -1,9 +1,10 @@
-
 {
   "name": "Pointy POS Cloud",
   "short_name": "Pointy",
   "start_url": ".",
   "display": "standalone",
+  "orientation": "any",
+  "scope": "/",
   "background_color": "#ffffff",
   "theme_color": "#4f46e5",
   "icons": [
@@ -14,4 +15,4 @@
       "purpose": "any maskable"
     }
   ]
-}
+}
\ No newline at end of file
diff --git a/package.json b/package.json
index a13b6a3..732aaa3 100644
--- a/package.json
+++ b/package.json
@@ -4,7 +4,7 @@
   "version": "0.0.0",
   "type": "module",
   "scripts": {
-    "dev": "vite",
+    "dev": "vite --host",
     "build": "vite build",
     "preview": "vite preview"
   },
diff --git a/services/supabaseService.ts b/services/supabaseService.ts
index 0abed90..fa7378b 100644
--- a/services/supabaseService.ts
+++ b/services/supabaseService.ts
@@ -2,235 +2,183 @@
 import { createClient } from '@supabase/supabase-js';
 
 // --- CONFIGURACI├ôN ---
-// Crea un archivo .env si no existe y agrega:
-// VITE_SUPABASE_URL=tu_url_de_supabase
-// VITE_SUPABASE_ANON_KEY=tu_anon_key
 const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || '';
 const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || '';
 
-// Inicializar cliente solo si hay keys, para evitar errores
+if (!supabaseUrl || !supabaseAnonKey) {
+    console.error("ÔØî ERROR: No se detectaron las credenciales de Supabase en .env.local");
+}
+
 export const supabase = (supabaseUrl && supabaseAnonKey)
     ? createClient(supabaseUrl, supabaseAnonKey)
     : null;
 
 export const isCloudEnabled = !!supabase;
 
-// --- ADAPTADOR DE MEMORIA (CACHE) ---
-// Para mantener compatibilidad con la estructura de objeto anidado de Firebase y optimizar lecturas
-const memoryCache: Record<string, any> = {};
-
-// Helper para convertir array a objeto mapa por ID
+// Helper: Convertir Array a Objeto Map (para compatibilidad con la app refinada)
 const arrayToMap = (data: any[]) => {
-    if (!data) return {};
+    if (!data || !Array.isArray(data)) return {};
     return data.reduce((acc: any, item: any) => {
-        acc[item.id] = item;
+        if (item && item.id) acc[item.id] = item;
         return acc;
     }, {});
 };
 
-// --- SISTEMA DE RESPALDO LOCAL (FALLBACK) ---
-// Se usa solo si no hay configuraci├│n de nube o como cach├® inicial
-
-const getLocalData = (path: string) => {
-    const parts = path.split('/');
-    const root = parts[0];
-    const storageKey = `pointy_data_${root}`;
-    const raw = localStorage.getItem(storageKey);
-    const data = raw ? JSON.parse(raw) : null;
+// --- API COMPATIBLE CON FIREBASE SERVICE (REFINADA) ---
 
-    if (parts.length > 1 && data) {
-        return data[parts[1]] || null;
+export const syncPath = (path: string, callback: (data: any) => void) => {
+    if (!supabase) {
+        console.warn("ÔÜá´©Å Supabase no configurado. Operando en modo Local ├║nicamente.");
+        return () => { };
     }
-    return data;
-};
 
-const setLocalData = (path: string, value: any) => {
     const parts = path.split('/');
-    const root = parts[0];
-    const storageKey = `pointy_data_${root}`;
-
-    let currentRootData = JSON.parse(localStorage.getItem(storageKey) || '{}');
-
-    if (parts.length === 1) {
-        if (value === null) {
-            localStorage.removeItem(storageKey);
-        } else {
-            localStorage.setItem(storageKey, JSON.stringify(value));
-        }
-    } else if (parts.length === 2) {
-        if (value === null) {
-            delete currentRootData[parts[1]];
-        } else {
-            currentRootData[parts[1]] = value;
-        }
-        localStorage.setItem(storageKey, JSON.stringify(currentRootData));
-    }
-
-    window.dispatchEvent(new Event('pointy_storage_update'));
-};
-
-
-// --- API H├ìBRIDA (SUPABASE + LOCAL) ---
-
-export const syncPath = (path: string, callback: (data: any) => void) => {
-    // Siempre cargar datos locales primero para respuesta inmediata (Optimistic UI)
-    const localData = getLocalData(path);
-    if (localData) callback(localData);
-
-    if (isCloudEnabled && supabase) {
-        // --- MODO NUBE (SUPABASE) ---
-
-        // Identificar si es colecci├│n completa o documento
-        const parts = path.split('/');
-        const table = parts[0];
-        const docId = parts[1];
-
-        // CASO 1: Documento ├║nico (ej: settings/exchangeRate)
-        if (docId) {
-            const fetchData = async () => {
-                const { data } = await supabase.from(table).select('*').eq('id', docId).single();
-                if (data) {
-                    let val = data;
-                    if (table === 'settings' && 'value' in data) {
-                        val = data.value;
-                    }
-                    // Guardar en local para cach├® futura
-                    setLocalData(path, val);
-                    callback(val);
+    const table = parts[0];
+    const docId = parts[1]; // Si existe, es un documento espec├¡fico
+
+    // CASO 1: Documento ├║nico (ej: settings/exchangeRate)
+    if (docId) {
+        // Carga inicial
+        supabase.from(table).select('*').eq('id', docId).single()
+            .then(({ data }) => {
+                if (data && 'value' in data && table === 'settings') {
+                    // Caso especial para settings: devolver el valor directo
+                    callback(data.value);
+                } else if (data) {
+                    callback(data);
+                } else {
+                    callback(null);
                 }
-            };
-            fetchData();
-
-            const channel = supabase.channel(`${table}:${docId}`)
-                .on('postgres_changes', { event: '*', schema: 'public', table: table, filter: `id=eq.${docId}` }, (payload: any) => {
-                    let val = payload.new;
-                    if (payload.new && 'value' in payload.new && table === 'settings') {
-                        val = payload.new.value;
+            });
+
+        // Suscripci├│n a cambios
+        const channel = supabase.channel(`doc:${table}:${docId}`)
+            .on('postgres_changes',
+                { event: '*', schema: 'public', table: table, filter: `id=eq.${docId}` },
+                (payload) => {
+                    if (payload.eventType === 'DELETE') {
+                        callback(null);
+                    } else {
+                        let val = payload.new;
+                        if (val && 'value' in val && table === 'settings') {
+                            val = val.value;
+                        }
+                        callback(val);
                     }
-                    // Actualizar local y callback
-                    if (val) setLocalData(path, val);
-                    callback(val || null);
-                })
-                .subscribe();
+                }
+            )
+            .subscribe();
 
-            return () => supabase.removeChannel(channel);
-        }
+        return () => { supabase.removeChannel(channel); };
+    }
 
-        // CASO 2: Colecci├│n completa (ej: products)
-        else {
-            const fetchData = async () => {
-                // Obtener todo
-                const { data } = await supabase.from(table).select('*');
+    // CASO 2: Colecci├│n completa (ej: products, customers, sales)
+    else {
+        // Carga inicial
+        supabase.from(table).select('*')
+            .then(({ data }) => {
                 const map = arrayToMap(data || []);
-
-                // Actualizar cach├® local completa
-                setLocalData(path, map);
                 callback(map);
-            };
-            fetchData();
+            });
+
+        // Suscripci├│n de toda la tabla
+        // NOTA: Esto no es lo m├ís eficiente para bases de datos enormes, pero para un POS pyme est├í perfecto.
+        const channel = supabase.channel(`col:${table}`)
+            .on('postgres_changes',
+                { event: '*', schema: 'public', table: table },
+                () => {
+                    // Al haber cualquier cambio, recargamos todo el mapa para simplificar la sincronizaci├│n
+                    // (Supabase realtime env├¡a solo el registro cambiado, pero la app espera el objeto completo del estado actual)
+                    supabase.from(table).select('*')
+                        .then(({ data }) => {
+                            callback(arrayToMap(data || []));
+                        });
+                }
+            )
+            .subscribe();
 
-            const channel = supabase.channel(table)
-                .on('postgres_changes', { event: '*', schema: 'public', table: table }, (payload) => {
-                    // Recargar todo es ineficiente pero seguro. O mejor, actualizar diferencialmente.
-                    // Para simplicidad en syncPath h├¡brido, volveremos a leer local, aplicar cambio y notificar.
-                    // Pero syncPath no tiene estado interno f├ícil m├ís que memoryCache.
+        return () => { supabase.removeChannel(channel); };
+    }
+};
 
-                    // Estrategia simple: Al haber cambio, volver a hacer fetch de la tabla (no es ├│ptimo pero es robusto)
-                    // Estrategia optimizada: Aplicar cambio al mapa local.
+export const saveData = async (path: string, data: any) => {
+    if (!supabase) {
+        console.warn('ÔÜá´©Å Supabase no configurado - no se puede guardar:', path);
+        return;
+    }
 
-                    let currentMap = getLocalData(path) || {};
+    const parts = path.split('/');
+    const table = parts[0];
+    const docId = parts[1];
 
-                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
-                        currentMap[payload.new.id] = payload.new;
-                    } else if (payload.eventType === 'DELETE') {
-                        delete currentMap[payload.old.id];
-                    }
+    if (!docId) {
+        console.error("ÔØî saveData requiere un ID en el path:", path);
+        return;
+    }
 
-                    setLocalData(path, currentMap);
-                    callback(currentMap);
-                })
-                .subscribe();
+    console.log(`­ƒôØ Guardando en ${table}/${docId}:`, data);
 
-            return () => supabase.removeChannel(channel);
-        }
+    let payload: any = data;
 
+    // Adaptaci├│n para Settings (guardar valor en columna 'value')
+    if (table === 'settings') {
+        // Si data es primitivo (numero, string) o un objeto sin ID, lo envolvemos
+        if (typeof data !== 'object' || data === null || !data.id) {
+            payload = { id: docId, value: data };
+        } else {
+            payload = { id: docId, value: data };
+        }
     } else {
-        // --- MODO LOCAL (OFFLINE / SIN CONFIG) ---
-        // Ya cargamos data inicial arriba.
-        // Solo necesitamos escuchar eventos de otras pesta├▒as.
-        const handler = () => callback(getLocalData(path));
-        window.addEventListener('pointy_storage_update', handler);
-        return () => window.removeEventListener('pointy_storage_update', handler);
+        // Para otras tablas, asegurarnos que el ID est├® en el objeto
+        if (typeof data === 'object') {
+            payload = { ...data, id: docId };
+        }
     }
-};
 
-export const saveData = async (path: string, data: any) => {
-    // 1. Guardar localmente siempre (Optimistic UI + Fallback)
-    setLocalData(path, data);
-
-    // 2. Si hay nube, sincronizar
-    if (isCloudEnabled && supabase) {
-        const parts = path.split('/');
-        const table = parts[0];
-        const docId = parts[1];
-
-        if (docId) {
-            let payload = data;
-            // Adaptador para settings (valor primitivo -> objeto)
-            if (table === 'settings' && typeof data !== 'object') {
-                payload = { id: docId, value: data };
-            } else if (typeof data === 'object' && !data.id) {
-                payload = { ...data, id: docId };
-            }
-
-            const { error } = await supabase.from(table).upsert(payload);
-            if (error) console.error("Error saving to Supabase:", error);
-        }
+    console.log(`­ƒÆ¥ Payload final para ${table}:`, payload);
+
+    const { data: result, error } = await supabase.from(table).upsert(payload);
+
+    if (error) {
+        console.error(`ÔØî Error guardando en ${path}:`, error);
+        return false;
+    } else {
+        console.log(`Ô£à Guardado exitoso en ${path}:`, result);
+        return true;
     }
 };
 
 export const deleteData = async (path: string) => {
-    // 1. Borrar localmente
-    // Logica de borrado local custom (null update)
-    const parts = path.split('/');
-    if (parts.length === 2) {
-        setLocalData(path, null);
-    } else {
-        localStorage.removeItem(`pointy_data_${path}`);
-        window.dispatchEvent(new Event('pointy_storage_update'));
-    }
+    if (!supabase) return;
 
-    // 2. Borrar en nube
-    if (isCloudEnabled && supabase) {
-        const table = parts[0];
-        const docId = parts[1];
+    const parts = path.split('/');
+    const table = parts[0];
+    const docId = parts[1];
 
-        if (docId) {
-            await supabase.from(table).delete().eq('id', docId);
-        }
+    if (docId) {
+        // Borrar el documento espec├¡fico
+        await supabase.from(table).delete().eq('id', docId);
+    } else {
+        console.error("deleteData requiere un ID espec├¡fico");
     }
 };
 
 export const updateBatch = async (updates: Record<string, any>) => {
-    // 1. Aplicar todo localmente
-    Object.entries(updates).forEach(([path, value]) => {
+    if (!supabase) return;
+
+    // Supabase no tiene un "multi-path batch" at├│mico simple desde cliente JS como Firebase.
+    // Procesaremos las actualizaciones en paralelo.
+    const promises = Object.entries(updates).map(async ([path, value]) => {
         if (value === null) {
-            const parts = path.split('/');
-            if (parts.length === 2) setLocalData(path, null);
+            return deleteData(path);
         } else {
-            setLocalData(path, value);
+            return saveData(path, value);
         }
     });
 
-    // 2. Aplicar en nube
-    if (isCloudEnabled && supabase) {
-        const promises = Object.entries(updates).map(async ([path, value]) => {
-            if (value === null) {
-                await deleteData(path); // Redundante pero seguro, llama a deleteData que tiene check
-            } else {
-                await saveData(path, value);
-            }
-        });
-        await Promise.all(promises);
-    }
+    await Promise.all(promises);
 };
+
+// Funciones dummy par mantener compatibilidad si algo las llama
+export const saveFirebaseConfig = () => { };
+export const clearFirebaseConfig = () => { };
diff --git a/supabase_schema.sql b/supabase_schema.sql
index fc66e1d..7b29b0a 100644
--- a/supabase_schema.sql
+++ b/supabase_schema.sql
@@ -1,31 +1,34 @@
 
--- EJECUTA ESTO EN EL SQL EDITOR DE SUPABASE PARA PREPARAR TU BASE DE DATOS
+-- EJECUTA ESTO PARA RESETEAR Y CONFIGURAR CORRECTAMENTE LAS TABLAS
+-- Este script es seguro para ejecutar varias veces.
 
--- 1. Tabla de Productos
-CREATE TABLE public.products (
+-- 1. Tablas con sus columnas actualizadas
+CREATE TABLE IF NOT EXISTS public.products (
     id TEXT PRIMARY KEY,
     name TEXT,
     category TEXT,
     price NUMERIC,
     "costPrice" NUMERIC,
-    stock INTEGER,
+    stock NUMERIC,
     image TEXT,
     description TEXT,
+    "sellingMode" TEXT DEFAULT 'simple',
+    "measurementUnit" TEXT DEFAULT 'kg',
+    "unitsPerPackage" NUMERIC DEFAULT 0,
+    "pricePerUnit" NUMERIC DEFAULT 0,
     created_at TIMESTAMPTZ DEFAULT NOW()
 );
 
--- 2. Tabla de Clientes
-CREATE TABLE public.customers (
+CREATE TABLE IF NOT EXISTS public.customers (
     id TEXT PRIMARY KEY,
     name TEXT,
+    email TEXT,
     phone TEXT,
     balance NUMERIC DEFAULT 0,
     "createdAt" BIGINT
 );
 
--- 3. Tabla de Ventas
--- Usamos JSONB para los items para mantener flexibilidad sin crear tablas relacionales complejas por ahora
-CREATE TABLE public.sales (
+CREATE TABLE IF NOT EXISTS public.sales (
     id TEXT PRIMARY KEY,
     timestamp BIGINT,
     total NUMERIC,
@@ -35,16 +38,42 @@ CREATE TABLE public.sales (
     items JSONB
 );
 
--- 4. Tabla de Configuraci├│n (Settings)
--- Guardar├í valores sueltos como exchangeRate, rateHistory, etc.
-CREATE TABLE public.settings (
+CREATE TABLE IF NOT EXISTS public.settings (
     id TEXT PRIMARY KEY,
-    value JSONB -- Puede guardar n├║meros, strings u objetos complejos (historial)
+    value JSONB
 );
 
--- POL├ìTICAS DE SEGURIDAD (RLS)
--- Permitir todo acceso p├║blico (ANON) para esta demo. 
--- En producci├│n deber├¡as restringir esto.
+CREATE TABLE IF NOT EXISTS public.treasury (
+    id TEXT PRIMARY KEY,
+    timestamp BIGINT,
+    type TEXT,
+    category TEXT,
+    amount NUMERIC,
+    "amountBs" NUMERIC,
+    "exchangeRate" NUMERIC,
+    description TEXT,
+    method TEXT
+);
+
+CREATE TABLE IF NOT EXISTS public.rate_history (
+    id TEXT PRIMARY KEY,
+    rate NUMERIC,
+    timestamp BIGINT
+);
+
+-- 2. Limpiar y recrear pol├¡ticas (Esto evita el error de "ya existe")
+DO $$ 
+BEGIN
+    -- Borrar pol├¡ticas si existen
+    DROP POLICY IF EXISTS "Public Access Products" ON public.products;
+    DROP POLICY IF EXISTS "Public Access Customers" ON public.customers;
+    DROP POLICY IF EXISTS "Public Access Sales" ON public.sales;
+    DROP POLICY IF EXISTS "Public Access Settings" ON public.settings;
+    DROP POLICY IF EXISTS "Public Access Treasury" ON public.treasury;
+    DROP POLICY IF EXISTS "Public Access Rate History" ON public.rate_history;
+END $$;
+
+-- Crear pol├¡ticas nuevas
 ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
 CREATE POLICY "Public Access Products" ON public.products FOR ALL USING (true);
 
@@ -57,8 +86,25 @@ CREATE POLICY "Public Access Sales" ON public.sales FOR ALL USING (true);
 ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;
 CREATE POLICY "Public Access Settings" ON public.settings FOR ALL USING (true);
 
--- Habilitar Realtime
-ALTER PUBLICATION supabase_realtime ADD TABLE public.products;
-ALTER PUBLICATION supabase_realtime ADD TABLE public.customers;
-ALTER PUBLICATION supabase_realtime ADD TABLE public.sales;
-ALTER PUBLICATION supabase_realtime ADD TABLE public.settings;
+ALTER TABLE public.treasury ENABLE ROW LEVEL SECURITY;
+CREATE POLICY "Public Access Treasury" ON public.treasury FOR ALL USING (true);
+
+ALTER TABLE public.rate_history ENABLE ROW LEVEL SECURITY;
+CREATE POLICY "Public Access Rate History" ON public.rate_history FOR ALL USING (true);
+
+-- 3. Habilitar Realtime
+-- Intentamos habilitar realtime para todas las tablas
+DO $$ 
+BEGIN
+    IF NOT EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'supabase_realtime') THEN
+        CREATE PUBLICATION supabase_realtime;
+    END IF;
+END $$;
+
+ALTER PUBLICATION supabase_realtime SET TABLE 
+    public.products,
+    public.customers,
+    public.sales,
+    public.settings,
+    public.treasury,
+    public.rate_history;
diff --git a/types.ts b/types.ts
index 4ce65d0..0cd9654 100644
--- a/types.ts
+++ b/types.ts
@@ -3,11 +3,17 @@ export interface Product {
   id: string;
   name: string;
   category: string;
-  price: number;      // Selling price in USD
+  price: number;      // Selling price in USD (Precio Principal / Paquete Completo)
   costPrice: number;  // Purchase price (cost) in USD
   stock: number;
   image?: string;
   description?: string;
+
+  // Nuevos campos para Variantes/Modos de Venta
+  sellingMode?: 'simple' | 'weight' | 'package';
+  measurementUnit?: 'kg' | 'g' | 'l' | 'ml' | 'm'; // Para venta por peso/volumen
+  unitsPerPackage?: number; // Cuantas unidades trae el paquete (si es modo paquete)
+  pricePerUnit?: number;    // Precio de venta de la unidad suelta (si es modo paquete)
 }
 
 export interface CartItem extends Product {
@@ -46,4 +52,16 @@ export interface Shift {
   status: 'open' | 'closed';
 }
 
-export type View = 'pos' | 'inventory' | 'reports' | 'customers' | 'settings';
+export interface TreasuryTransaction {
+  id: string;
+  timestamp: number;
+  type: 'income' | 'expense';
+  category: string;
+  amount: number; // Amount in USD (base reference)
+  amountBs: number; // Amount in Bs at time of transaction
+  exchangeRate: number;
+  description: string;
+  method: 'Cash' | 'Transfer' | 'PagoMovil' | 'Zelle/Intl' | 'Card' | 'PointOfSale' | 'Credit';
+}
+
+export type View = 'pos' | 'inventory' | 'reports' | 'customers' | 'settings' | 'treasury' | 'dashboard';
